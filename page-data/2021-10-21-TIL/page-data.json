{"componentChunkName":"component---src-templates-blog-template-js","path":"/2021-10-21-TIL/","result":{"data":{"cur":{"id":"1befd21c-f5c8-5e9c-a334-2a528e06b035","html":"<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 56.666666666666664%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAALABQDASIAAhEBAxEB/8QAFgABAQEAAAAAAAAAAAAAAAAAAAID/8QAFQEBAQAAAAAAAAAAAAAAAAAAAAX/2gAMAwEAAhADEAAAAdJomgf/xAAWEAADAAAAAAAAAAAAAAAAAAAAASD/2gAIAQEAAQUCFP8A/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPwE//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPwE//8QAFhAAAwAAAAAAAAAAAAAAAAAAACAx/9oACAEBAAY/AiL/AP/EABgQAAIDAAAAAAAAAAAAAAAAAAABESAx/9oACAEBAAE/IRm9hX//2gAMAwEAAgADAAAAEEw//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPxA//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPxA//8QAGRAAAgMBAAAAAAAAAAAAAAAAAREAIEFR/9oACAEBAAE/EI1YY7tf/9k='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"github-blog.png\"\n        title=\"\"\n        src=\"/static/7c4bbfe7d1a9d6bc02891c94bfe039dc/80e3c/til.jpg\"\n        srcset=\"/static/7c4bbfe7d1a9d6bc02891c94bfe039dc/4ec73/til.jpg 180w,\n/static/7c4bbfe7d1a9d6bc02891c94bfe039dc/158ba/til.jpg 360w,\n/static/7c4bbfe7d1a9d6bc02891c94bfe039dc/80e3c/til.jpg 720w,\n/static/7c4bbfe7d1a9d6bc02891c94bfe039dc/47311/til.jpg 1080w,\n/static/7c4bbfe7d1a9d6bc02891c94bfe039dc/ac614/til.jpg 1272w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<br>\n<h2 id=\"️-today-i-learned\" style=\"position:relative;\"><a href=\"#%EF%B8%8F-today-i-learned\" aria-label=\"️ today i learned permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>✍️ <strong>T</strong>oday <strong>I</strong> <strong>L</strong>earned</h2>\n<br>\n<h3 id=\"1-token\" style=\"position:relative;\"><a href=\"#1-token\" aria-label=\"1 token permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. Token</h3>\n<hr>\n<ul>\n<li>\n<p>앞선 세션 인증 방식은 서버(혹은 DB)에 유저 정보를 담는 인증 방식이었다.</p>\n<p>매 요청마다 데이터베이스를 살펴보는 것이 불편하고, 이 부담은 서버의 과부화를 초래할 수 있다.<br>\r\n부하를 줄이기 위해 인증 방식을 토큰 인증 방식을 사용해보자.</p>\n</li>\n<li>\n<p>토큰 인증 방식의 인증 절차는 아래 그림과 같다</p>\n<p><img src=\"https://user-images.githubusercontent.com/83164003/143394269-b9b52b26-722d-44ec-8189-2c9ac64b92b0.jpg\" alt=\"token\"></p>\n</li>\n</ul>\n<br>\r\n<br>\n<h4 id=\"1-1-사전-준비\" style=\"position:relative;\"><a href=\"#1-1-%EC%82%AC%EC%A0%84-%EC%A4%80%EB%B9%84\" aria-label=\"1 1 사전 준비 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1-1. 사전 준비</h4>\n<hr>\n<ul>\n<li>\n<p><strong>Part1-Session</strong>의 <a href=\"https://blog.jh8459.com/2021-10-20-TIL-2/#1-1-%EC%82%AC%EC%A0%84-%EC%A4%80%EB%B9%84\" target=\"_blank\">준비단계</a>와 동일한 진행은 생략하였다.</p>\n</li>\n<li>\n<p><strong>ACCESS_SECRET</strong>와 <strong>REFRESH_SECRET</strong> 변수명으로 2가지의 JWT(Json Web Token)을 사용한다.</p>\n<p>accessToken은 보호된 정보들(유저의 이메일, 연락처, 사진 등)에 접근할 수 있는 권한부여에 사용된다. 클라이언트가 처음 인증을 받게 될 때(로그인 시), accessToken,refreshToken 두 가지를 다 받지만, 실제로 권한을 얻는 데 사용하는 토큰은 accessToken이다.</p>\n<p>accessToken만 존재한다면, 해커나 악의적인 유저에게 탈취당할 경우 보안이 우려되므로 accessToken의 유효기간을 짧게 주고(탈취되더라도 피해 최소화), refreshToken으로 새로운 accessToken을 발급 받는 구조이다.</p>\n</li>\n<li>\n<p>다른 사용자가 볼 수 없도록 <code class=\"language-text\">.env</code> 파일에 accessToken과 refreshToken 키값을 넣어준다(임의의 값을 넣어주어도 된다).</p>\n</li>\n</ul>\n<br>\r\n<br>\n<h4 id=\"1-2-서버-구현\" style=\"position:relative;\"><a href=\"#1-2-%EC%84%9C%EB%B2%84-%EA%B5%AC%ED%98%84\" aria-label=\"1 2 서버 구현 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1-2. 서버 구현</h4>\n<hr>\n<ul>\n<li>\n<p>우선 서버는 HTTPS 프로토콜 방식으로 구현된다. CORS 옵션을 보자면,</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">app<span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span>\r\n  <span class=\"token function\">cors</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\r\n    <span class=\"token literal-property property\">origin</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'https://localhost:3000'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\r\n    <span class=\"token literal-property property\">credentials</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\r\n    <span class=\"token literal-property property\">methods</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'GET'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'POST'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'OPTIONS'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\r\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\r\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>3000포트의 클라이언트를 출처로 받으며, 인증서를 사용하는 정보를 알 수 있다.</p>\n<p>또한 서버는 4000번 포트로 인증서가 존재할 때만 서버가 구동되는 코드 또한 <code class=\"language-text\">server-token/index.js</code> 파일을 확인하면 볼 수 있다.</p>\n</li>\n</ul>\n<br>\r\n<br>\n<h5 id=\"post-login\" style=\"position:relative;\"><a href=\"#post-login\" aria-label=\"post login permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[POST] /login</h5>\n<hr>\n<ul>\n<li>\n<p><code class=\"language-text\">controllers/login.js</code> 파일을 확인 후 다음과 같은 기능을 완성시켜야 한다.</p>\n<ul>\n<li>\n<p><em>request로부터 받은 userId, password와 일치하는 유저가 DB에 존재하는지 확인합니다.</em></p>\n</li>\n<li>\n<p><em>일치하는 유저가 없을 경우: 로그인 요청을 거절합니다.</em></p>\n</li>\n<li>\n<p><em>일치하는 유저가 있을 경우:</em></p>\n<ul>\n<li>\n<p><em>필요한 데이터를 담은 두 종류의 JWT(access, refresh)를 생성합니다.</em></p>\n</li>\n<li>\n<p><em>생성한 JWT를 적절한 방법으로 반환합니다.</em></p>\n<ul>\n<li>\n<p><em>access token은 클라이언트에서 react state로 다루고 있습니다.</em></p>\n</li>\n<li>\n<p><em>refresh token은 클라이언트의 쿠키에서 다루고 있습니다.</em></p>\n</li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> userId<span class=\"token punctuation\">,</span> password <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> req<span class=\"token punctuation\">.</span>body<span class=\"token punctuation\">;</span> <span class=\"token comment\">// req.body에 담긴 정보를 가져온다.</span>\r\n\r\nUsers<span class=\"token punctuation\">.</span><span class=\"token function\">findOne</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\r\n  <span class=\"token literal-property property\">where</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token literal-property property\">userId</span><span class=\"token operator\">:</span> userId<span class=\"token punctuation\">,</span>\r\n    <span class=\"token literal-property property\">password</span><span class=\"token operator\">:</span> password<span class=\"token punctuation\">,</span>\r\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\r\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">data</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n  <span class=\"token comment\">// request로부터 받은 userId, password와 일치하는 유저가 DB에 존재하는지 확인</span>\r\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>data<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token comment\">// 1. 일치하는 유저가 없을 경우</span>\r\n    res<span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">message</span><span class=\"token operator\">:</span> <span class=\"token string\">'not authorized'</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 로그인 요청을 거절('not authorized' 메세지가 응답에 포함)</span>\r\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token comment\">// 2. 일치하는 유저가 있을 경우</span>\r\n    <span class=\"token comment\">// 일치하는 유저가 있을 경우: 필요한 데이터(id, userId, email, createdAt, updatedAt)를 payload에 담아 JWT token을 생성한다.</span>\r\n    <span class=\"token keyword\">const</span> payload <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\r\n      <span class=\"token comment\">// payload에 필요한 데이터를 담는다.</span>\r\n      <span class=\"token literal-property property\">id</span><span class=\"token operator\">:</span> data<span class=\"token punctuation\">.</span>dataValues<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">,</span>\r\n      <span class=\"token literal-property property\">userId</span><span class=\"token operator\">:</span> data<span class=\"token punctuation\">.</span>dataValues<span class=\"token punctuation\">.</span>userId<span class=\"token punctuation\">,</span>\r\n      <span class=\"token literal-property property\">email</span><span class=\"token operator\">:</span> data<span class=\"token punctuation\">.</span>dataValues<span class=\"token punctuation\">.</span>email<span class=\"token punctuation\">,</span>\r\n      <span class=\"token literal-property property\">createdAt</span><span class=\"token operator\">:</span> data<span class=\"token punctuation\">.</span>dataValues<span class=\"token punctuation\">.</span>createdAt<span class=\"token punctuation\">,</span>\r\n      <span class=\"token literal-property property\">updatedAt</span><span class=\"token operator\">:</span> data<span class=\"token punctuation\">.</span>dataValues<span class=\"token punctuation\">.</span>updatedAt<span class=\"token punctuation\">,</span>\r\n      <span class=\"token literal-property property\">iat</span><span class=\"token operator\">:</span> <span class=\"token number\">151623391</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// 토큰발급된시간.. format을 모르겠어서 더미값을 넣었다.</span>\r\n      <span class=\"token literal-property property\">exp</span><span class=\"token operator\">:</span> Math<span class=\"token punctuation\">.</span><span class=\"token function\">floor</span><span class=\"token punctuation\">(</span>Date<span class=\"token punctuation\">.</span><span class=\"token function\">now</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> <span class=\"token number\">1000</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token number\">60</span> <span class=\"token operator\">*</span> <span class=\"token number\">60</span><span class=\"token punctuation\">,</span>\r\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\r\n\r\n    <span class=\"token keyword\">const</span> accessToken <span class=\"token operator\">=</span> jwt<span class=\"token punctuation\">.</span><span class=\"token function\">sign</span><span class=\"token punctuation\">(</span>payload<span class=\"token punctuation\">,</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">ACCESS_SECRET</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// access token, refresh token 생성</span>\r\n    <span class=\"token keyword\">const</span> refreshToken <span class=\"token operator\">=</span> jwt<span class=\"token punctuation\">.</span><span class=\"token function\">sign</span><span class=\"token punctuation\">(</span>payload<span class=\"token punctuation\">,</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">REFRESH_SECRET</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n\r\n    res<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Set-Cookie'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span>\r\n      <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">refreshToken=</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>refreshToken<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">; Domain=localhost; Path=/; Secure; HttpOnly; SameSite=None;</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">,</span>\r\n    <span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// refresh token을 쿠키에 담아 보낼 때 sameSite, secure, httpOnly 옵션을 알맞게 설정</span>\r\n    res<span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">data</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">accessToken</span><span class=\"token operator\">:</span> accessToken <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token literal-property property\">message</span><span class=\"token operator\">:</span> <span class=\"token string\">'ok'</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 클라이언트에서 accessToken은 스테이트로 다뤄지기때문에 응답결과에 담아 반환한다.</span>\r\n  <span class=\"token punctuation\">}</span>\r\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n</li>\n</ul>\n<br>\r\n<br>\n<h5 id=\"get-accesstokenrequest\" style=\"position:relative;\"><a href=\"#get-accesstokenrequest\" aria-label=\"get accesstokenrequest permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[GET] /accesstokenrequest</h5>\n<hr>\n<ul>\n<li>\n<p><code class=\"language-text\">controllers/accesstokenrequest.js</code>에서는 authorization header에 담긴 토큰이 서버에서 생성한 JWT인지 확인후, 서버에서 생성한 유효한 토큰일 경우와 유효하지 않은 토큰일 경우 각각 다른 응답을 반환 해야한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> authorization <span class=\"token operator\">=</span> req<span class=\"token punctuation\">.</span>headers<span class=\"token punctuation\">[</span><span class=\"token string\">'authorization'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// authorization header에 담긴 토큰을 변수에 저장</span>\r\n\r\n<span class=\"token comment\">/* authorization header에 담긴 access token이 유효한지 검사 */</span>\r\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>authorization<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n  <span class=\"token comment\">// 유효하지 않는 경우: 클라이언트에 아래와 같은 JSON 객체를 반환한다.</span>\r\n  res<span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">data</span><span class=\"token operator\">:</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> <span class=\"token literal-property property\">message</span><span class=\"token operator\">:</span> <span class=\"token string\">'invalid access token'</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n<span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\r\n  <span class=\"token keyword\">const</span> token <span class=\"token operator\">=</span> authorization<span class=\"token punctuation\">.</span><span class=\"token function\">split</span><span class=\"token punctuation\">(</span><span class=\"token string\">' '</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// Bearer token 형식이므로 .split(' ')[1];</span>\r\n\r\n  jwt<span class=\"token punctuation\">.</span><span class=\"token function\">verify</span><span class=\"token punctuation\">(</span>token<span class=\"token punctuation\">,</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">ACCESS_SECRET</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">err<span class=\"token punctuation\">,</span> data</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n    Users<span class=\"token punctuation\">.</span><span class=\"token function\">findOne</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\r\n      <span class=\"token comment\">// JWT를 해독하여 얻은 payload안의 값으로 DB에 유저를 조회</span>\r\n      <span class=\"token literal-property property\">where</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\r\n        <span class=\"token comment\">// payload엔 password가 안담겨있으므로, 다른 속성으로 유저를 조회한다.</span>\r\n        <span class=\"token literal-property property\">id</span><span class=\"token operator\">:</span> data<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">,</span>\r\n        <span class=\"token literal-property property\">userId</span><span class=\"token operator\">:</span> data<span class=\"token punctuation\">.</span>userId<span class=\"token punctuation\">,</span>\r\n        <span class=\"token literal-property property\">email</span><span class=\"token operator\">:</span> data<span class=\"token punctuation\">.</span>email<span class=\"token punctuation\">,</span>\r\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\r\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">data</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n      <span class=\"token keyword\">delete</span> data<span class=\"token punctuation\">.</span>dataValues<span class=\"token punctuation\">.</span>password<span class=\"token punctuation\">;</span> <span class=\"token comment\">// 모든 데이터가 담겨있다보니, 민감한 정보인 pasword는 삭제한다.</span>\r\n      res<span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">data</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">userInfo</span><span class=\"token operator\">:</span> data<span class=\"token punctuation\">.</span>dataValues <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token literal-property property\">message</span><span class=\"token operator\">:</span> <span class=\"token string\">'ok'</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 클라이언트에서 userInfo(password는 제외)를 보여줘야 하므로 응답 결과에 담아 반환한다.</span>\r\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n<span class=\"token punctuation\">}</span></code></pre></div>\n</li>\n</ul>\n<br>\r\n<br>\n<h5 id=\"get-refreshtokenrequest\" style=\"position:relative;\"><a href=\"#get-refreshtokenrequest\" aria-label=\"get refreshtokenrequest permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>[GET] /refreshtokenrequest</h5>\n<hr>\n<ul>\n<li>\n<p><code class=\"language-text\">controllers/refreshtokenrequest</code>에서는 요청에 담긴 refresh token이 유효하다면 새로운 access token을 발급해 줌과 동시에 유저가 요청한 정보를 반환해줘야하며 요청에 담긴 refresh token이 유효하지 않거나, 조작된 토큰일 경우 각각 다른 응답을 반환해야 한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> refreshToken <span class=\"token operator\">=</span> req<span class=\"token punctuation\">.</span>cookies<span class=\"token punctuation\">.</span>refreshToken<span class=\"token punctuation\">;</span> <span class=\"token comment\">// cookie에 담겨있는 refreshToken을 변수에 담는다.</span>\r\n\r\n<span class=\"token comment\">/* cookie에 담긴 refreshToken이 유효한지 검사. */</span>\r\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>refreshToken<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n  <span class=\"token comment\">// 토큰이 담겨있지 않다면 아래와 같은 JSON 객체를 반환한다.</span>\r\n  res<span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">data</span><span class=\"token operator\">:</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> <span class=\"token literal-property property\">message</span><span class=\"token operator\">:</span> <span class=\"token string\">'refresh token not provided'</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n<span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\r\n  jwt<span class=\"token punctuation\">.</span><span class=\"token function\">verify</span><span class=\"token punctuation\">(</span>refreshToken<span class=\"token punctuation\">,</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">REFRESH_SECRET</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">err<span class=\"token punctuation\">,</span> data</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token comment\">// refreshToken을이 서버가 가진 REFRESH_SECRET 으로 생성된 것인지 확인</span>\r\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n      <span class=\"token comment\">// 해독한 토큰이 유효하지 않거나, 해독이 불가한 토큰이라면 아래와 같은 JSON 객체를 반환</span>\r\n      res<span class=\"token punctuation\">.</span><span class=\"token function\">status</span><span class=\"token punctuation\">(</span><span class=\"token number\">200</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">data</span><span class=\"token operator\">:</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> <span class=\"token literal-property property\">message</span><span class=\"token operator\">:</span> <span class=\"token string\">'invalid refresh token, please log in again'</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n    <span class=\"token punctuation\">}</span>\r\n\r\n    Users<span class=\"token punctuation\">.</span><span class=\"token function\">findOne</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\r\n      <span class=\"token comment\">// JWT를 해독하여 얻은 payload안의 값으로 DB에 유저를 조회</span>\r\n      <span class=\"token literal-property property\">where</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\r\n        <span class=\"token literal-property property\">id</span><span class=\"token operator\">:</span> data<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">,</span> <span class=\"token comment\">// data에는 JWT를 해독한 결과값이 담겨 있다</span>\r\n        <span class=\"token literal-property property\">userId</span><span class=\"token operator\">:</span> data<span class=\"token punctuation\">.</span>userId<span class=\"token punctuation\">,</span>\r\n        <span class=\"token literal-property property\">email</span><span class=\"token operator\">:</span> data<span class=\"token punctuation\">.</span>email<span class=\"token punctuation\">,</span>\r\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\r\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">data</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n      <span class=\"token comment\">// playload안의 값과 DB에 일치된 유저정보가 반환이 된다.</span>\r\n      <span class=\"token keyword\">delete</span> data<span class=\"token punctuation\">.</span>dataValues<span class=\"token punctuation\">.</span>password<span class=\"token punctuation\">;</span> <span class=\"token comment\">// 민감정보 삭제</span>\r\n\r\n      <span class=\"token keyword\">const</span> payload <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\r\n        <span class=\"token comment\">// 새로 발급할 토큰 유효기간 재설정</span>\r\n        <span class=\"token operator\">...</span>data<span class=\"token punctuation\">.</span>dataValues<span class=\"token punctuation\">,</span> <span class=\"token comment\">// 기존 데이터 활용</span>\r\n        <span class=\"token literal-property property\">iat</span><span class=\"token operator\">:</span> <span class=\"token number\">151623391</span><span class=\"token punctuation\">,</span>\r\n        <span class=\"token literal-property property\">exp</span><span class=\"token operator\">:</span> Math<span class=\"token punctuation\">.</span><span class=\"token function\">floor</span><span class=\"token punctuation\">(</span>Date<span class=\"token punctuation\">.</span><span class=\"token function\">now</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> <span class=\"token number\">1000</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token number\">60</span> <span class=\"token operator\">*</span> <span class=\"token number\">60</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// refreshToekn은 상대적으로 accessToken보다 유효기간을 길게 설정해준다.</span>\r\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\r\n\r\n      <span class=\"token keyword\">const</span> accessToken <span class=\"token operator\">=</span> jwt<span class=\"token punctuation\">.</span><span class=\"token function\">sign</span><span class=\"token punctuation\">(</span>payload<span class=\"token punctuation\">,</span> process<span class=\"token punctuation\">.</span>env<span class=\"token punctuation\">.</span><span class=\"token constant\">ACCESS_SECRET</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// refreshToekn을 사용하여 accessToken보다을 새로 발급</span>\r\n\r\n      res<span class=\"token punctuation\">.</span><span class=\"token function\">json</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">data</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">accessToken</span><span class=\"token operator\">:</span> accessToken<span class=\"token punctuation\">,</span> <span class=\"token literal-property property\">userInfo</span><span class=\"token operator\">:</span> data<span class=\"token punctuation\">.</span>dataValues <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token literal-property property\">message</span><span class=\"token operator\">:</span> <span class=\"token string\">'ok'</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n<span class=\"token punctuation\">}</span></code></pre></div>\n</li>\n</ul>\n<br>\r\n<br>\n<h4 id=\"1-3-클라이언트-구현\" style=\"position:relative;\"><a href=\"#1-3-%ED%81%B4%EB%9D%BC%EC%9D%B4%EC%96%B8%ED%8A%B8-%EA%B5%AC%ED%98%84\" aria-label=\"1 3 클라이언트 구현 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1-3. 클라이언트 구현</h4>\n<hr>\n<br>\r\n<br>\n<h5 id=\"app\" style=\"position:relative;\"><a href=\"#app\" aria-label=\"app permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>App</h5>\n<hr>\n<ul>\n<li>\n<p><code class=\"language-text\">app.js</code> 파일의 빈 핸들러 함수들을 완성시키고, 각 컴포넌트에 적절한 <code class=\"language-text\">props</code>를 전달해준다.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">/* 생략 */</span>\r\n\r\n<span class=\"token function\">loginHandler</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">data</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>  <span class=\"token comment\">// 로그인핸들러</span>\r\n\t<span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">setState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">isLogin</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  <span class=\"token comment\">// 로그인 버튼 클릭시 isLogin 상태 값을 true로 바꾸어준다.</span>\r\n\t<span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">issueAccessToken</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>accessToken<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  <span class=\"token comment\">// 응답 결과로 받은 accessToken을 issueAccessToken 함수로 전달한다.</span>\r\n<span class=\"token punctuation\">}</span>\r\n\r\n<span class=\"token function\">issueAccessToken</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">token</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n\t<span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">setState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">accessToken</span><span class=\"token operator\">:</span> token <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  <span class=\"token comment\">// 전달받은 acessToken 상태 값으로 바꿔준다.</span>\r\n<span class=\"token punctuation\">}</span>\r\n\r\n<span class=\"token function\">render</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n\t<span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> isLogin <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state<span class=\"token punctuation\">;</span>\r\n\t<span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\r\n\t\t<span class=\"token operator\">&lt;</span>div className<span class=\"token operator\">=</span><span class=\"token string\">'App'</span><span class=\"token operator\">></span>\r\n\t\t\t<span class=\"token punctuation\">{</span><span class=\"token comment\">/*\r\n\t\t\tTODO: isLogin 상태에 따라 Mypage 혹은 Login 컴포넌트를 렌더해야합니다.\r\n\t\t\t알맞은 컴포넌트를 렌더링하는것은 물론, 올바른 props전달하도록 작성하세요.\r\n\t\t\t*/</span>\r\n\t\t\tisLogin <span class=\"token operator\">?</span> <span class=\"token punctuation\">(</span>  <span class=\"token comment\">// isLogin 3항연산자를 사용하여 상태에 따라 다른 컴포넌트를 렌더한다.</span>\r\n\t\t\t\t<span class=\"token operator\">&lt;</span>Mypage accessToken<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state<span class=\"token punctuation\">.</span>accessToken<span class=\"token punctuation\">}</span> issueAccessToken<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>issueAccessToken<span class=\"token punctuation\">}</span> <span class=\"token operator\">/</span><span class=\"token operator\">></span>\r\n\t\t\t<span class=\"token punctuation\">)</span> <span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span>\r\n\t\t\t\t<span class=\"token operator\">&lt;</span>Login loginHandler<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>loginHandler<span class=\"token punctuation\">}</span> <span class=\"token operator\">/</span><span class=\"token operator\">></span>\r\n\t\t\t<span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span>\r\n\t\t<span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>div<span class=\"token operator\">></span>\r\n\t<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n<span class=\"token punctuation\">}</span></code></pre></div>\n</li>\n</ul>\n<br>\r\n<br>\n<h5 id=\"login\" style=\"position:relative;\"><a href=\"#login\" aria-label=\"login permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Login</h5>\n<hr>\n<ul>\n<li>\n<p><code class=\"language-text\">components/Login.js</code> Login 컴포넌트의 <code class=\"language-text\">loginRequestHandler</code>메소드를 사용하여 상위 컴포넌트인 App 컴포넌트의 state를 적절히 변경해 준다. (상태 끌어올림)</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token function\">loginRequestHandler</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n\t<span class=\"token comment\">/*\r\n\tTODO: Login 컴포넌트가 가지고 있는 state를 이용해 로그인을 구현합니다.\r\n\t로그인을 담당하는 api endpoint에 요청을 보내고, 받은 데이터로 상위 컴포넌트 App의 state를 변경하세요.\r\n\t초기 App:\r\n\tstate = { isLogin: false, accessToken: \"\" }\r\n\t로그인 요청 후 App:\r\n\tstate = { isLogin: true, accessToken: 서버에_요청하여_받은_access_token }\r\n\t*/</span>\r\n\r\n\t<span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> userId<span class=\"token punctuation\">,</span> password <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state<span class=\"token punctuation\">;</span>\r\n\r\n  <span class=\"token comment\">/* 서버 Login endpoint에 요청을 보낸다. 요청 옵션에 인증서 사용옵션과 json객체 형태로 데이터를 받는 옵션값 설정 */</span>\r\n\taxios<span class=\"token punctuation\">.</span><span class=\"token function\">post</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"https://localhost:4000/login\"</span><span class=\"token punctuation\">,</span><span class=\"token punctuation\">{</span> userId<span class=\"token punctuation\">,</span> password <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">headers</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> <span class=\"token string-property property\">\"Content-Type\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"application/json\"</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token literal-property property\">withCredentials</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\r\n\t<span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">data</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n\t\t<span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>props<span class=\"token punctuation\">.</span><span class=\"token function\">loginHandler</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  <span class=\"token comment\">// props로 전달받은 데이터로 App.js의 상태값을 변경해준다.</span>\r\n\t<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n<span class=\"token punctuation\">}</span></code></pre></div>\n</li>\n</ul>\n<br>\r\n<br>\n<h5 id=\"mypage\" style=\"position:relative;\"><a href=\"#mypage\" aria-label=\"mypage permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Mypage</h5>\n<hr>\n<ul>\n<li>\n<p><code class=\"language-text\">components/Mypage.js</code> Mypage 컴포넌트의 빈 부분을 완성시켜준다.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token function\">accessTokenRequest</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n  <span class=\"token comment\">/*\r\n  TODO: 상위 컴포넌트인 App에서 받은 props를 이용해 accessTokenRequest 메소드를 구현합니다.\r\n  access token을 처리할 수 있는 api endpoint에 요청을 보내고, 받은 데이터로 Mypage 컴포넌트의 state (userId, email, createdAt)를 변경하세요\r\n  초기 Mypage:\r\n  state = { userId: \"\", email: \"\", createdAt: \"\" }\r\n  accessTokenRequest 후 Mypage:\r\n  state = { userId: \"특정유저id\", email: \"특정유저email\", created: \"특정유저createdAt\" }\r\n  ** 주의사항 **\r\n  App 컴포넌트에서 내려받은 accessToken props를 authorization header에 담아 요청을 보내야 합니다.\r\n  */</span>\r\n\r\n  axios<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"https://localhost:4000/accesstokenrequest\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token literal-property property\">headers</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\r\n\t\t  <span class=\"token literal-property property\">Authorization</span><span class=\"token operator\">:</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Bearer </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>props<span class=\"token punctuation\">.</span>accessToken<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">,</span>  <span class=\"token comment\">// App 컴포넌트에서 내려받은 accessToken props를 authorization header에 담아 요청전달</span>\r\n      <span class=\"token string-property property\">\"Content-Type\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"application/json\"</span><span class=\"token punctuation\">,</span>  <span class=\"token comment\">// json 객체 형태로 데이터를 취급 선언</span>\r\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\r\n    <span class=\"token literal-property property\">withCredentials</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span>\r\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\r\n  <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">data</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>message <span class=\"token operator\">!==</span> <span class=\"token string\">\"ok\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>  <span class=\"token comment\">// 서버의 응답 메시지 확인</span>\r\n      <span class=\"token keyword\">const</span> message <span class=\"token operator\">=</span><span class=\"token string\">\"refresh token이 만료되어 불러올 수 없습니다. 다시 로그인 해주시기 바랍니다.\"</span><span class=\"token punctuation\">;</span>\r\n      <span class=\"token keyword\">return</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">setState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">email</span><span class=\"token operator\">:</span> message<span class=\"token punctuation\">,</span> <span class=\"token literal-property property\">createdAt</span><span class=\"token operator\">:</span> message <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n    <span class=\"token punctuation\">}</span>\r\n    <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> createdAt<span class=\"token punctuation\">,</span> userId<span class=\"token punctuation\">,</span> email <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> data<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>userInfo<span class=\"token punctuation\">;</span>\r\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">setState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> userId<span class=\"token punctuation\">,</span> createdAt<span class=\"token punctuation\">,</span> email <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n<span class=\"token punctuation\">}</span>\r\n\r\n<span class=\"token function\">refreshTokenRequest</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n  <span class=\"token comment\">/*\r\n  TODO: 쿠키에 담겨져 있는 refreshToken을 이용하여 refreshTokenRequest 메소드를 구현합니다.\r\n  refresh token을 처리할 수 있는 api endpoint에 요청을 보내고, 받은 데이터로 2가지를 구현합니다.\r\n  1. Mypage 컴포넌트의 state(userId, email, createdAt)를 변경\r\n  2. 상위 컴포넌트 App의 state에 accessToken을 받은 새 토큰으로 교환\r\n  */</span>\r\n\r\n  axios<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"https://localhost:4000/refreshtokenrequest\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\r\n      <span class=\"token literal-property property\">withCredentials</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\r\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\r\n    <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">data</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>message <span class=\"token operator\">!==</span> <span class=\"token string\">\"ok\"</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n        <span class=\"token keyword\">const</span> message <span class=\"token operator\">=</span>\r\n          <span class=\"token string\">\"refresh token이 만료되어 불러올 수 없습니다. 다시 로그인 해주시기 바랍니다.\"</span><span class=\"token punctuation\">;</span>\r\n        <span class=\"token keyword\">return</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">setState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">email</span><span class=\"token operator\">:</span> message<span class=\"token punctuation\">,</span> <span class=\"token literal-property property\">createdAt</span><span class=\"token operator\">:</span> message <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n      <span class=\"token punctuation\">}</span>\r\n      <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> createdAt<span class=\"token punctuation\">,</span> userId<span class=\"token punctuation\">,</span> email <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> data<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>userInfo<span class=\"token punctuation\">;</span>\r\n      <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">setState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> userId<span class=\"token punctuation\">,</span> createdAt<span class=\"token punctuation\">,</span> email <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n      <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>props<span class=\"token punctuation\">.</span><span class=\"token function\">issueAccessToken</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>data<span class=\"token punctuation\">.</span>accessToken<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n<span class=\"token punctuation\">}</span></code></pre></div>\n</li>\n</ul>\n<br>\r\n<br>\n<h4 id=\"1-4-결과-확인\" style=\"position:relative;\"><a href=\"#1-4-%EA%B2%B0%EA%B3%BC-%ED%99%95%EC%9D%B8\" aria-label=\"1 4 결과 확인 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1-4. 결과 확인</h4>\n<hr>\n<p>refreshToken은 쿠키에 담겨(암호화 되어서) 주고받는 걸 알 수 있으며, 클라이언트에서 서버로 보낸 accessToken이 유효한 토큰일 경우 <code class=\"language-text\">jwt.veryfy</code>로 해독된 결과값이 응답 결과로 반환되어 클라이언트에서 해독된 결과 값을 볼 수 있게 되는 구조이다.</p>\n<ul>\n<li>\n<p>쿠키를 확인해보면 refreshToken값(비밀키값을 사용하여 암호화된..) 을 확인 할 수 있다.</p>\n<p><img src=\"https://user-images.githubusercontent.com/83164003/143411901-74544579-8273-4561-bed9-034e28d1f6e1.png\" alt=\"스크린샷, 2021-11-25 17-59-34\"></p>\n</li>\n<li>\n<p>chrome의 네트워크 결과값을 보면 클라이언트에서 보낸 accessToken 요청이 유효한 경우 서버에서 반환된 해독된 payload 값을 확인 할 수 있다.</p>\n<p><img src=\"https://user-images.githubusercontent.com/83164003/143412108-7b5de28c-c071-4c49-8c28-74bfcbcd6cd2.png\" alt=\"스크린샷, 2021-11-25 18-00-20\"></p>\n</li>\n</ul>\n<br>\r\n<br>\n<h2 id=\"-understanding\" style=\"position:relative;\"><a href=\"#-understanding\" aria-label=\" understanding permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>🤔 Understanding</h2>\n<ul>\n<li>\n<p>이제 HTTPS 로그인 로직 개념이 잡힌다.. <del>어렵다 어려워</del></p>\n</li>\n<li>\n<p>axios 아직 미숙하다.. 스프린트는 끝났지만 공부할게 더 많이 남았다… 내일 oauth 인증 / 보안 방식까지 열심히 해야지</p>\n</li>\n</ul>\n<br>\r\n<br>","excerpt":"✍️ Today I Learned 1. Token 앞선 세션 인증 방식은 서버(혹은 DB)에 유저 정보를 담는 인증 방식이었다. 매 요청마다 데이터베이스를 살펴보는 것이 불편하고, 이 부담은 서버의 과부화를 초래할 수 있다.\r\n부하를 줄이기 위해 인증 방식을 토큰 인증 방식을 사용해보자. 토큰 인증 방식의 인증 절차는 아래 그림과 같다 token 1-1. 사전 준비 Part1-Session의 준비단계와 동일한 진행은 생략하였다. ACCESS_SECRET와 REFRESH_SECRET 변수명으로 2가지의 JWT(Json Web Token)을 사용한다. accessToken은 보호된 정보들(유저의 이메일, 연락처, 사진 등)에 접근할 수 있는 권한부여에 사용된다. 클라이언트가 처음 인증을 받게 될 때(로그인 시), accessToken,refreshToken 두 가지를 다 받지만, 실제로 권한을 얻는 데 사용하는 토큰은 accessToken이다. accessToken만 존재한다면, 해커나…","timeToRead":6,"tableOfContents":"<ul>\n<li>\n<p><a href=\"#%EF%B8%8F-today-i-learned\">✍️ <strong>T</strong>oday <strong>I</strong> <strong>L</strong>earned</a></p>\n<ul>\n<li>\n<p><a href=\"#1-token\">1. Token</a></p>\n<ul>\n<li>\n<p><a href=\"#1-1-%EC%82%AC%EC%A0%84-%EC%A4%80%EB%B9%84\">1-1. 사전 준비</a></p>\n</li>\n<li>\n<p><a href=\"#1-2-%EC%84%9C%EB%B2%84-%EA%B5%AC%ED%98%84\">1-2. 서버 구현</a></p>\n<ul>\n<li><a href=\"#post-login\">[POST] /login</a></li>\n<li><a href=\"#get-accesstokenrequest\">[GET] /accesstokenrequest</a></li>\n<li><a href=\"#get-refreshtokenrequest\">[GET] /refreshtokenrequest</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#1-3-%ED%81%B4%EB%9D%BC%EC%9D%B4%EC%96%B8%ED%8A%B8-%EA%B5%AC%ED%98%84\">1-3. 클라이언트 구현</a></p>\n<ul>\n<li><a href=\"#app\">App</a></li>\n<li><a href=\"#login\">Login</a></li>\n<li><a href=\"#mypage\">Mypage</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#1-4-%EA%B2%B0%EA%B3%BC-%ED%99%95%EC%9D%B8\">1-4. 결과 확인</a></p>\n</li>\n</ul>\n</li>\n</ul>\n</li>\n<li>\n<p><a href=\"#-understanding\">🤔 Understanding</a></p>\n</li>\n</ul>","frontmatter":{"date":"2021.10.21","title":"Token","categories":"TIL","author":"JH8459","emoji":"📚"},"fields":{"slug":"/2021-10-21-TIL/"}},"next":{"id":"051a59e7-380d-557b-ace9-fd240fae9a55","frontmatter":{"date":"2021.10.20","title":"HTTPS, Hashing, Cookie","categories":"TIL","author":"JH8459","emoji":"📚"},"fields":{"slug":"/2021-10-20-TIL-1/"}},"prev":{"id":"3c90fd19-f0e2-57f8-85f8-af22a0bd1938","frontmatter":{"date":"2021.10.22","title":"OAuth","categories":"TIL","author":"JH8459","emoji":"📚"},"fields":{"slug":"/2021-10-22-TIL/"}},"site":{"siteMetadata":{"comments":{"giscus":{"repo":"JH8459/JH8459.github.io","repoId":"R_kgDOI03HgA","category":"Comments","categoryId":"DIC_kwDOI03HgM4CtuXL"}}}}},"pageContext":{"slug":"/2021-10-21-TIL/","nextSlug":"/2021-10-20-TIL-1/","prevSlug":"/2021-10-22-TIL/"}},"staticQueryHashes":["1073350324","2009502679","2938748437","962130685"],"slicesMap":{}}