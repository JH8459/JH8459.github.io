{"componentChunkName":"component---src-templates-blog-template-js","path":"/2024-04-21-TIL/","result":{"data":{"cur":{"id":"de533aa6-29bd-5e31-ad82-2c37d46b2aa5","html":"<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 56.666666666666664%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAALABQDASIAAhEBAxEB/8QAFwAAAwEAAAAAAAAAAAAAAAAAAAECA//EABUBAQEAAAAAAAAAAAAAAAAAAAAF/9oADAMBAAIQAxAAAAHSaSawD//EABYQAAMAAAAAAAAAAAAAAAAAAAABIP/aAAgBAQABBQIU/wD/xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/AT//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/AT//xAAWEAADAAAAAAAAAAAAAAAAAAAAIDH/2gAIAQEABj8CIv8A/8QAGBAAAgMAAAAAAAAAAAAAAAAAAAERIDH/2gAIAQEAAT8hGb2Ff//aAAwDAQACAAMAAAAQHD//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/ED//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/ED//xAAZEAACAwEAAAAAAAAAAAAAAAABEQAgQVH/2gAIAQEAAT8QjVhju1//2Q=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"github-blog.png\"\n        title=\"github-blog.png\"\n        src=\"/static/7c4bbfe7d1a9d6bc02891c94bfe039dc/80e3c/TIL.jpg\"\n        srcset=\"/static/7c4bbfe7d1a9d6bc02891c94bfe039dc/4ec73/TIL.jpg 180w,\n/static/7c4bbfe7d1a9d6bc02891c94bfe039dc/158ba/TIL.jpg 360w,\n/static/7c4bbfe7d1a9d6bc02891c94bfe039dc/80e3c/TIL.jpg 720w,\n/static/7c4bbfe7d1a9d6bc02891c94bfe039dc/47311/TIL.jpg 1080w,\n/static/7c4bbfe7d1a9d6bc02891c94bfe039dc/ac614/TIL.jpg 1272w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<br>\n<h2 id=\"️-today-i-learned\" style=\"position:relative;\"><a href=\"#%EF%B8%8F-today-i-learned\" aria-label=\"️ today i learned permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>✍️ <strong>T</strong>oday <strong>I</strong> <strong>L</strong>earned</h2>\n<hr>\n<p>다중 인스턴스로 구성된 환경에서 동시에 임계 자원에 접근하려는 상황(동시성)을 제어하기 위해 도입한 방법을 간략히 정리하고 공유하기 위해 글을 남긴다.</p>\n<br>\n<br>\n<h3 id=\"1-문제점\" style=\"position:relative;\"><a href=\"#1-%EB%AC%B8%EC%A0%9C%EC%A0%90\" aria-label=\"1 문제점 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. 문제점</h3>\n<hr>\n<p>현재 사내에서 사용중인 서비스 구성도는 아래 사진과 같다.</p>\n<br>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 470px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 57.22222222222223%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsTAAALEwEAmpwYAAAB/ElEQVQoz32Sy27TUBCG/VpseA0WvAMbkFjACrHoBoln6IYNCCEkFhRRFq1UoAsgkJCGJE1zt3OzfXx8rv6Q7ZAWVTDSked4/jPzz8wfHLfGJJlGSEMsFLmy/DFtNDaX7L37xLPTFoVRGGO20WKHo6j9WGgC/mNKawrv6FxMGU3D+p9S/8SXxIJc14yklKRpihBid+I4rmJHh/t8PX1T+ZvN+i9M+SbP1SVDbVx1yaTEOYf3fnfKIqV9OfvGr2F3V/gqxjlfvd0lNNZXFyOS6y0rVRVZhSGLeYh1Dq31NZwW6bZlQ2C0YbqOufP8kF60Bmfx2yFb6/Basff2hP2TBoVWOF8TqL8Fx90h918fIZVmk0gCISRhkvKq1WORSbRSFZOKYa4w1vChO6YxW4L3u3lZa7Fa8XMccdDsY4wiWiYEwliKcUh69wn6Y4NyRXYrDWMtOk1pP3hI89Fj/JUtO2spx5XLKdl8gFeWZZwRpFKBtoT3niJevKdMZbWptKWdI1+veXnjJge3buOLy4RlsXIk5/Mhn89+kOWKVZmwbEHmGZPxCCEF3luKYrsolddSWS4QSS0ho7c6LDzWaPIsI5zN8FazigXB2SCi3Z/R7E5odSd0hwuG84RRlHI+WdMZhLQHc9rn88ofzDZVrMR0LiJavSnfO6MqR6sf8Rutb0XGT6KBTAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"architecture.png\"\n        title=\"architecture.png\"\n        src=\"/static/5d663c6ef87387829a1ca53f405f22e9/f96db/architecture.png\"\n        srcset=\"/static/5d663c6ef87387829a1ca53f405f22e9/e9ff0/architecture.png 180w,\n/static/5d663c6ef87387829a1ca53f405f22e9/f21e7/architecture.png 360w,\n/static/5d663c6ef87387829a1ca53f405f22e9/f96db/architecture.png 470w\"\n        sizes=\"(max-width: 470px) 100vw, 470px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<br>\n<p>이 구성도 내부에서 <strong>API Server</strong>는 Docker compose 환경에서 <code class=\"language-text\">replicas</code> 옵션으로 구성하여 쓰레드 갯수 만큼 다중 인스턴스 환경으로 구성되고 있다.</p>\n<p>여러개의 인스턴스로 구성되어 있기 때문에 스케쥴링 작업 등 여러개의 인스턴스가 동시에 같은 자원을 요구하는 작업에서 반복적인 에러가 리포팅되고 있었다.</p>\n<br>\n<br>\n<h3 id=\"2-해결방안\" style=\"position:relative;\"><a href=\"#2-%ED%95%B4%EA%B2%B0%EB%B0%A9%EC%95%88\" aria-label=\"2 해결방안 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2. 해결방안</h3>\n<hr>\n<p>우선 키워드를 먼저 언급하자면 <strong>“동시성 제어(concurrency control)”</strong>였다.</p>\n<p>비슷한 레퍼런스를 찾고자하니 많은 솔루션들이 나왔다.</p>\n<p>기억나는 솔루션 중 참고 될 만한 자료들은 링크로 따로 남겨두겠다.</p>\n<br>\n<blockquote>\n<p><a href=\"https://medium.com/nodejs-server/node-schedule-pm2-8f7831ed231e\" target=\"_blank\">🔗 PM2 환경에서 중복되지 않는 스케쥴링 구현</a></p>\n<p><a href=\"https://sg-choi.tistory.com/602\" target=\"_blank\">🔗 스프링 환경에서 스케쥴러 락 (ShedLock)</a></p>\n</blockquote>\n<br>\n<p>위 두가지 방법들이 대다수가 사용하는 솔루션이었다.</p>\n<p>각각 내포하는 뜻은 다음과 같다.</p>\n<br>\n<ol>\n<li><code class=\"language-text\">replicas</code> 옵션으로 복제된 각각의 인스턴스의 컨테이너 번호를 알아내어 특정 번호의 인스턴스만 실행되게 한다.</li>\n<li>스케쥴링 작업이 실행되기 전 우선권을 얻은 뒤 우선권을 얻은 인스턴스만 스케쥴링 작업이 실행되게 한다.</li>\n</ol>\n<br>\n<p><code class=\"language-text\">replicas</code> 옵션은 유동적으로 변하기도하고 각각 내부 인스턴스의 상황은 그때 그때 변하기 때문에 고정 번호의 인스턴스만 실행되게하는건 리스크가 있다 판단하였다. 따라서, 두번째 방향으로 리팩토링을 진행하였다.</p>\n<p>여러개의 인스턴스가 공통으로 사용하는 자원을 활용하여 우선권을 선점여부를 판단하여 “Lock”을 걸어야하므로 <strong>Redis</strong>를 활용하였다.</p>\n<p>스프링 환경의 <code class=\"language-text\">ShedLock</code> 기능과 유사한 <strong>“분산락”</strong>을 구현해보았다.</p>\n<br>\n<br>\n<h3 id=\"3-변경점\" style=\"position:relative;\"><a href=\"#3-%EB%B3%80%EA%B2%BD%EC%A0%90\" aria-label=\"3 변경점 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3. 변경점</h3>\n<hr>\n<p>검색해보니 RedLock 알고리즘(권장) 등 이러한 분산 환경에서 쓰이는 여러 알고리즘들이 있다는걸 알게되었다.</p>\n<p>우선 현재 사용중인 스케줄링들은 정산이나 비용에 관련된 데이터 정합성에 아주 민감한 비즈니스 로직은 아니므로 간단한 알고리즘으로 구현해보았다.</p>\n<br>\n<ul>\n<li>\n<p><strong>redis.service.ts</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"ts\"><pre class=\"language-ts\"><code class=\"language-ts\"><span class=\"token decorator\"><span class=\"token at operator\">@</span><span class=\"token function\">Injectable</span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">RedisService</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">constructor</span><span class=\"token punctuation\">(</span><span class=\"token decorator\"><span class=\"token at operator\">@</span><span class=\"token function\">InjectRedis</span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">private</span> redis<span class=\"token operator\">:</span> Redis<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n\n  <span class=\"token comment\">// Lock 유지 시간 (5분)</span>\n  <span class=\"token keyword\">private</span> <span class=\"token keyword\">readonly</span> lockDuration <span class=\"token operator\">=</span> <span class=\"token number\">60</span> <span class=\"token operator\">*</span> <span class=\"token number\">5</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">async</span> <span class=\"token function\">setLock</span><span class=\"token punctuation\">(</span>key<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token builtin\">Promise</span><span class=\"token operator\">&lt;</span><span class=\"token builtin\">string</span><span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// Lock 획득</span>\n    <span class=\"token keyword\">const</span> lock<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>redis<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">,</span> <span class=\"token string\">'LOCK'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'EX'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>lockDuration<span class=\"token punctuation\">,</span> <span class=\"token string\">'NX'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">return</span> lock<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">async</span> <span class=\"token function\">unLock</span><span class=\"token punctuation\">(</span>key<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token builtin\">Promise</span><span class=\"token operator\">&lt;</span><span class=\"token keyword\">void</span><span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// Lock 해제</span>\n    <span class=\"token keyword\">await</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>redis<span class=\"token punctuation\">.</span><span class=\"token function\">del</span><span class=\"token punctuation\">(</span>key<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n</li>\n<li>\n<p><strong>scheduler.service.ts</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"ts\"><pre class=\"language-ts\"><code class=\"language-ts\"><span class=\"token decorator\"><span class=\"token at operator\">@</span><span class=\"token function\">Cron</span></span><span class=\"token punctuation\">(</span>CronExpression<span class=\"token punctuation\">.</span><span class=\"token constant\">MONDAY_TO_FRIDAY_AT_9PM</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">async</span> <span class=\"token function\">scheduler</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token builtin\">Promise</span><span class=\"token operator\">&lt;</span><span class=\"token keyword\">void</span><span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> lockKey <span class=\"token operator\">=</span> <span class=\"token string\">'LOCK_KEY'</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> lock <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>redisService<span class=\"token punctuation\">.</span><span class=\"token function\">setLock</span><span class=\"token punctuation\">(</span>lockKey<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>lock<span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// 스케쥴링 로직</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">finally</span> <span class=\"token punctuation\">{</span> \n    <span class=\"token keyword\">await</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>redisService<span class=\"token punctuation\">.</span><span class=\"token function\">unLock</span><span class=\"token punctuation\">(</span>lockKey<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n</li>\n</ul>\n<br>\n<br>\n<h2 id=\"-understanding\" style=\"position:relative;\"><a href=\"#-understanding\" aria-label=\" understanding permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>🤔 Understanding</h2>\n<hr>\n<p>코드 구현 난이도 자체는 높지 않았다.</p>\n<p>다만, “데이터의 정합성” 이라는 큰 개념아래에서 동시성을 제어하여야 한다는 걸 인지하지 못했다면 평생 해결하지 못할 이슈였다.</p>\n<p>분산 환경에서 고려해야할 것이 많다라는 점을 충분히 인지할 수 있었던 시간이었다.</p>\n<br>\n<br>\n<div class=\"table-of-contents\">\n<ul>\n<li>\n<p><a href=\"#%EF%B8%8F-today-i-learned\">✍️ <strong>T</strong>oday <strong>I</strong> <strong>L</strong>earned</a></p>\n<ul>\n<li><a href=\"#1-%EB%AC%B8%EC%A0%9C%EC%A0%90\">1. 문제점</a></li>\n<li><a href=\"#2-%ED%95%B4%EA%B2%B0%EB%B0%A9%EC%95%88\">2. 해결방안</a></li>\n<li><a href=\"#3-%EB%B3%80%EA%B2%BD%EC%A0%90\">3. 변경점</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#-understanding\">🤔 Understanding</a></p>\n</li>\n</ul>\n</div>","excerpt":"✍️ Today I Learned 다중 인스턴스로 구성된 환경에서 동시에 임계 자원에 접근하려는 상황(동시성)을 제어하기 위해 도입한 방법을 간략히 정리하고 공유하기 위해 글을 남긴다. 1. 문제점 현재 사내에서 사용중인 서비스 구성도는 아래 사진과 같다.  이 구성도 내부에서 API Server는 Docker compose 환경에서  옵션으로 구성하여 쓰레드 갯수 만큼 다중 인스턴스 환경으로 구성되고 있다. 여러개의 인스턴스로 구성되어 있기 때문에 스케쥴링 작업 등 여러개의 인스턴스가 동시에 같은 자원을 요구하는 작업에서 반복적인 에러가 리포팅되고 있었다. 2. 해결방안 우선 키워드를 먼저 언급하자면 “동시성 제어(concurrency control)”였다. 비슷한 레퍼런스를 찾고자하니 많은 솔루션들이 나왔다. 기억나는 솔루션 중 참고 될 만한 자료들은 링크로 따로 남겨두겠다. 🔗 PM2 환경에서 중복되지 않는 스케쥴링 구현 🔗 스프링 환경에서 스케쥴러 락 (ShedLock) 위 …","frontmatter":{"date":"April 21, 2024","title":"다중 인스턴스 환경에서 동시성을 해결하기 위한 Redis 분산락 구현하기","categories":"TIL","author":"JH8459","emoji":"📚"},"fields":{"slug":"/2024-04-21-TIL/"}},"next":{"id":"79c4826f-08bf-56d9-8798-09b07d98feaa","html":"<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 56.666666666666664%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAALABQDASIAAhEBAxEB/8QAFwAAAwEAAAAAAAAAAAAAAAAAAAECA//EABUBAQEAAAAAAAAAAAAAAAAAAAAF/9oADAMBAAIQAxAAAAHSaSawD//EABYQAAMAAAAAAAAAAAAAAAAAAAABIP/aAAgBAQABBQIU/wD/xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/AT//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/AT//xAAWEAADAAAAAAAAAAAAAAAAAAAAIDH/2gAIAQEABj8CIv8A/8QAGBAAAgMAAAAAAAAAAAAAAAAAAAERIDH/2gAIAQEAAT8hGb2Ff//aAAwDAQACAAMAAAAQHD//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/ED//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/ED//xAAZEAACAwEAAAAAAAAAAAAAAAABEQAgQVH/2gAIAQEAAT8QjVhju1//2Q=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"github-blog.png\"\n        title=\"github-blog.png\"\n        src=\"/static/7c4bbfe7d1a9d6bc02891c94bfe039dc/80e3c/TIL.jpg\"\n        srcset=\"/static/7c4bbfe7d1a9d6bc02891c94bfe039dc/4ec73/TIL.jpg 180w,\n/static/7c4bbfe7d1a9d6bc02891c94bfe039dc/158ba/TIL.jpg 360w,\n/static/7c4bbfe7d1a9d6bc02891c94bfe039dc/80e3c/TIL.jpg 720w,\n/static/7c4bbfe7d1a9d6bc02891c94bfe039dc/47311/TIL.jpg 1080w,\n/static/7c4bbfe7d1a9d6bc02891c94bfe039dc/ac614/TIL.jpg 1272w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<br>\n<h2 id=\"️-today-i-learned\" style=\"position:relative;\"><a href=\"#%EF%B8%8F-today-i-learned\" aria-label=\"️ today i learned permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>✍️ <strong>T</strong>oday <strong>I</strong> <strong>L</strong>earned</h2>\n<hr>\n<p>Bash Script를 통하여 Slack Incoming Webhook 알림 요청을 수행하고 이를 자동화 하는 과정을 간략히 정리하고 공유하기 위해 글을 남긴다.</p>\n<br>\n<br>\n<h3 id=\"1-필요성\" style=\"position:relative;\"><a href=\"#1-%ED%95%84%EC%9A%94%EC%84%B1\" aria-label=\"1 필요성 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. 필요성</h3>\n<hr>\n<p>현재 우리 회사의 가장 중요한 서비스를 꼽으라하면 인재 채용을 위한 온라인 인적성 검사이다.</p>\n<p>검사에 필요한 내용(문항과 지문 이미지 등)을 제공하는 <strong>API 서버</strong>와 응시자가 유효한 환경에서 검사를 치르고 있는지 웹캠과 화면 공유를 실시간으로 소통하는 <strong>WebRTC 서버</strong>를 구성하여 온라인 응시환경을 제공하고 있다.</p>\n<p>뿐만 아니라, 검사가 끝나면 응시자의 검사 녹화 영상을 저장하고 계약 내용에 따라 제공(평균 한달 이상 보관)하고 있다.</p>\n<p>수시 채용기간에는 큰 문제가없지만, 상반기 / 하반기 공채 기간에는 큰 리소스가 필요하게 되므로, 해당 슬랙 알림 기능을 구현하여 팀원들 모두에게 자원 유지의 편의성을 제공하기 위해 Bash Script와 슬랙 웹훅 기능을 통해 자원 모니터링 기능이 필요로 했다.</p>\n<blockquote>\n<p>시스템 자원을 위한 대쉬보드 구현 또한 고려 대상이었으나, 단순 디스크 자원 체크를 위해 너무 큰 투자라 생각하였기에 간단한 Slack Incoming Webhook으로 구현하였다.</p>\n</blockquote>\n<br>\n<br>\n<h3 id=\"2-해결과정\" style=\"position:relative;\"><a href=\"#2-%ED%95%B4%EA%B2%B0%EA%B3%BC%EC%A0%95\" aria-label=\"2 해결과정 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2. 해결과정</h3>\n<hr>\n<p>Slack Incoming Webhook 수신을 위해 채널을 새로 생성 후 앱 설정(<a href=\"https://api.slack.com/messaging/webhooks\" target=\"_blank\"><a href=\"https://api.slack.com\">https://api.slack.com</a></a> 참고)을 마치면 아래와 같은 cURL 요청 샘플을 받아볼 수 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">curl -X POST --data-urlencode \"payload={\\\"channel\\\": \\\"#my-channel-here\\\", \\\"username\\\": \\\"webhookbot\\\", \\\"text\\\": \\\"이 항목은 #개의 my-channel-here에 포스트되며 webhookbot이라는 봇에서 제공됩니다.\\\", \\\"icon_emoji\\\": \\\":ghost:\\\"}\" https://hooks.slack.com/services/SAMPLE</code></pre></div>\n<p>아래와 같은 메시지 알림이 채널에 수신된다면 기본적인 준비는 마친거다.</p>\n<br>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 632px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 9.444444444444445%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAACCAYAAABYBvyLAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAYklEQVQI123MuwrAIAyF4b7/67kJQkUpXqKbmIByihk6dfj4IQdy+dvDWgtjDJxzaK2h944xBpj515wTIqL0NhnCgr03ridEhBD02SlVQikFtVbtQUTIOX9SSt92xBi1ay28z0iW/VuvJckAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"webhook.png\"\n        title=\"webhook.png\"\n        src=\"/static/707d7097fe360becbe5ad342bd28a14a/084e2/webhook.png\"\n        srcset=\"/static/707d7097fe360becbe5ad342bd28a14a/e9ff0/webhook.png 180w,\n/static/707d7097fe360becbe5ad342bd28a14a/f21e7/webhook.png 360w,\n/static/707d7097fe360becbe5ad342bd28a14a/084e2/webhook.png 632w\"\n        sizes=\"(max-width: 632px) 100vw, 632px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<br>\n<p>아래와 같은 Bash Script를 작성하여 위 메시지를 커스텀해주었다.</p>\n<ul>\n<li>\n<p><strong>ssd.sh</strong></p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token shebang important\">#!/bin/bash</span>\n\n<span class=\"token comment\"># /main volume의 디스크 사용량 정보를 가져옵니다.</span>\n<span class=\"token assign-left variable\">disk_info</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">df</span> <span class=\"token parameter variable\">-h</span> /main <span class=\"token operator\">|</span> <span class=\"token function\">tail</span> <span class=\"token parameter variable\">-1</span><span class=\"token variable\">)</span></span>\n\n<span class=\"token comment\"># \"총 용량\", \"사용한 용량\", \"남은 용량\", \"사용률\" 순으로 출력합니다.</span>\n<span class=\"token assign-left variable\">total</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token builtin class-name\">echo</span> $disk_info <span class=\"token operator\">|</span> <span class=\"token function\">awk</span> <span class=\"token string\">'{print $2}'</span><span class=\"token variable\">)</span></span>\n<span class=\"token assign-left variable\">used</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token builtin class-name\">echo</span> $disk_info <span class=\"token operator\">|</span> <span class=\"token function\">awk</span> <span class=\"token string\">'{print $3}'</span><span class=\"token variable\">)</span></span>\n<span class=\"token assign-left variable\">available</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token builtin class-name\">echo</span> $disk_info <span class=\"token operator\">|</span> <span class=\"token function\">awk</span> <span class=\"token string\">'{print $4}'</span><span class=\"token variable\">)</span></span>\n<span class=\"token assign-left variable\">use_percentage</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token builtin class-name\">echo</span> $disk_info <span class=\"token operator\">|</span> <span class=\"token function\">awk</span> <span class=\"token string\">'{print $5}'</span><span class=\"token variable\">)</span></span>\n\n<span class=\"token comment\"># /main/WEBRTC/public/uploads 디렉토리의 하위 디렉토리별 디스크 사용량 정보를 가져옵니다.</span>\n<span class=\"token assign-left variable\">directory1_disk_usage</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">du</span> <span class=\"token parameter variable\">-sh</span> /main/WEBRTC/public/uploads/directory1 <span class=\"token operator\">|</span> <span class=\"token function\">awk</span> <span class=\"token string\">'{print $1}'</span><span class=\"token variable\">)</span></span>\n<span class=\"token assign-left variable\">directory2_disk_usage</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">du</span> <span class=\"token parameter variable\">-sh</span> /main/WEBRTC/public/uploads/directory2 <span class=\"token operator\">|</span> <span class=\"token function\">awk</span> <span class=\"token string\">'{print $1}'</span><span class=\"token variable\">)</span></span>\n<span class=\"token comment\"># curl을 통해 Slack에 메시지를 보냅니다.</span>\n<span class=\"token function\">curl</span> <span class=\"token parameter variable\">-X</span> POST --data-urlencode <span class=\"token string\">\"payload={<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>channel<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>: <span class=\"token entity\" title=\"\\&quot;\">\\\"</span>#채널명<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>, <span class=\"token entity\" title=\"\\&quot;\">\\\"</span>text<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>: <span class=\"token entity\" title=\"\\&quot;\">\\\"</span>===============================<span class=\"token entity\" title=\"\\n\">\\n</span>          ‼️ RTC 서버 사용량 알림 ‼️<span class=\"token entity\" title=\"\\n\">\\n</span>------------------------------------------------<span class=\"token entity\" title=\"\\n\">\\n</span>1. 총 용량: <span class=\"token variable\">$total</span><span class=\"token entity\" title=\"\\n\">\\n</span>2. 사용한 용량: <span class=\"token variable\">$used</span> (<span class=\"token variable\">$use_percentage</span> 사용)<span class=\"token entity\" title=\"\\n\">\\n</span>3. 남은 용량: <span class=\"token variable\">$available</span><span class=\"token entity\" title=\"\\n\">\\n</span>4. 폴더 별 사용량<span class=\"token entity\" title=\"\\n\">\\n</span><span class=\"token entity\" title=\"\\n\">\\n</span>    - 1번: <span class=\"token variable\">$directory1_disk_usage</span><span class=\"token entity\" title=\"\\n\">\\n</span>    - 2번: <span class=\"token variable\">$directory2_disk_usage</span><span class=\"token entity\" title=\"\\n\">\\n</span><span class=\"token entity\" title=\"\\n\">\\n</span>===============================<span class=\"token entity\" title=\"\\&quot;\">\\\"</span>}\"</span> https://hooks.slack.com/services/SAMPLE</code></pre></div>\n</li>\n</ul>\n<p>Script 구현 난이도 자체는 높지 않았기에 금방 작성할 수 있었다.</p>\n<blockquote>\n<p>다만, 사용하는 디렉토리 구조에 따라 유효하지 않을 수 있기 떄문에 이 글을 보고 해당 기능을 구현하고자하신다면 별도의 커스텀 과정이 꼭 필요하다.</p>\n</blockquote>\n<p>스크립트를 실행해보면 다음과 같은 메시지를 받아 볼 수 있다.</p>\n<br>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 356px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 102.77777777777777%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAVCAYAAABG1c6oAAAACXBIWXMAAAsTAAALEwEAmpwYAAAB8UlEQVQ4y51UXW+iQBT1/z/uvuy/2OzrPnSfNtk0IZqiSEURqUYYPoQRKx/q2dzbDkUstnaSkzswcOace+9MTxsasJcrTCYTPDzoWK/X2EqJ7XbL2O/3+Ow4nU7offvxHT9/32E+d2BNLHi+wEZKRFGEMAyRJAnKsjxDURTIqwpFWSLPc35HZDR6v/7oeHQ9lGUBmWVIhUDsLrBJU6RpiiAImFgIwQiDkN8Je4bY97BJEkgp3wgbejmUTw7k/V+MpzMEQsA0TSbSdR2GYcAYGZjN58i1fzgG/pldJjwej8ylrBDKokCWZYzdbsdQOSU1hF299sy26xwqZvp5tVphuVzCcRzQRofDAVVV8bypggatKTTXa0La1XVdDIdDPJom54k2UT/TOimRrx3wXoXZsppQNYmk3+8z8WAwgOd59WaWZfHzdDplKBKFC4VU0cViwWTj8ZgjDWWnS1F71IRRGGE0GkHTNFZn2zaD5pT8LkVt4pqQqku2qefiOOb8kWpqGSpMF+GFwuZC8+OXdjp9aLHTMkVSQv1IkSqrjtQ1RVcJFZkibPbXzQrbzUq4RVmnZaWufUK+lENF1Mxhm/QaakL10KXwpgu2bVkVQ8XPKLtQqI6e7/vc2E3Qu0C8XLLqsqXI375etnQgzi7YW6r4keX/QGZkFR+vrT4AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"notice.png\"\n        title=\"notice.png\"\n        src=\"/static/7097206d69fb0961d380c4d70f4b82b2/50ac3/notice.png\"\n        srcset=\"/static/7097206d69fb0961d380c4d70f4b82b2/e9ff0/notice.png 180w,\n/static/7097206d69fb0961d380c4d70f4b82b2/50ac3/notice.png 356w\"\n        sizes=\"(max-width: 356px) 100vw, 356px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<br>\n<p>그 후엔 <code class=\"language-text\">/etc/crontab</code> 파일을 수정하여 월~금 매일 오전 09시에 위 메시지 알림을 받아보고 있다.</p>\n<br>\n<br>\n<h2 id=\"-understanding\" style=\"position:relative;\"><a href=\"#-understanding\" aria-label=\" understanding permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>🤔 Understanding</h2>\n<hr>\n<p>작년엔 구현에 집중했다면, 올해는 불편했던 기능들을 하나씩 자동화 구현을 위해 노력해 볼 예정이다.</p>\n<p>추후엔 Bash Script를 이용하여 사람이 하드웨어 리소스는 관여 안 할 수 있게끔 구현해보려한다.</p>\n<p>계약기간에 따라 다운로드 링크 제공 기간이 지난 리소스들은 백업 스토리지 공간으로 옮기고, 보관 기간이 지난 영상들은 리소스를 완전 삭제하는 기능까지 구현해 볼 예정이다.</p>\n<br>\n<br>\n<div class=\"table-of-contents\">\n<ul>\n<li>\n<p><a href=\"#%EF%B8%8F-today-i-learned\">✍️ <strong>T</strong>oday <strong>I</strong> <strong>L</strong>earned</a></p>\n<ul>\n<li><a href=\"#1-%ED%95%84%EC%9A%94%EC%84%B1\">1. 필요성</a></li>\n<li><a href=\"#2-%ED%95%B4%EA%B2%B0%EA%B3%BC%EC%A0%95\">2. 해결과정</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#-understanding\">🤔 Understanding</a></p>\n</li>\n</ul>\n</div>","frontmatter":{"date":"April 18, 2024","title":"Bash Script를 이용한 Slack Incoming Webhook 알림 자동화","categories":"TIL","author":"JH8459","emoji":"📚"},"fields":{"slug":"/2024-04-18-TIL/"}},"prev":null,"site":{"siteMetadata":{"siteUrl":"https://blog.jh8459.com","comments":{"utterances":{"repo":"JH8459/JH8459.github.io"}}}}},"pageContext":{"slug":"/2024-04-21-TIL/","nextSlug":"/2024-04-18-TIL/","prevSlug":""}},"staticQueryHashes":["1073350324","1956554647","2938748437"]}