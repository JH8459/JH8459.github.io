{"componentChunkName":"component---src-templates-blog-template-js","path":"/2025-01-17-TIL/","result":{"data":{"cur":{"id":"27677ff8-1d51-5e43-9e21-faf101043917","html":"<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 56.666666666666664%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAALABQDASIAAhEBAxEB/8QAFgABAQEAAAAAAAAAAAAAAAAAAAID/8QAFQEBAQAAAAAAAAAAAAAAAAAAAAX/2gAMAwEAAhADEAAAAdJomgf/xAAWEAADAAAAAAAAAAAAAAAAAAAAASD/2gAIAQEAAQUCFP8A/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPwE//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPwE//8QAFhAAAwAAAAAAAAAAAAAAAAAAACAx/9oACAEBAAY/AiL/AP/EABgQAAIDAAAAAAAAAAAAAAAAAAABESAx/9oACAEBAAE/IRm9hX//2gAMAwEAAgADAAAAEEw//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPxA//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPxA//8QAGRAAAgMBAAAAAAAAAAAAAAAAAREAIEFR/9oACAEBAAE/EI1YY7tf/9k='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"github-blog.png\"\n        title=\"\"\n        src=\"/static/7c4bbfe7d1a9d6bc02891c94bfe039dc/80e3c/til.jpg\"\n        srcset=\"/static/7c4bbfe7d1a9d6bc02891c94bfe039dc/4ec73/til.jpg 180w,\n/static/7c4bbfe7d1a9d6bc02891c94bfe039dc/158ba/til.jpg 360w,\n/static/7c4bbfe7d1a9d6bc02891c94bfe039dc/80e3c/til.jpg 720w,\n/static/7c4bbfe7d1a9d6bc02891c94bfe039dc/47311/til.jpg 1080w,\n/static/7c4bbfe7d1a9d6bc02891c94bfe039dc/ac614/til.jpg 1272w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<br>\n<h2 id=\"️-today-i-learned\" style=\"position:relative;\"><a href=\"#%EF%B8%8F-today-i-learned\" aria-label=\"️ today i learned permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>✍️ <strong>T</strong>oday <strong>I</strong> <strong>L</strong>earned</h2>\n<p>이전 포스팅 중 <a href=\"https://blog.jh8459.com/2024-12-01-TIL/\" target=\"_blank\">Presigned URL S3 파일 업로드</a>에서 사용자들이 사용하는 리소스(녹화영상 및 다수의 이미지 파일)들을 이제 S3로 직접 업로드가 되도록 인프라 구성을 부분적으로 변경하였다.</p>\n<p>또한 파일 타입에 따라 규칙적인 경로 구성을 갖도록 구성했었는데 이러한 일정한 규칙을 근거로 <strong>AWS Lambda + EventBridge</strong>를 사용하여 리소스를 자동으로 관리하는 과정을 간략하게 기록하고자 포스팅을 남긴다.</p>\n<br>\r\n<br>\n<h3 id=\"1-현재-사용중인-aws-s3의-문제점\" style=\"position:relative;\"><a href=\"#1-%ED%98%84%EC%9E%AC-%EC%82%AC%EC%9A%A9%EC%A4%91%EC%9D%B8-aws-s3%EC%9D%98-%EB%AC%B8%EC%A0%9C%EC%A0%90\" aria-label=\"1 현재 사용중인 aws s3의 문제점 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. 현재 사용중인 AWS S3의 문제점</h3>\n<hr>\n<p>현재 사용자들이 사용하는 모든 리소스들은 아래와 같은 방법으로 <strong>미리 서명된 URL</strong>을 발급 받은 뒤 클라이언트 측에서 직접 AWS S3로 업로드를 하고 있다.</p>\n<img src=\"https://jh8459.s3.ap-northeast-2.amazonaws.com/blog/2024-12-01-TIL/after_infra.png\">\n<br>\n<p>요즘 채용 트렌트가 상,하반기로 나누어 진행하는 이른바 대규모 공개 채용(공채)보다는 365일 수시로 채용하는 경우가 많다.</p>\n<p>수시 채용 특성상 지원자들을 한 장소 혹은 특정일자에 모두 맞춰서 채용 절차를 진행하기 어려우므로 유동적으로 운영하는 경우가 많다. 그렇기에 사내 서비스 또한 이에 맞추어 365일 24시간 중단없이 운영되야한다.</p>\n<br>\r\n<br>\n<img src=\"https://jh8459.s3.ap-northeast-2.amazonaws.com/blog/2025-01-17-TIL/SKCT.png\">\n<br>\n<center><strong>많은 기업에서 위와 같이 일정 기간동안 온라인 인적성 검사를 진행한다.</strong></center><br><br>\n<p>그렇기 때문에 예측하기 어려운 불특정한 일시에 S3에 리소스들이 쌓일 수 밖에 없으며 이로인하여 보관 비용 문제가 누적될 수 밖에 없는 구조이다.</p>\n<br>\r\n<br>\n<h3 id=\"2-aws-lambda-함수-생성\" style=\"position:relative;\"><a href=\"#2-aws-lambda-%ED%95%A8%EC%88%98-%EC%83%9D%EC%84%B1\" aria-label=\"2 aws lambda 함수 생성 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2. AWS Lambda 함수 생성</h3>\n<hr>\n<p>우선 AWS Lambda를 통하여 S3의 리소스 관리를 선택한 이유는 아래 이유가 가장 주요하다.</p>\n<br>\n<ol>\n<li>S3의 생명주기 설정은 접두사(prefix) 규칙만으로 제어를 할 수 있기에 커스터마이징에 한계가 있다.</li>\n<li>S3 리소스 정리는 계획상 하루 한번만 동작할 예정이기에 사용량에 따라 과금되는 AWS Lambda 과금 모델은 비용 합리적이다.</li>\n<li>특정 인프라에 종속되지 않는 완전 관리형 서비스이므로 유지보수가 편리하다.</li>\n</ol>\n<br>\n<p>위 이유 외에도 AWS Lambda에서 <code class=\"language-text\">node.js</code>로 Javascript 코드를 실행할 수 있는 것 또한 큰 결정 이유이기도 하다.</p>\n<p>매일 한국시간 기준(KST)으로 자정 정각에 동작할 핸들러 함수는 미리 정의해둔 S3 폴더 규칙에 따라서 입맛에 맞게 구현하였고 리소스가 삭제된 후 슬랙 웹 훅으로 삭제된 리소스들의 대한 알림을 받아 볼 수 있게끔 구현해두었다.</p>\n<br>\r\n<details>\r\n<summary><strong>AWS Lambda 핸들러 함수 코드 샘플</strong></summary>\n<br>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> S3Client<span class=\"token punctuation\">,</span> ListObjectsV2Command<span class=\"token punctuation\">,</span> DeleteObjectsCommand <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'@aws-sdk/client-s3'</span><span class=\"token punctuation\">;</span>\r\n<span class=\"token keyword\">import</span> https <span class=\"token keyword\">from</span> <span class=\"token string\">'https'</span><span class=\"token punctuation\">;</span>\r\n\r\n<span class=\"token comment\">// S3 클라이언트 초기화</span>\r\n<span class=\"token keyword\">const</span> s3 <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">S3Client</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">region</span><span class=\"token operator\">:</span> <span class=\"token string\">'ap-northeast-2'</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// S3 리전 설정</span>\r\n<span class=\"token keyword\">const</span> <span class=\"token constant\">SLACK_WEBHOOK_URL</span> <span class=\"token operator\">=</span> <span class=\"token string\">'...'</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// Slack 웹훅 URL</span>\r\n\r\n<span class=\"token comment\">/**\r\n * Lambda 핸들러 함수\r\n */</span>\r\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">handler</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n  <span class=\"token keyword\">const</span> bucketName <span class=\"token operator\">=</span> <span class=\"token string\">'acg-rtc'</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// S3 버킷 이름</span>\r\n  <span class=\"token keyword\">const</span> prefixes <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'NEW_ACG/'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'ACG/'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'SK/'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'CJ/'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'NEW_LG/'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'LG/'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// S3 접두어 목록</span>\r\n\r\n  <span class=\"token comment\">// 오늘 기준 30일 전 날짜를 계산하여 cutoffDateString 생성 (YYYY-MM-DD 형식)</span>\r\n  <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">getCutoffDateString</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token keyword\">const</span> now <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Date</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 현재 날짜 가져오기</span>\r\n    now<span class=\"token punctuation\">.</span><span class=\"token function\">setDate</span><span class=\"token punctuation\">(</span>now<span class=\"token punctuation\">.</span><span class=\"token function\">getDate</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> <span class=\"token number\">30</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 30일 전으로 이동</span>\r\n    <span class=\"token keyword\">return</span> now<span class=\"token punctuation\">.</span><span class=\"token function\">toISOString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">split</span><span class=\"token punctuation\">(</span><span class=\"token string\">'T'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// YYYY-MM-DD 형식으로 변환</span>\r\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\r\n\r\n  <span class=\"token keyword\">const</span> cutoffDateString <span class=\"token operator\">=</span> <span class=\"token function\">getCutoffDateString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 기준 날짜 계산</span>\r\n\r\n  <span class=\"token keyword\">let</span> totalDeletedSize <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 총 삭제한 리소스 크기 합산</span>\r\n  <span class=\"token keyword\">const</span> allDeletedKeys <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 삭제된 키 목록</span>\r\n  <span class=\"token keyword\">const</span> deletedClients <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 삭제된 고객사 목록 및 정보</span>\r\n\r\n<span class=\"token comment\">/**\r\n   * 숫자에 1,000 단위로 콤마 추가\r\n   * @param {number} number - 포맷할 숫자\r\n   * @returns {string} 콤마가 추가된 숫자 문자열\r\n   */</span>\r\n  <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">formatNumberWithCommas</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">number</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Intl<span class=\"token punctuation\">.</span>NumberFormat</span><span class=\"token punctuation\">(</span><span class=\"token string\">'ko-KR'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">format</span><span class=\"token punctuation\">(</span>number<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\r\n  \r\n  <span class=\"token comment\">/**\r\n   * 크기를 적절한 단위로 변환 (MB, GB, TB 등)\r\n   * @param {number} sizeInBytes - 크기 (바이트)\r\n   * @returns {string} 적절한 단위로 변환된 크기 문자열\r\n   */</span>\r\n  <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">formatSize</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">sizeInBytes</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>sizeInBytes <span class=\"token operator\">&lt;</span> <span class=\"token number\">1024</span> <span class=\"token operator\">**</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n      <span class=\"token keyword\">return</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span><span class=\"token punctuation\">(</span>sizeInBytes <span class=\"token operator\">/</span> <span class=\"token number\">1024</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toFixed</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\"> KB</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">;</span>\r\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>sizeInBytes <span class=\"token operator\">&lt;</span> <span class=\"token number\">1024</span> <span class=\"token operator\">**</span> <span class=\"token number\">3</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n      <span class=\"token keyword\">return</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span><span class=\"token punctuation\">(</span>sizeInBytes <span class=\"token operator\">/</span> <span class=\"token number\">1024</span> <span class=\"token operator\">**</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toFixed</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\"> MB</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">;</span>\r\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>sizeInBytes <span class=\"token operator\">&lt;</span> <span class=\"token number\">1024</span> <span class=\"token operator\">**</span> <span class=\"token number\">4</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n      <span class=\"token keyword\">return</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span><span class=\"token punctuation\">(</span>sizeInBytes <span class=\"token operator\">/</span> <span class=\"token number\">1024</span> <span class=\"token operator\">**</span> <span class=\"token number\">3</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toFixed</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\"> GB</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">;</span>\r\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\r\n      <span class=\"token keyword\">return</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span><span class=\"token punctuation\">(</span>sizeInBytes <span class=\"token operator\">/</span> <span class=\"token number\">1024</span> <span class=\"token operator\">**</span> <span class=\"token number\">4</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toFixed</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\"> TB</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">;</span>\r\n    <span class=\"token punctuation\">}</span>\r\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\r\n\r\n  <span class=\"token comment\">/**\r\n   * S3 객체 삭제 함수\r\n   * 특정 prefix와 cutoffDateString에 따라 삭제할 객체를 필터링하여 삭제\r\n   */</span>\r\n  <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">deleteObjectsByDate</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">prefix<span class=\"token punctuation\">,</span> cutoffDateString</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token keyword\">const</span> deletedKeys <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\r\n    <span class=\"token keyword\">let</span> prefixDeletedSize <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 특정 prefix에서 삭제한 크기 합산</span>\r\n    <span class=\"token keyword\">let</span> continuationToken <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\r\n\r\n    <span class=\"token keyword\">do</span> <span class=\"token punctuation\">{</span>\r\n      <span class=\"token keyword\">const</span> response <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> s3<span class=\"token punctuation\">.</span><span class=\"token function\">send</span><span class=\"token punctuation\">(</span>\r\n        <span class=\"token keyword\">new</span> <span class=\"token class-name\">ListObjectsV2Command</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\r\n          <span class=\"token literal-property property\">Bucket</span><span class=\"token operator\">:</span> bucketName<span class=\"token punctuation\">,</span>\r\n          <span class=\"token literal-property property\">Prefix</span><span class=\"token operator\">:</span> prefix<span class=\"token punctuation\">,</span> <span class=\"token comment\">// 탐색할 접두어</span>\r\n          <span class=\"token literal-property property\">MaxKeys</span><span class=\"token operator\">:</span> <span class=\"token number\">1000</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// 한 번에 최대 1000개 객체 반환</span>\r\n          <span class=\"token literal-property property\">ContinuationToken</span><span class=\"token operator\">:</span> continuationToken<span class=\"token punctuation\">,</span> <span class=\"token comment\">// 페이징 토큰</span>\r\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\r\n      <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n\r\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>response<span class=\"token punctuation\">.</span>Contents <span class=\"token operator\">||</span> response<span class=\"token punctuation\">.</span>Contents<span class=\"token punctuation\">.</span>length <span class=\"token operator\">===</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n        <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 더 이상 처리할 객체가 없음</span>\r\n      <span class=\"token punctuation\">}</span>\r\n\r\n      <span class=\"token comment\">// 기준 날짜 이전의 객체 필터링</span>\r\n      <span class=\"token keyword\">const</span> objectsToDelete <span class=\"token operator\">=</span> response<span class=\"token punctuation\">.</span>Contents<span class=\"token punctuation\">.</span><span class=\"token function\">filter</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">obj</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n        <span class=\"token keyword\">const</span> keyParts <span class=\"token operator\">=</span> obj<span class=\"token punctuation\">.</span>Key<span class=\"token punctuation\">.</span><span class=\"token function\">split</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n        <span class=\"token keyword\">const</span> datePart <span class=\"token operator\">=</span> keyParts<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 키에서 YYYYMMDD 추출</span>\r\n\r\n        <span class=\"token keyword\">return</span> <span class=\"token regex\"><span class=\"token regex-delimiter\">/</span><span class=\"token regex-source language-regex\">^\\d{8}$</span><span class=\"token regex-delimiter\">/</span></span><span class=\"token punctuation\">.</span><span class=\"token function\">test</span><span class=\"token punctuation\">(</span>datePart<span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> datePart <span class=\"token operator\">&lt;</span> cutoffDateString<span class=\"token punctuation\">.</span><span class=\"token function\">replace</span><span class=\"token punctuation\">(</span><span class=\"token regex\"><span class=\"token regex-delimiter\">/</span><span class=\"token regex-source language-regex\">-</span><span class=\"token regex-delimiter\">/</span><span class=\"token regex-flags\">g</span></span><span class=\"token punctuation\">,</span> <span class=\"token string\">''</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 날짜 조건 확인</span>\r\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n\r\n      <span class=\"token comment\">// 삭제 요청 수행 (1,000개 단위로 나누어서 삭제)</span>\r\n      <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">let</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> objectsToDelete<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">;</span> i <span class=\"token operator\">+=</span> <span class=\"token number\">1000</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n        <span class=\"token keyword\">const</span> batchToDelete <span class=\"token operator\">=</span> objectsToDelete<span class=\"token punctuation\">.</span><span class=\"token function\">slice</span><span class=\"token punctuation\">(</span>i<span class=\"token punctuation\">,</span> i <span class=\"token operator\">+</span> <span class=\"token number\">1000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 1,000개씩 분할</span>\r\n\r\n        <span class=\"token keyword\">await</span> s3<span class=\"token punctuation\">.</span><span class=\"token function\">send</span><span class=\"token punctuation\">(</span>\r\n          <span class=\"token keyword\">new</span> <span class=\"token class-name\">DeleteObjectsCommand</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\r\n            <span class=\"token literal-property property\">Bucket</span><span class=\"token operator\">:</span> bucketName<span class=\"token punctuation\">,</span>\r\n            <span class=\"token literal-property property\">Delete</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\r\n              <span class=\"token literal-property property\">Objects</span><span class=\"token operator\">:</span> batchToDelete<span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">obj</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">Key</span><span class=\"token operator\">:</span> obj<span class=\"token punctuation\">.</span>Key <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\r\n            <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\r\n          <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\r\n        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n\r\n        <span class=\"token comment\">// 삭제된 객체 키 및 크기 합산</span>\r\n        deletedKeys<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span><span class=\"token operator\">...</span>batchToDelete<span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">obj</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> obj<span class=\"token punctuation\">.</span>Key<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n        <span class=\"token keyword\">const</span> batchDeletedSize <span class=\"token operator\">=</span> batchToDelete<span class=\"token punctuation\">.</span><span class=\"token function\">reduce</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">sum<span class=\"token punctuation\">,</span> obj</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> sum <span class=\"token operator\">+</span> obj<span class=\"token punctuation\">.</span>Size<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n        prefixDeletedSize <span class=\"token operator\">+=</span> batchDeletedSize<span class=\"token punctuation\">;</span>\r\n        totalDeletedSize <span class=\"token operator\">+=</span> batchDeletedSize<span class=\"token punctuation\">;</span> <span class=\"token comment\">// 전체 삭제 크기 합산</span>\r\n      <span class=\"token punctuation\">}</span>\r\n\r\n      continuationToken <span class=\"token operator\">=</span> response<span class=\"token punctuation\">.</span>NextContinuationToken<span class=\"token punctuation\">;</span> <span class=\"token comment\">// 다음 페이지를 위한 토큰 설정</span>\r\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>continuationToken<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 더 이상 페이지가 없을 때까지 반복</span>\r\n\r\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span> deletedKeys<span class=\"token punctuation\">,</span> prefixDeletedSize <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\r\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\r\n\r\n  <span class=\"token comment\">// 모든 Prefix에 대해 삭제 작업 수행</span>\r\n  <span class=\"token keyword\">const</span> deletePromises <span class=\"token operator\">=</span> prefixes<span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">prefix</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\r\n      <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> deletedKeys<span class=\"token punctuation\">,</span> prefixDeletedSize <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">deleteObjectsByDate</span><span class=\"token punctuation\">(</span>prefix<span class=\"token punctuation\">,</span> cutoffDateString<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n      allDeletedKeys<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span><span class=\"token operator\">...</span>deletedKeys<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n\r\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>deletedKeys<span class=\"token punctuation\">.</span>length <span class=\"token operator\">></span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n        deletedClients<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\r\n          <span class=\"token literal-property property\">prefix</span><span class=\"token operator\">:</span> prefix<span class=\"token punctuation\">.</span><span class=\"token function\">replace</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">''</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// 접두어 이름</span>\r\n          <span class=\"token literal-property property\">count</span><span class=\"token operator\">:</span> deletedKeys<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">,</span> <span class=\"token comment\">// 삭제된 객체 수</span>\r\n          <span class=\"token literal-property property\">size</span><span class=\"token operator\">:</span> prefixDeletedSize<span class=\"token punctuation\">,</span> <span class=\"token comment\">// 삭제된 크기</span>\r\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n      <span class=\"token punctuation\">}</span>\r\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>error<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n      console<span class=\"token punctuation\">.</span><span class=\"token function\">error</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Failed to process prefix: </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>prefix<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\"> - </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>error<span class=\"token punctuation\">.</span>message<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n    <span class=\"token punctuation\">}</span>\r\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n\r\n  <span class=\"token keyword\">await</span> Promise<span class=\"token punctuation\">.</span><span class=\"token function\">all</span><span class=\"token punctuation\">(</span>deletePromises<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n\r\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>allDeletedKeys<span class=\"token punctuation\">.</span>length <span class=\"token operator\">===</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">statusCode</span><span class=\"token operator\">:</span> <span class=\"token number\">200</span><span class=\"token punctuation\">,</span> <span class=\"token literal-property property\">body</span><span class=\"token operator\">:</span> <span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">stringify</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">message</span><span class=\"token operator\">:</span> <span class=\"token string\">'No resources to delete.'</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\r\n  <span class=\"token punctuation\">}</span>\r\n\r\n  <span class=\"token comment\">// S3 전체 사용량 가져오기</span>\r\n  <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">getTotalS3Usage</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token keyword\">let</span> totalSize <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\r\n    <span class=\"token keyword\">let</span> continuationToken <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\r\n\r\n    <span class=\"token keyword\">do</span> <span class=\"token punctuation\">{</span>\r\n      <span class=\"token keyword\">const</span> response <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> s3<span class=\"token punctuation\">.</span><span class=\"token function\">send</span><span class=\"token punctuation\">(</span>\r\n        <span class=\"token keyword\">new</span> <span class=\"token class-name\">ListObjectsV2Command</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\r\n          <span class=\"token literal-property property\">Bucket</span><span class=\"token operator\">:</span> bucketName<span class=\"token punctuation\">,</span>\r\n          <span class=\"token literal-property property\">ContinuationToken</span><span class=\"token operator\">:</span> continuationToken<span class=\"token punctuation\">,</span>\r\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\r\n      <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n\r\n      totalSize <span class=\"token operator\">+=</span> response<span class=\"token punctuation\">.</span>Contents<span class=\"token operator\">?.</span><span class=\"token function\">reduce</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">sum<span class=\"token punctuation\">,</span> obj</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> sum <span class=\"token operator\">+</span> obj<span class=\"token punctuation\">.</span>Size<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">||</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\r\n      continuationToken <span class=\"token operator\">=</span> response<span class=\"token punctuation\">.</span>NextContinuationToken<span class=\"token punctuation\">;</span>\r\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>continuationToken<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n\r\n    <span class=\"token keyword\">return</span> totalSize<span class=\"token punctuation\">;</span> <span class=\"token comment\">// 바이트 단위 반환</span>\r\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\r\n\r\n  <span class=\"token keyword\">const</span> totalS3UsageAfterDeletion <span class=\"token operator\">=</span> <span class=\"token function\">formatSize</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">await</span> <span class=\"token function\">getTotalS3Usage</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n\r\n  <span class=\"token comment\">// 삭제된 리소스 정보 내림차순 정렬 (크기 기준)</span>\r\n  deletedClients<span class=\"token punctuation\">.</span><span class=\"token function\">sort</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">a<span class=\"token punctuation\">,</span> b</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> b<span class=\"token punctuation\">.</span>size <span class=\"token operator\">-</span> a<span class=\"token punctuation\">.</span>size<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n\r\n  <span class=\"token comment\">// 삭제 정보 문자열 생성</span>\r\n  <span class=\"token keyword\">const</span> deletionDetails <span class=\"token operator\">=</span> deletedClients\r\n    <span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">client</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">  - </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>client<span class=\"token punctuation\">.</span>prefix<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">: </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span><span class=\"token function\">formatNumberWithCommas</span><span class=\"token punctuation\">(</span>client<span class=\"token punctuation\">.</span>count<span class=\"token punctuation\">)</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">건 / </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span><span class=\"token function\">formatSize</span><span class=\"token punctuation\">(</span>client<span class=\"token punctuation\">.</span>size<span class=\"token punctuation\">)</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span>\r\n    <span class=\"token punctuation\">.</span><span class=\"token function\">join</span><span class=\"token punctuation\">(</span><span class=\"token string\">'\\n'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n\r\n  <span class=\"token comment\">// Slack 알림 메시지 생성</span>\r\n  <span class=\"token keyword\">const</span> message <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token literal-property property\">channel</span><span class=\"token operator\">:</span> <span class=\"token string\">'#rtc-notice'</span><span class=\"token punctuation\">,</span>\r\n    <span class=\"token literal-property property\">text</span><span class=\"token operator\">:</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">===============================\\n       ‼️ AWS S3 리소스 삭제 알림 ‼️\\n------------------------------------------------\\n1. S3 총 사용량: </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>totalS3UsageAfterDeletion<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">\\n2. 삭제한 리소스 크기: </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span><span class=\"token function\">formatSize</span><span class=\"token punctuation\">(</span>\r\n      totalDeletedSize\r\n    <span class=\"token punctuation\">)</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\"> (~ </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>cutoffDateString<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">)\\n3. 삭제 정보:\\n</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>deletionDetails<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">\\n\\n===============================</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">,</span>\r\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\r\n\r\n  <span class=\"token keyword\">await</span> <span class=\"token function\">sendSlackNotification</span><span class=\"token punctuation\">(</span>message<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n\r\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">statusCode</span><span class=\"token operator\">:</span> <span class=\"token number\">200</span><span class=\"token punctuation\">,</span> <span class=\"token literal-property property\">body</span><span class=\"token operator\">:</span> <span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">stringify</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">message</span><span class=\"token operator\">:</span> <span class=\"token string\">'Resource cleanup completed'</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\r\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\r\n\r\n<span class=\"token comment\">/**\r\n * Slack 알림 전송 함수\r\n */</span>\r\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">sendSlackNotification</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">message</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n  <span class=\"token operator\">...</span><span class=\"token comment\">// 생략</span>\r\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\r\n\r\n</code></pre></div>\n</details>\r\n<br>\n<p>간단한 200줄 내외의 함수를 구현하였으며 관련 라이브러리 모듈들과 <code class=\"language-text\">package.json</code> 파일을 함께 압축하여 직접 업로드(10MB 미만 가능)하였고, 그렇게하여 등록된 핸들러 함수는 아래의 GUI를 통해 간편하게 테스트를 진행할 수 있었다.</p>\n<img src=\"https://jh8459.s3.ap-northeast-2.amazonaws.com/blog/2025-01-17-TIL/lambda.png\">\n<br>\n<center><strong>테스트 버튼만 누르면 작성한 핸들러 함수를 손쉽게 테스트 해볼 수 있다. 👍</strong></center><br><br>\n<p>테스트 결과 또한 <strong>CloudWatch Logs Live Tail</strong>에서 직관적으로 확인할 수 있었기에 핸들러 함수를 구현하고 동작하는 전반적인 과정을 AWS Lambda GUI Console을 통하여 모두 제어할 수 있어서 손쉽게 금방 구현할 수 있었다.</p>\n<br>\r\n<br>\n<h3 id=\"3-aws-eventbridge-등록\" style=\"position:relative;\"><a href=\"#3-aws-eventbridge-%EB%93%B1%EB%A1%9D\" aria-label=\"3 aws eventbridge 등록 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3. AWS EventBridge 등록</h3>\n<hr>\n<p>마지막 단계로 매일 정해진 시간에 AWS Lambda에 등록한 핸들러 함수가 규칙적으로 호출되어 S3 리소스를 자동으로 삭제되게끔 반복시키는 설정이 필요하였고 이를 위해 <strong>AWS EventBridge</strong> 서비스를 추가로 선택하였다.</p>\n<p>이벤트 기반 아키텍처를 구축하기 위해 알려진 서비스이지만 거창한 기능은 사용하지 않았고 미리 작성한 AWS Lambda 함수를 정해진 일정으로 등록하여 반복 실행되게끔 스케쥴링 등록을 해주기 위하여 사용하였다.</p>\n<br>\n<img src=\"https://jh8459.s3.ap-northeast-2.amazonaws.com/blog/2025-01-17-TIL/eventbridge.png\">\n<br>\n<center><strong>Cron 표현식을 사용해서 반복 이벤트 등록이 가능하다.</strong></center><br><br>\n<p>한국 표준시간대로 매일 00시에 AWS Lambda 함수가 호출되게끔 설정해주었고 다음날 AWS Lambda 모니터링 콘솔과 슬랙 웹훅 알림을 확인하여 정상 작동을 확인하였다.</p>\n<br>\n<img src=\"https://jh8459.s3.ap-northeast-2.amazonaws.com/blog/2025-01-17-TIL/monitor.png\">\n<br>\n<center><strong>00:00 로컬 시간대(KST) AWS Lamba 함수 호출 성공 로그 확인 ✅</strong></center><br><br>\n<br>\r\n<br>\n<h2 id=\"-understanding\" style=\"position:relative;\"><a href=\"#-understanding\" aria-label=\" understanding permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>🤔 Understanding</h2>\n<p>S3에 누적되는 높은 용량(영상 혹은 이미지 등)을 갖는 리소스들은 비용적인 측면 때문에 무수히 긴 보관 기간을 가질 수는 없다.</p>\n<p>본문에 기재하진 않았지만 이 외에도 개발 환경에서 테스트 목적으로 생성되는 리소스들은 접두사 <code class=\"language-text\">/TEST_</code> 를 붙혀두어서 S3의 생명주기 설정을 통하여 관리하고 있다.</p>\n<p>인프라를 분리하니 특정 서비스들에 종속되지 않고 AWS에서 제공하는 완전 관리형 서버리스 서비스들을 통하여 자원들을 유연하게 관리할 수 있게 되었다. (기존 온프레미스 환경에서는 스토리지 서버를 두 대로 증설하면 똑같은 스크립트를 두 서버 모두 작성해 주어야만 했다. 😂)</p>\n<p>현재 S3에 적재되는 사용자들의 리소스들은 지원자들의 응시 기간이 모두 종료되는 시점 이후에는 녹화 영상등 저장된 리소스들의 필요성이 급감하므로 비용 효율적인 방안이 추가적으로 있을지 한번 살펴볼만한 여지가 있을 듯 하다. (예를 들자면 2주 뒤에는 리소스들을 S3 Glacier 스토리지 클래스로 이동 후 한달 뒤 완전 삭제 등등..? 🤔)</p>\n<p>앞으로는 낮은 비용으로 높은 효율성을 얻을 수 있는 서비스들을 적극적으로 찾아서 도입을 건의 해봐야겠다.</p>\n<br>\r\n<br>","excerpt":"✍️ Today I Learned 이전 포스팅 중 Presigned URL S3 파일 업로드에서 사용자들이 사용하는 리소스(녹화영상 및 다수의 이미지 파일)들을 이제 S3로 직접 업로드가 되도록 인프라 구성을 부분적으로 변경하였다. 또한 파일 타입에 따라 규칙적인 경로 구성을 갖도록 구성했었는데 이러한 일정한 규칙을 근거로 AWS Lambda + EventBridge를 사용하여 리소스를 자동으로 관리하는 과정을 간략하게 기록하고자 포스팅을 남긴다. 1. 현재 사용중인 AWS S3의 문제점 현재 사용자들이 사용하는 모든 리소스들은 아래와 같은 방법으로 미리 서명된 URL을 발급 받은 뒤 클라이언트 측에서 직접 AWS S3로 업로드를 하고 있다. 요즘 채용 트렌트가 상,하반기로 나누어 진행하는 이른바 대규모 공개 채용(공채)보다는 365일 수시로 채용하는 경우가 많다. 수시 채용 특성상 지원자들을 한 장소 혹은 특정일자에 모두 맞춰서 채용 절차를 진행하기 어려우므로 유동적으로 운영하는 …","timeToRead":6,"tableOfContents":"<ul>\n<li>\n<p><a href=\"#%EF%B8%8F-today-i-learned\">✍️ <strong>T</strong>oday <strong>I</strong> <strong>L</strong>earned</a></p>\n<ul>\n<li><a href=\"#1-%ED%98%84%EC%9E%AC-%EC%82%AC%EC%9A%A9%EC%A4%91%EC%9D%B8-aws-s3%EC%9D%98-%EB%AC%B8%EC%A0%9C%EC%A0%90\">1. 현재 사용중인 AWS S3의 문제점</a></li>\n<li><a href=\"#2-aws-lambda-%ED%95%A8%EC%88%98-%EC%83%9D%EC%84%B1\">2. AWS Lambda 함수 생성</a></li>\n<li><a href=\"#3-aws-eventbridge-%EB%93%B1%EB%A1%9D\">3. AWS EventBridge 등록</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#-understanding\">🤔 Understanding</a></p>\n</li>\n</ul>","frontmatter":{"date":"2025.01.17","title":"AWS Lambda + EventBridge를 사용한 S3 리소스 관리","categories":"TIL","author":"JH8459","emoji":"📚"},"fields":{"slug":"/2025-01-17-TIL/"}},"next":{"id":"0c7186cc-ecbb-51e3-83f4-e6f83eec400e","frontmatter":{"date":"2024.12.22","title":"🤖 프로그래머스 프로필 뱃지 자동 생성 봇","categories":"Project","author":"JH8459","emoji":"🔥"},"fields":{"slug":"/2024-12-22-PROJECT/"}},"prev":{"id":"0ee5052e-a101-562c-9b4c-27c37d3b48c5","frontmatter":{"date":"2025.02.04","title":"Github 프로필 블로그 포스트 자동 업데이트","categories":"Project","author":"JH8459","emoji":"🔥"},"fields":{"slug":"/2025-02-04-PROJECT/"}},"site":{"siteMetadata":{"siteUrl":"https://blog.jh8459.com","comments":{"giscus":{"repo":"JH8459/JH8459.github.io","repoId":"R_kgDOI03HgA","category":"Comments","categoryId":"DIC_kwDOI03HgM4CtuXL"}}}}},"pageContext":{"slug":"/2025-01-17-TIL/","nextSlug":"/2024-12-22-PROJECT/","prevSlug":"/2025-02-04-PROJECT/"}},"staticQueryHashes":["1073350324","2009502679","2938748437","962130685"],"slicesMap":{}}