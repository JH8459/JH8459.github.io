{"componentChunkName":"component---src-templates-blog-template-js","path":"/2025-03-16-TIL/","result":{"data":{"cur":{"id":"4983688a-4820-558e-92d7-4c7a61b27d16","html":"<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 56.666666666666664%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAALABQDASIAAhEBAxEB/8QAFgABAQEAAAAAAAAAAAAAAAAAAAID/8QAFQEBAQAAAAAAAAAAAAAAAAAAAAX/2gAMAwEAAhADEAAAAdJomgf/xAAWEAADAAAAAAAAAAAAAAAAAAAAASD/2gAIAQEAAQUCFP8A/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPwE//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPwE//8QAFhAAAwAAAAAAAAAAAAAAAAAAACAx/9oACAEBAAY/AiL/AP/EABgQAAIDAAAAAAAAAAAAAAAAAAABESAx/9oACAEBAAE/IRm9hX//2gAMAwEAAgADAAAAEEw//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPxA//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPxA//8QAGRAAAgMBAAAAAAAAAAAAAAAAAREAIEFR/9oACAEBAAE/EI1YY7tf/9k='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"github-blog.png\"\n        title=\"\"\n        src=\"/static/7c4bbfe7d1a9d6bc02891c94bfe039dc/80e3c/til.jpg\"\n        srcset=\"/static/7c4bbfe7d1a9d6bc02891c94bfe039dc/4ec73/til.jpg 180w,\n/static/7c4bbfe7d1a9d6bc02891c94bfe039dc/158ba/til.jpg 360w,\n/static/7c4bbfe7d1a9d6bc02891c94bfe039dc/80e3c/til.jpg 720w,\n/static/7c4bbfe7d1a9d6bc02891c94bfe039dc/47311/til.jpg 1080w,\n/static/7c4bbfe7d1a9d6bc02891c94bfe039dc/ac614/til.jpg 1272w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<br>\n<h2 id=\"️-today-i-learned\" style=\"position:relative;\"><a href=\"#%EF%B8%8F-today-i-learned\" aria-label=\"️ today i learned permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>✍️ <strong>T</strong>oday <strong>I</strong> <strong>L</strong>earned</h2>\n<p>사내 인프라는 비교적 성능이 좋은 서버를 사용하고 있다. <del>(수평적 확장이 힘들어서.. 🥲)</del> 그렇기에 초기 인프라를 구성할 땐 리소스 부족에 허덕이진 않고있다. (다만, 요청이 급증할꺼라 예상될 때 수평적으로 확장하기는 쉽지 않다.)</p>\n<p>이러한 바탕을 토대로 온프레미스 환경에서 Docker Compose로 Blue/Green 배포 전략을 구현한 과정을 간략히 포스팅으로 남기려한다.</p>\n<br>\r\n<br>\n<h3 id=\"1-bluegreen-배포란\" style=\"position:relative;\"><a href=\"#1-bluegreen-%EB%B0%B0%ED%8F%AC%EB%9E%80\" aria-label=\"1 bluegreen 배포란 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. Blue/Green 배포란?</h3>\n<hr>\n<p>간단히 소개하자면, 여러 무중단 배포 기법 중 하나이며 두 개의 독립적인 환경 Blue(구버전) 환경과 Green(신버전) 환경을 가지고 진행되는 배포 전략이다.</p>\n<br>\n<p><img src=\"https://jh8459.s3.ap-northeast-2.amazonaws.com/blog/2025-03-16-TIL/blue_green.jpg\" alt=\"blue/green\"></p>\n<center>출처 : <a href=\"https://www.samsungsds.com/kr/insights/1256264_4627.html\" target=\"_blank\">무중단 배포 아키텍처(Zero Downtime Deployment)- 글로벌 서비스 운영의 필수 요소\r\n</a></center><br><br>\n<p>구버전이 운영되는 동안 신버전의 인스턴스를 구성한 후 로드밸런서를 통해 신버전으로 모든 트래픽을 일시에 전환하는 배포 방식이다.</p>\n<p>신버전에 문제가 생기는 경우 로드밸런서의 라우팅만 구버전으로 변경해주면 손 쉽게 롤백이 가능한 장점 또한 있지만 그 만큼 리소스를 많이 사용한다. (동일한 환경으로 같은 수의 인스턴스가 추가로 필요하다.)</p>\n<p>사용한 만큼 지불하는 서버리스 컴퓨팅 환경이라면 채택 못할거같다. 🥲</p>\n<br>\r\n<br>\n<h3 id=\"2-docker-compose\" style=\"position:relative;\"><a href=\"#2-docker-compose\" aria-label=\"2 docker compose permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2. Docker Compose</h3>\n<hr>\n<p>Docker Compose로 구성하는 컨테이너 오케스트레이션은 최소한의 복잡성으로 패키지된 컨테이너들을 쉽게 운용할 수 있고 이식성 또한 뛰어나기에 현재 사내 인프라 구조에서 사용하기 알맞는다 생각한다.</p>\n<p>이번 배포 전략 예시 또한, 여러 컨테이너들을 Docker Compose 환경으로 구성하여 적절한 Bash 스크립팅으로 <code class=\"language-text\">traefik</code> 서비스에서 라우팅을 조절하는 방법으로 Blue/Green 배포 전략을 구현하였다.</p>\n<p>우선 샘플 <code class=\"language-text\">docker-compose.yml</code> 파일을 살펴보면 다음과 같이 구성하였다. (하나하나 천천히 살펴 볼 예정이다.)</p>\n<br>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">services</span><span class=\"token punctuation\">:</span>\r\n  <span class=\"token key atrule\">traefik</span><span class=\"token punctuation\">:</span>\r\n    <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> traefik<span class=\"token punctuation\">:</span>latest\r\n    <span class=\"token key atrule\">command</span><span class=\"token punctuation\">:</span>\r\n      <span class=\"token punctuation\">-</span> <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>log.level=ERROR\r\n      <span class=\"token punctuation\">-</span> <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>providers.docker=true\r\n      <span class=\"token punctuation\">-</span> <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>providers.docker.watch=true\r\n      <span class=\"token punctuation\">-</span> <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>providers.docker.exposedbydefault=false\r\n      <span class=\"token punctuation\">-</span> <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>entrypoints.web.address=<span class=\"token punctuation\">:</span><span class=\"token number\">3000</span>\r\n      <span class=\"token punctuation\">-</span> <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>entrypoints.web.forwardedHeaders.insecure=true\r\n      <span class=\"token punctuation\">-</span> <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>providers.file.filename=/etc/traefik/dynamic<span class=\"token punctuation\">-</span>config.yml\r\n      <span class=\"token punctuation\">-</span> <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>providers.file.watch=true\r\n    <span class=\"token key atrule\">ports</span><span class=\"token punctuation\">:</span>\r\n      <span class=\"token punctuation\">-</span> <span class=\"token string\">\"3000:3000\"</span>\r\n    <span class=\"token key atrule\">restart</span><span class=\"token punctuation\">:</span> always\r\n    <span class=\"token key atrule\">volumes</span><span class=\"token punctuation\">:</span>\r\n      <span class=\"token punctuation\">-</span> /var/run/docker.sock<span class=\"token punctuation\">:</span>/var/run/docker.sock<span class=\"token punctuation\">:</span>ro\r\n      <span class=\"token punctuation\">-</span> ./dynamic<span class=\"token punctuation\">-</span>config.yml<span class=\"token punctuation\">:</span>/etc/traefik/dynamic<span class=\"token punctuation\">-</span>config.yml\r\n    <span class=\"token key atrule\">networks</span><span class=\"token punctuation\">:</span>\r\n      <span class=\"token punctuation\">-</span> net_default\r\n\r\n  <span class=\"token key atrule\">web-server-blue</span><span class=\"token punctuation\">:</span> <span class=\"token important\">&amp;web-server-template</span>\r\n    <span class=\"token key atrule\">build</span><span class=\"token punctuation\">:</span>\r\n      <span class=\"token key atrule\">context</span><span class=\"token punctuation\">:</span> .\r\n      <span class=\"token key atrule\">dockerfile</span><span class=\"token punctuation\">:</span> Dockerfile\r\n    <span class=\"token key atrule\">volumes</span><span class=\"token punctuation\">:</span>\r\n      <span class=\"token punctuation\">-</span> ./src<span class=\"token punctuation\">:</span>/myfolder/src\r\n    <span class=\"token key atrule\">env_file</span><span class=\"token punctuation\">:</span>\r\n      <span class=\"token punctuation\">-</span> ./.env\r\n    <span class=\"token key atrule\">restart</span><span class=\"token punctuation\">:</span> always\r\n    <span class=\"token key atrule\">deploy</span><span class=\"token punctuation\">:</span>\r\n      <span class=\"token key atrule\">replicas</span><span class=\"token punctuation\">:</span> <span class=\"token number\">2</span>\r\n    <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\r\n      <span class=\"token punctuation\">-</span> traefik.enable=true\r\n      <span class=\"token punctuation\">-</span> traefik.http.services.web<span class=\"token punctuation\">-</span>server<span class=\"token punctuation\">-</span>blue.loadbalancer.server.port=3000\r\n    <span class=\"token key atrule\">healthcheck</span><span class=\"token punctuation\">:</span>\r\n      <span class=\"token key atrule\">test</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'CMD'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'curl'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'-f'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'http://localhost:3000/health'</span><span class=\"token punctuation\">]</span>\r\n      <span class=\"token key atrule\">interval</span><span class=\"token punctuation\">:</span> 30s\r\n      <span class=\"token key atrule\">timeout</span><span class=\"token punctuation\">:</span> 10s\r\n      <span class=\"token key atrule\">retries</span><span class=\"token punctuation\">:</span> <span class=\"token number\">5</span>\r\n      <span class=\"token key atrule\">start_period</span><span class=\"token punctuation\">:</span> 30s\r\n    <span class=\"token key atrule\">networks</span><span class=\"token punctuation\">:</span>\r\n      <span class=\"token punctuation\">-</span> net_default\r\n\r\n  <span class=\"token key atrule\">web-server-green</span><span class=\"token punctuation\">:</span>\r\n    <span class=\"token key atrule\">&lt;&lt;</span><span class=\"token punctuation\">:</span> <span class=\"token important\">*web-server-template</span>\r\n    <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\r\n      <span class=\"token punctuation\">-</span> traefik.enable=true\r\n      <span class=\"token punctuation\">-</span> traefik.http.services.web<span class=\"token punctuation\">-</span>server<span class=\"token punctuation\">-</span>green.loadbalancer.server.port=3000\r\n\r\n<span class=\"token key atrule\">networks</span><span class=\"token punctuation\">:</span>\r\n  <span class=\"token key atrule\">net_default</span><span class=\"token punctuation\">:</span>\r\n    <span class=\"token key atrule\">driver</span><span class=\"token punctuation\">:</span> bridge</code></pre></div>\n<br>\r\n<br>\n<h4 id=\"2-1-traefik\" style=\"position:relative;\"><a href=\"#2-1-traefik\" aria-label=\"2 1 traefik permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2-1. traefik</h4>\n<hr>\n<p><code class=\"language-text\">traefik</code> 컨테이너는 로드밸런서 역할을 담당함으로써 구버전 환경과 신버전 환경에 현재 배포 요청에 알맞는 라우팅 정책을 담당할 예정이다.</p>\n<ul>\n<li><code class=\"language-text\">dynamic-config.yml</code> 파일을 제어해서 동적으로 라우팅을 변경할 예정이므로 해당 파일 볼룸을 꼭 설정해주자.</li>\n</ul>\n<br>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">traefik</span><span class=\"token punctuation\">:</span>\r\n  <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> traefik<span class=\"token punctuation\">:</span>latest\r\n  <span class=\"token key atrule\">command</span><span class=\"token punctuation\">:</span>\r\n    <span class=\"token punctuation\">-</span> <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>log.level=ERROR\r\n    <span class=\"token punctuation\">-</span> <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>providers.docker=true  <span class=\"token comment\">#Docker 컨테이너에서 실행 중인 서비스들을 자동으로 감지하도록 설정</span>\r\n    <span class=\"token punctuation\">-</span> <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>providers.docker.watch=true  <span class=\"token comment\">#Docker에서 새로운 컨테이너가 생성되거나 변경될 경우 자동으로 감지.</span>\r\n    <span class=\"token punctuation\">-</span> <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>providers.docker.exposedbydefault=false  <span class=\"token comment\">#기본적으로 모든 Docker 컨테이너를 Traefik이 라우팅하지 않도록 설정. (labels를 통해 개별적으로 노출해야 함)</span>\r\n    <span class=\"token punctuation\">-</span> <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>entrypoints.web.address=<span class=\"token punctuation\">:</span><span class=\"token number\">3000</span>\r\n    <span class=\"token punctuation\">-</span> <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>entrypoints.web.forwardedHeaders.insecure=true\r\n    <span class=\"token punctuation\">-</span> <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>providers.file.filename=/etc/traefik/dynamic<span class=\"token punctuation\">-</span>config.yml  <span class=\"token comment\">#dynamic-config.yml 파일에서 추가적인 동적 설정을 읽도록 지정.</span>\r\n    <span class=\"token punctuation\">-</span> <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>providers.file.watch=true  <span class=\"token comment\">#설정 파일(dynamic-config.yml)이 변경되면 자동으로 감지하여 적용하도록 설정.</span>\r\n  <span class=\"token key atrule\">ports</span><span class=\"token punctuation\">:</span>\r\n    <span class=\"token punctuation\">-</span> <span class=\"token string\">\"3000:3000\"</span>\r\n  <span class=\"token key atrule\">restart</span><span class=\"token punctuation\">:</span> always\r\n  <span class=\"token key atrule\">volumes</span><span class=\"token punctuation\">:</span>\r\n    <span class=\"token punctuation\">-</span> /var/run/docker.sock<span class=\"token punctuation\">:</span>/var/run/docker.sock<span class=\"token punctuation\">:</span>ro\r\n    <span class=\"token punctuation\">-</span> ./dynamic<span class=\"token punctuation\">-</span>config.yml<span class=\"token punctuation\">:</span>/etc/traefik/dynamic<span class=\"token punctuation\">-</span>config.yml\r\n  <span class=\"token key atrule\">networks</span><span class=\"token punctuation\">:</span>\r\n    <span class=\"token punctuation\">-</span> net_default</code></pre></div>\n<br>\n<p><code class=\"language-text\">docker-compose.yml</code> 파일은 컨테이너가 실행될 때만 적용되는 정적인 설정값들이다. 때문에 동적으로 변해야 하는 라우팅 대상은 현재 운영 중인 버전(Blue / Green)이 무엇인지를 확인해서 배포가 될 때마다 변환되어야 한다.</p>\n<p>동적 라우팅 변경은 <code class=\"language-text\">dynamic-config.yml</code> 파일을 Bash 스크립트에서 자동으로 생성 및 수정이 되게끔 구성하여 라우팅 정책을 제어할 예정이다.</p>\n<p>따라서 아래의 설정값이 반드시 반영되어야한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token punctuation\">-</span> <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>providers.file.filename=/etc/traefik/dynamic<span class=\"token punctuation\">-</span>config.yml  <span class=\"token comment\">#dynamic-config.yml 파일에서 추가적인 동적 설정을 읽도록 지정.</span>\r\n<span class=\"token punctuation\">-</span> <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>providers.file.watch=true  <span class=\"token comment\">#설정 파일(dynamic-config.yml)이 변경되면 자동으로 감지하여 적용하도록 설정.</span></code></pre></div>\n<br>\r\n<br>\n<h4 id=\"2-2-web-server\" style=\"position:relative;\"><a href=\"#2-2-web-server\" aria-label=\"2 2 web server permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2-2. web-server</h4>\n<hr>\n<p><code class=\"language-text\">web-server</code> 서비스들은 예시로 <code class=\"language-text\">replicas</code>를 2개로 구성해 두었다. 즉, 각각 2개의 컨테이너씩 Blue / Green 환경이 존재한다고 가정했다.</p>\n<ul>\n<li>동일한 환경으로 구성해야하므로 Blue 컨테이너를 템플릿으로 구성하여 Green 컨테이너에 사용하였다.</li>\n<li>샘플에서는 <code class=\"language-text\">Dockerfile</code>을 사용해서 Bash 스크립트에서 직접 빌드하여 배포하였지만, 이는 여러가지 방법으로 수정해도 무방하다.</li>\n</ul>\n<br>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">web-server-blue</span><span class=\"token punctuation\">:</span> <span class=\"token important\">&amp;web-server-template</span>  <span class=\"token comment\">#&amp;web-server-template을 사용하여 YAML 앵커(Anchor)로 설정을 저장. → web-server-green이 이 설정을 그대로 가져다 사용할 수 있음.</span>\r\n  <span class=\"token key atrule\">build</span><span class=\"token punctuation\">:</span>  <span class=\"token comment\">#현재 디렉토리(.)에서 Dockerfile을 사용하여 컨테이너 이미지를 빌드함. (이미지 파일을 사용해도 된다.)</span>\r\n    <span class=\"token key atrule\">context</span><span class=\"token punctuation\">:</span> .\r\n    <span class=\"token key atrule\">dockerfile</span><span class=\"token punctuation\">:</span> Dockerfile\r\n  <span class=\"token key atrule\">volumes</span><span class=\"token punctuation\">:</span>\r\n    <span class=\"token punctuation\">-</span> ./src<span class=\"token punctuation\">:</span>/myfolder/src\r\n  <span class=\"token key atrule\">env_file</span><span class=\"token punctuation\">:</span>\r\n    <span class=\"token punctuation\">-</span> ./.env\r\n  <span class=\"token key atrule\">restart</span><span class=\"token punctuation\">:</span> always\r\n  <span class=\"token key atrule\">deploy</span><span class=\"token punctuation\">:</span>\r\n    <span class=\"token key atrule\">replicas</span><span class=\"token punctuation\">:</span> <span class=\"token number\">2</span>\r\n  <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\r\n    <span class=\"token punctuation\">-</span> traefik.enable=true  <span class=\"token comment\">#이 컨테이너가 Traefik의 라우팅 대상으로 포함되도록 설정.</span>\r\n    <span class=\"token punctuation\">-</span> traefik.http.services.web<span class=\"token punctuation\">-</span>server<span class=\"token punctuation\">-</span>blue.loadbalancer.server.port=3000\r\n  <span class=\"token key atrule\">healthcheck</span><span class=\"token punctuation\">:</span>\r\n    <span class=\"token key atrule\">test</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'CMD'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'curl'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'-f'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'http://localhost:3000/health'</span><span class=\"token punctuation\">]</span>\r\n    <span class=\"token key atrule\">interval</span><span class=\"token punctuation\">:</span> 30s\r\n    <span class=\"token key atrule\">timeout</span><span class=\"token punctuation\">:</span> 10s\r\n    <span class=\"token key atrule\">retries</span><span class=\"token punctuation\">:</span> <span class=\"token number\">5</span>\r\n    <span class=\"token key atrule\">start_period</span><span class=\"token punctuation\">:</span> 30s\r\n  <span class=\"token key atrule\">networks</span><span class=\"token punctuation\">:</span>\r\n    <span class=\"token punctuation\">-</span> net_default\r\n\r\n<span class=\"token key atrule\">web-server-green</span><span class=\"token punctuation\">:</span>\r\n  <span class=\"token key atrule\">&lt;&lt;</span><span class=\"token punctuation\">:</span> <span class=\"token important\">*web-server-template</span>  <span class=\"token comment\">#web-server-green은 web-server-blue와 같은 이미지, 볼륨, 네트워크 등을 사용.</span>\r\n  <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\r\n    <span class=\"token punctuation\">-</span> traefik.enable=true\r\n    <span class=\"token punctuation\">-</span> traefik.http.services.web<span class=\"token punctuation\">-</span>server<span class=\"token punctuation\">-</span>green.loadbalancer.server.port=3000</code></pre></div>\n<br>\r\n<br>\n<h4 id=\"2-3-배포-스크립트\" style=\"position:relative;\"><a href=\"#2-3-%EB%B0%B0%ED%8F%AC-%EC%8A%A4%ED%81%AC%EB%A6%BD%ED%8A%B8\" aria-label=\"2 3 배포 스크립트 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2-3. 배포 스크립트</h4>\n<hr>\n<p>위에서 작성이 완성된 <code class=\"language-text\">docker-compose.yml</code> 파일을 <code class=\"language-text\">docker compose up --build -d</code> 명령어로 실행하면 Blue / Green 서비스마다 컨테이너가 2개씩 생성된다.</p>\n<p>이는 의도한바가 아니므로 Bash 스크립트로 현재 타겟 서비스가 무엇인지 확인하며 라우팅 대상을 변경하는 방식으로 배포가 이뤄진다.</p>\n<br>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token shebang important\">#!/bin/bash</span>\r\n<span class=\"token comment\"># 환경 변수 설정</span>\r\n<span class=\"token assign-left variable\">DYNAMIC_CONFIG</span><span class=\"token operator\">=</span><span class=\"token string\">\"dynamic-config.yml\"</span>\r\n<span class=\"token assign-left variable\">COMPOSE_FILE</span><span class=\"token operator\">=</span><span class=\"token string\">\"docker-compose.yml\"</span>\r\n<span class=\"token assign-left variable\">DOMAIN</span><span class=\"token operator\">=</span><span class=\"token string\">\"localhost\"</span>\r\n<span class=\"token assign-left variable\">SERVICE</span><span class=\"token operator\">=</span><span class=\"token string\">\"web-server\"</span>\r\n<span class=\"token assign-left variable\">BLUE_SERVICE</span><span class=\"token operator\">=</span><span class=\"token string\">\"web-server-blue\"</span>\r\n<span class=\"token assign-left variable\">GREEN_SERVICE</span><span class=\"token operator\">=</span><span class=\"token string\">\"web-server-green\"</span>\r\n<span class=\"token assign-left variable\">PORT</span><span class=\"token operator\">=</span><span class=\"token number\">3000</span>\r\n<span class=\"token assign-left variable\">REPLICAS</span><span class=\"token operator\">=</span><span class=\"token number\">2</span>\r\n\r\n<span class=\"token comment\"># 1️⃣ dynamic-config.yml 파일(동적 라우팅 담당)이 없으면 생성</span>\r\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">[</span> <span class=\"token operator\">!</span> <span class=\"token parameter variable\">-f</span> <span class=\"token string\">\"<span class=\"token variable\">$DYNAMIC_CONFIG</span>\"</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">then</span>\r\n  <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"⚠️ <span class=\"token variable\">$DYNAMIC_CONFIG</span> 파일이 존재하지 않습니다. 기본값으로 생성합니다.\"</span>\r\n  <span class=\"token function\">cat</span> <span class=\"token operator\">></span> <span class=\"token variable\">$DYNAMIC_CONFIG</span> <span class=\"token operator\">&lt;&lt;</span><span class=\"token string\">EOL\r\nhttp:\r\n  routers:\r\n    <span class=\"token variable\">$SERVICE</span>:\r\n      entryPoints:\r\n        - \"web\"\r\n      rule: \"Host(\\<span class=\"token variable\">$DOMAIN</span>\\)\"\r\n      service: \"<span class=\"token variable\">$BLUE_SERVICE</span>\"\r\n\r\n  services:\r\n    <span class=\"token variable\">$BLUE_SERVICE</span>:\r\n      loadBalancer:\r\n        servers:\r\n          - url: \"http://<span class=\"token variable\">$BLUE_SERVICE</span>:<span class=\"token variable\">$PORT</span>\"\r\n\r\n    <span class=\"token variable\">$GREEN_SERVICE</span>:\r\n      loadBalancer:\r\n        servers:\r\n          - url: \"http://<span class=\"token variable\">$GREEN_SERVICE</span>:<span class=\"token variable\">$PORT</span>\"\r\nEOL</span>\r\n  <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"✅ 기본 <span class=\"token variable\">$DYNAMIC_CONFIG</span> 파일이 생성되었습니다.\"</span>\r\n<span class=\"token keyword\">fi</span>\r\n\r\n<span class=\"token comment\"># 2️⃣ 현재 실행 중인 서비스 확인</span>\r\n<span class=\"token assign-left variable\">BLUE_RUNNING</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">docker</span> <span class=\"token function\">ps</span> <span class=\"token parameter variable\">--filter</span> <span class=\"token string\">\"name=<span class=\"token variable\">$BLUE_SERVICE</span>\"</span> <span class=\"token parameter variable\">--format</span> <span class=\"token string\">\"{{.Names}}\"</span> <span class=\"token operator\">|</span> <span class=\"token function\">wc</span> <span class=\"token parameter variable\">-l</span><span class=\"token variable\">)</span></span>\r\n<span class=\"token assign-left variable\">GREEN_RUNNING</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">docker</span> <span class=\"token function\">ps</span> <span class=\"token parameter variable\">--filter</span> <span class=\"token string\">\"name=<span class=\"token variable\">$GREEN_SERVICE</span>\"</span> <span class=\"token parameter variable\">--format</span> <span class=\"token string\">\"{{.Names}}\"</span> <span class=\"token operator\">|</span> <span class=\"token function\">wc</span> <span class=\"token parameter variable\">-l</span><span class=\"token variable\">)</span></span>\r\n\r\n<span class=\"token assign-left variable\">FIRST_DEPLOY</span><span class=\"token operator\">=</span>false\r\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">[</span> <span class=\"token string\">\"<span class=\"token variable\">$BLUE_RUNNING</span>\"</span> <span class=\"token parameter variable\">-eq</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">]</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">[</span> <span class=\"token string\">\"<span class=\"token variable\">$GREEN_RUNNING</span>\"</span> <span class=\"token parameter variable\">-eq</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">then</span>\r\n  <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"🆕 최초 배포입니다. Blue 서비스부터 시작합니다.\"</span>\r\n  <span class=\"token assign-left variable\">TARGET_SERVICE</span><span class=\"token operator\">=</span><span class=\"token variable\">$BLUE_SERVICE</span>\r\n  <span class=\"token assign-left variable\">OLD_SERVICE</span><span class=\"token operator\">=</span><span class=\"token string\">\"\"</span>\r\n  <span class=\"token assign-left variable\">FIRST_DEPLOY</span><span class=\"token operator\">=</span>true\r\n<span class=\"token keyword\">else</span>\r\n  <span class=\"token comment\"># 3️⃣ dynamic-config.yml에서 OLD_SERVICE 가져오기</span>\r\n  <span class=\"token assign-left variable\">OLD_SERVICE</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">grep</span> <span class=\"token string\">\"service:\"</span> $DYNAMIC_CONFIG <span class=\"token operator\">|</span> <span class=\"token function\">awk</span> -F<span class=\"token string\">'\"'</span> <span class=\"token string\">'{print $2}'</span><span class=\"token variable\">)</span></span>\r\n\r\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">[</span> <span class=\"token parameter variable\">-z</span> <span class=\"token string\">\"<span class=\"token variable\">$OLD_SERVICE</span>\"</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">then</span>\r\n    <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"❌ 현재 라우팅된 서비스 정보를 가져오지 못했습니다. 배포를 중단합니다.\"</span>\r\n    <span class=\"token builtin class-name\">exit</span> <span class=\"token number\">1</span>\r\n  <span class=\"token keyword\">fi</span>\r\n\r\n  <span class=\"token comment\"># 4️⃣ 현재 실행 중인 컨테이너 확인하여 OLD_SERVICE가 아닌 컨테이너 찾기</span>\r\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">[</span> <span class=\"token string\">\"<span class=\"token variable\">$OLD_SERVICE</span>\"</span> <span class=\"token operator\">==</span> <span class=\"token string\">\"<span class=\"token variable\">$BLUE_SERVICE</span>\"</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">then</span>\r\n    <span class=\"token assign-left variable\">TARGET_SERVICE</span><span class=\"token operator\">=</span><span class=\"token variable\">$GREEN_SERVICE</span>\r\n  <span class=\"token keyword\">else</span>\r\n    <span class=\"token assign-left variable\">TARGET_SERVICE</span><span class=\"token operator\">=</span><span class=\"token variable\">$BLUE_SERVICE</span>\r\n  <span class=\"token keyword\">fi</span>\r\n\r\n  <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"🔄 현재 라우팅된 서비스: <span class=\"token variable\">$OLD_SERVICE</span>\"</span>\r\n  <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"🚀 새로운 배포 대상 서비스: <span class=\"token variable\">$TARGET_SERVICE</span>\"</span>\r\n<span class=\"token keyword\">fi</span>\r\n\r\n<span class=\"token comment\"># 5️⃣ 새로운 서비스 빌드</span>\r\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"🚀 Building the new version of the service: <span class=\"token variable\">$TARGET_SERVICE</span>...\"</span>\r\n<span class=\"token function\">docker</span> compose <span class=\"token parameter variable\">-f</span> <span class=\"token variable\">$COMPOSE_FILE</span> build <span class=\"token variable\">$TARGET_SERVICE</span>\r\n\r\n<span class=\"token comment\"># 6️⃣ 새로운 컨테이너 실행</span>\r\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"🚀 Deploying new service: <span class=\"token variable\">$TARGET_SERVICE</span> with <span class=\"token variable\">$REPLICAS</span> replicas...\"</span>\r\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">[</span> <span class=\"token string\">\"<span class=\"token variable\">$FIRST_DEPLOY</span>\"</span> <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">then</span>\r\n  <span class=\"token function\">docker</span> compose <span class=\"token parameter variable\">-f</span> <span class=\"token variable\">$COMPOSE_FILE</span> up <span class=\"token parameter variable\">-d</span> <span class=\"token parameter variable\">--scale</span> <span class=\"token variable\">$BLUE_SERVICE</span><span class=\"token operator\">=</span><span class=\"token variable\">$REPLICAS</span> <span class=\"token parameter variable\">--scale</span> <span class=\"token variable\">$GREEN_SERVICE</span><span class=\"token operator\">=</span><span class=\"token number\">0</span>\r\n<span class=\"token keyword\">else</span>\r\n  <span class=\"token function\">docker</span> compose <span class=\"token parameter variable\">-f</span> <span class=\"token variable\">$COMPOSE_FILE</span> up <span class=\"token parameter variable\">-d</span> <span class=\"token parameter variable\">--scale</span> <span class=\"token variable\">$TARGET_SERVICE</span><span class=\"token operator\">=</span><span class=\"token variable\">$REPLICAS</span>\r\n<span class=\"token keyword\">fi</span>\r\n\r\n<span class=\"token comment\"># 7️⃣ 새로운 서비스 Health Check</span>\r\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"🛠️ Checking health status of <span class=\"token variable\">$TARGET_SERVICE</span>...\"</span>\r\n<span class=\"token function\">sleep</span> <span class=\"token number\">10</span>  <span class=\"token comment\"># 안정화 시간</span>\r\n\r\n<span class=\"token keyword\">for</span> <span class=\"token for-or-select variable\">i</span> <span class=\"token keyword\">in</span> <span class=\"token punctuation\">{</span><span class=\"token number\">1</span><span class=\"token punctuation\">..</span><span class=\"token number\">12</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">do</span>\r\n  <span class=\"token assign-left variable\">HEALTHY_COUNT</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">docker</span> <span class=\"token function\">ps</span> <span class=\"token parameter variable\">--filter</span> <span class=\"token string\">\"name=<span class=\"token variable\">$TARGET_SERVICE</span>\"</span> <span class=\"token parameter variable\">--filter</span> <span class=\"token string\">\"health=healthy\"</span> <span class=\"token parameter variable\">--format</span> <span class=\"token string\">\"{{.Names}}\"</span> <span class=\"token operator\">|</span> <span class=\"token function\">wc</span> <span class=\"token parameter variable\">-l</span><span class=\"token variable\">)</span></span>\r\n\r\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">[</span> <span class=\"token string\">\"<span class=\"token variable\">$HEALTHY_COUNT</span>\"</span> <span class=\"token parameter variable\">-gt</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">then</span>\r\n    <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"✅ New service <span class=\"token variable\">$TARGET_SERVICE</span> is healthy!\"</span>\r\n    <span class=\"token builtin class-name\">break</span>\r\n  <span class=\"token keyword\">fi</span>\r\n\r\n  <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"⏳ Waiting for <span class=\"token variable\">$TARGET_SERVICE</span> to be healthy... (<span class=\"token variable\">$i</span>/12)\"</span>\r\n  <span class=\"token function\">sleep</span> <span class=\"token number\">10</span>\r\n<span class=\"token keyword\">done</span>\r\n\r\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">[</span> <span class=\"token string\">\"<span class=\"token variable\">$HEALTHY_COUNT</span>\"</span> <span class=\"token parameter variable\">-eq</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">then</span>\r\n  <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"❌ New service <span class=\"token variable\">$TARGET_SERVICE</span> failed to start properly. Rolling back...\"</span>\r\n  <span class=\"token function\">docker</span> compose <span class=\"token parameter variable\">-f</span> <span class=\"token variable\">$COMPOSE_FILE</span> down <span class=\"token variable\">$TARGET_SERVICE</span>\r\n  <span class=\"token builtin class-name\">exit</span> <span class=\"token number\">1</span>\r\n<span class=\"token keyword\">fi</span>\r\n\r\n<span class=\"token comment\"># 8️⃣ `dynamic-config.yml` 업데이트 (새로운 서비스로 라우팅 변경)</span>\r\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"🔄 Updating dynamic-config.yml to point to <span class=\"token variable\">$TARGET_SERVICE</span>...\"</span>\r\n<span class=\"token function\">cat</span> <span class=\"token operator\">></span> <span class=\"token variable\">$DYNAMIC_CONFIG</span> <span class=\"token operator\">&lt;&lt;</span><span class=\"token string\">EOL\r\nhttp:\r\n  routers:\r\n    <span class=\"token variable\">$SERVICE</span>:\r\n      entryPoints:\r\n        - \"web\"\r\n      rule: \"Host(\\<span class=\"token variable\"><span class=\"token variable\">`</span>$DOMAIN<span class=\"token punctuation\">\\</span><span class=\"token variable\">`</span></span>)\"\r\n      service: \"<span class=\"token variable\">$TARGET_SERVICE</span>\"\r\n\r\n  services:\r\n    <span class=\"token variable\">$BLUE_SERVICE</span>:\r\n      loadBalancer:\r\n        servers:\r\n          - url: \"http://<span class=\"token variable\">$BLUE_SERVICE</span>:<span class=\"token variable\">$PORT</span>\"\r\n\r\n    <span class=\"token variable\">$GREEN_SERVICE</span>:\r\n      loadBalancer:\r\n        servers:\r\n          - url: \"http://<span class=\"token variable\">$GREEN_SERVICE</span>:<span class=\"token variable\">$PORT</span>\"\r\nEOL</span>\r\n\r\n<span class=\"token comment\"># 9️⃣ Traefik이 설정을 자동 감지하도록 트리거</span>\r\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"♻️ Triggering Traefik reload...\"</span>\r\n<span class=\"token function\">touch</span> <span class=\"token variable\">$DYNAMIC_CONFIG</span>\r\n\r\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"🎉 Deployment complete!\"</span></code></pre></div>\n<br>\n<p>각각 프로젝트마다 고유한 값들은 환경 변수로 만들어 두었으며 스크립트를 간단히 설명하자면 아래의 순서대로 스크립트가 실행되며 Blue / Green 배포가 진행된다.</p>\n<ol>\n<li>스크립트가 실행된 디렉토리에 <code class=\"language-text\">dynamic-config.yml</code> 파일이 존재하는지 감지하고 없다면 기본 라우팅 정책(Blue 환경 우선 라우팅)을 담은 파일을 생성한다.</li>\n<li>현재 실행 중인 Blue / Green 컨테이너들을 확인 후 최초 배포가 이뤄지는 경우인지 확인한다.</li>\n<li>최초 배포가 진행되는 경우라면 Blue 환경으로 배포를 진행한다. (Green 환경은 배포하지 않는다.)</li>\n<li>최초 배포가 진행되는 경우가 아니라면 운영 중인 <code class=\"language-text\">dynamic-config.yml</code> 파일을 확인하여 현재 라우팅 중인 컨테이너(OLD_SERVICE) 정보를 가져온다.</li>\n<li>새로운 서비스를 빌드한다.</li>\n<li>빌드된 이미지로 새로운 컨테이너(TARGET_SERVICE)를 실행한다.</li>\n<li>새로운 컨테이너의 Health Check를 기다린다. (실패시 TARGET_SERVICE 컨테이너를 삭제 후 스크립트를 종료)</li>\n<li><code class=\"language-text\">dynamic-config.yml</code>의 라우팅 대상을 업데이트 한다. (OLD_SERVICE → TARGET_SERVICE)</li>\n<li>설정 파일의 변경을 자동으로 감지할 수 있도록 <code class=\"language-text\">dynamic-config.yml</code> 파일을 수정한다.</li>\n</ol>\n<br>\r\n<br>\n<p>위 순서대로 동작하므로 신버전(TARGET_SERVICE)이 배포되고 안정화 되는 동안 구버전(OLD_SERVICE)이 트래픽을 받을 수 있으므로 무중단 배포가 가능하며, Blue / Green 환경이 모두 공존하므로 손 쉽게 롤백 또한 가능하다.</p>\n<br>\r\n<br>\n<h4 id=\"2-4-라우팅-정책-변경-스크립트\" style=\"position:relative;\"><a href=\"#2-4-%EB%9D%BC%EC%9A%B0%ED%8C%85-%EC%A0%95%EC%B1%85-%EB%B3%80%EA%B2%BD-%EC%8A%A4%ED%81%AC%EB%A6%BD%ED%8A%B8\" aria-label=\"2 4 라우팅 정책 변경 스크립트 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2-4. 라우팅 정책 변경 스크립트</h4>\n<hr>\n<p>신버전(TARGET_SERVICE)이 새로 배포가 되었다면, 구버전(OLD_SERVICE) 환경은 더이상 트래픽을 받지 못하는 유휴 컨테이너들로 존재한다.</p>\n<p>이 경우에 새로 배포한 환경에서 문제가 발생했다면 구버전(OLD_SERVICE) 환경으로 라우팅 정책만 변경하면 손 쉽게 롤백이 가능하다.</p>\n<br>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token shebang important\">#!/bin/bash</span>\r\n<span class=\"token comment\"># 환경 변수 설정</span>\r\n<span class=\"token assign-left variable\">DYNAMIC_CONFIG</span><span class=\"token operator\">=</span><span class=\"token string\">\"dynamic-config.yml\"</span>\r\n<span class=\"token assign-left variable\">COMPOSE_FILE</span><span class=\"token operator\">=</span><span class=\"token string\">\"docker-compose.yml\"</span>\r\n<span class=\"token assign-left variable\">DOMAIN</span><span class=\"token operator\">=</span><span class=\"token string\">\"localhost\"</span>\r\n<span class=\"token assign-left variable\">SERVICE</span><span class=\"token operator\">=</span><span class=\"token string\">\"web-server\"</span>\r\n<span class=\"token assign-left variable\">BLUE_SERVICE</span><span class=\"token operator\">=</span><span class=\"token string\">\"web-server-blue\"</span>\r\n<span class=\"token assign-left variable\">GREEN_SERVICE</span><span class=\"token operator\">=</span><span class=\"token string\">\"web-server-green\"</span>\r\n<span class=\"token assign-left variable\">PORT</span><span class=\"token operator\">=</span><span class=\"token number\">3000</span>\r\n\r\n<span class=\"token comment\"># 1️⃣ 현재 실행 중인 서비스 확인</span>\r\n<span class=\"token assign-left variable\">BLUE_RUNNING</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">docker</span> <span class=\"token function\">ps</span> <span class=\"token parameter variable\">--filter</span> <span class=\"token string\">\"name=<span class=\"token variable\">$BLUE_SERVICE</span>\"</span> <span class=\"token parameter variable\">--format</span> <span class=\"token string\">\"{{.Names}}\"</span> <span class=\"token operator\">|</span> <span class=\"token function\">wc</span> <span class=\"token parameter variable\">-l</span><span class=\"token variable\">)</span></span>\r\n<span class=\"token assign-left variable\">GREEN_RUNNING</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">docker</span> <span class=\"token function\">ps</span> <span class=\"token parameter variable\">--filter</span> <span class=\"token string\">\"name=<span class=\"token variable\">$GREEN_SERVICE</span>\"</span> <span class=\"token parameter variable\">--format</span> <span class=\"token string\">\"{{.Names}}\"</span> <span class=\"token operator\">|</span> <span class=\"token function\">wc</span> <span class=\"token parameter variable\">-l</span><span class=\"token variable\">)</span></span>\r\n\r\n<span class=\"token comment\"># 둘 다 실행 중이어야 라우팅 정책 변경 가능 (둘 중 하나라도 꺼져 있으면 종료)</span>\r\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">[</span> <span class=\"token string\">\"<span class=\"token variable\">$BLUE_RUNNING</span>\"</span> <span class=\"token parameter variable\">-eq</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">]</span> <span class=\"token operator\">||</span> <span class=\"token punctuation\">[</span> <span class=\"token string\">\"<span class=\"token variable\">$GREEN_RUNNING</span>\"</span> <span class=\"token parameter variable\">-eq</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">then</span>\r\n  <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"❌ Blue와 Green 중 하나라도 실행되지 않으면 라우팅을 변경할 수 없습니다.\"</span>\r\n  <span class=\"token builtin class-name\">exit</span> <span class=\"token number\">1</span>\r\n<span class=\"token keyword\">fi</span>\r\n\r\n<span class=\"token comment\"># 2️⃣ 현재 dynamic-config.yml에서 OLD_SERVICE 가져오기</span>\r\n<span class=\"token assign-left variable\">OLD_SERVICE</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">grep</span> <span class=\"token string\">\"service:\"</span> $DYNAMIC_CONFIG <span class=\"token operator\">|</span> <span class=\"token function\">awk</span> -F<span class=\"token string\">'\"'</span> <span class=\"token string\">'{print $2}'</span><span class=\"token variable\">)</span></span>\r\n\r\n<span class=\"token comment\"># OLD_SERVICE가 설정되지 않았다면 오류 처리</span>\r\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">[</span> <span class=\"token parameter variable\">-z</span> <span class=\"token string\">\"<span class=\"token variable\">$OLD_SERVICE</span>\"</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">then</span>\r\n  <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"❌ 현재 라우팅된 서비스 정보를 가져오지 못했습니다. 라우팅 변경을 중단합니다.\"</span>\r\n  <span class=\"token builtin class-name\">exit</span> <span class=\"token number\">1</span>\r\n<span class=\"token keyword\">fi</span>\r\n\r\n<span class=\"token comment\"># 3️⃣ OLD_SERVICE가 Blue인지 Green인지 확인하고 반대 서비스로 전환</span>\r\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">[</span> <span class=\"token string\">\"<span class=\"token variable\">$OLD_SERVICE</span>\"</span> <span class=\"token operator\">==</span> <span class=\"token string\">\"<span class=\"token variable\">$BLUE_SERVICE</span>\"</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">then</span>\r\n  <span class=\"token assign-left variable\">TARGET_SERVICE</span><span class=\"token operator\">=</span><span class=\"token variable\">$GREEN_SERVICE</span>\r\n<span class=\"token keyword\">else</span>\r\n  <span class=\"token assign-left variable\">TARGET_SERVICE</span><span class=\"token operator\">=</span><span class=\"token variable\">$BLUE_SERVICE</span>\r\n<span class=\"token keyword\">fi</span>\r\n\r\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"🔄 현재 운영 중인 서비스: <span class=\"token variable\">$OLD_SERVICE</span>\"</span>\r\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"🚀 새로운 라우팅 대상 서비스: <span class=\"token variable\">$TARGET_SERVICE</span>\"</span>\r\n\r\n<span class=\"token comment\"># 4️⃣ `dynamic-config.yml` 업데이트 (새로운 서비스로 라우팅 변경)</span>\r\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"🔄 Updating dynamic-config.yml to roll back to <span class=\"token variable\">$TARGET_SERVICE</span>...\"</span>\r\n<span class=\"token function\">cat</span> <span class=\"token operator\">></span> <span class=\"token variable\">$DYNAMIC_CONFIG</span> <span class=\"token operator\">&lt;&lt;</span><span class=\"token string\">EOL\r\nhttp:\r\n  routers:\r\n    <span class=\"token variable\">$SERVICE</span>:\r\n      entryPoints:\r\n        - \"web\"\r\n      rule: \"Host(\\<span class=\"token variable\"><span class=\"token variable\">`</span>$DOMAIN<span class=\"token punctuation\">\\</span><span class=\"token variable\">`</span></span>)\"\r\n      service: \"<span class=\"token variable\">$TARGET_SERVICE</span>\"\r\n\r\n  services:\r\n    <span class=\"token variable\">$BLUE_SERVICE</span>:\r\n      loadBalancer:\r\n        servers:\r\n          - url: \"http://<span class=\"token variable\">$BLUE_SERVICE</span>:<span class=\"token variable\">$PORT</span>\"\r\n\r\n    <span class=\"token variable\">$GREEN_SERVICE</span>:\r\n      loadBalancer:\r\n        servers:\r\n          - url: \"http://<span class=\"token variable\">$GREEN_SERVICE</span>:<span class=\"token variable\">$PORT</span>\"\r\nEOL</span>\r\n\r\n<span class=\"token comment\"># 5️⃣ Traefik이 설정을 자동 감지하도록 트리거</span>\r\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"♻️ Triggering Traefik reload...\"</span>\r\n<span class=\"token function\">touch</span> <span class=\"token variable\">$DYNAMIC_CONFIG</span>\r\n\r\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"🎉 Rollback complete! Traffic is now routed to <span class=\"token variable\">$TARGET_SERVICE</span>.\"</span></code></pre></div>\n<br>\r\n<br>\n<h3 id=\"3-어려웠던-점\" style=\"position:relative;\"><a href=\"#3-%EC%96%B4%EB%A0%A4%EC%9B%A0%EB%8D%98-%EC%A0%90\" aria-label=\"3 어려웠던 점 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3. 어려웠던 점</h3>\n<hr>\n<p>가장 많이 기술적으로 시간을 할애한 부분은 Blue 환경이 운영중에 Green 환경 추가로 컨테이너로 배포하면 <code class=\"language-text\">traefik</code>이 자동으로 Green 환경까지 인식하여 트래픽을 보내는 상황을 개선하는 부분이었다.</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token punctuation\">-</span> <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>providers.docker=true  <span class=\"token comment\">#Docker 컨테이너에서 실행 중인 서비스들을 자동으로 감지하도록 설정</span>\r\n<span class=\"token punctuation\">-</span> <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>providers.docker.watch=true  <span class=\"token comment\">#Docker에서 새로운 컨테이너가 생성되거나 변경될 경우 자동으로 감지.</span></code></pre></div>\n<p><code class=\"language-text\">traefik</code> 컨테이너의 위 두 설정은 반드시 필요하지만 그렇기에 Blue / Green 환경을 독립적인 환경으로 각각 분리하기가 어렵게하는 요인 중 하나였다. 🥲</p>\n<br>\n<p>최종적으로는 컨테이너마다 Blue / Green 라벨을 부여해서 라우팅을 동적으로 할당하는 방법을 채택하여 사용하였지만, 그 과정이 순탄하지는 않았다.</p>\n<ul>\n<li><strong>TARGET_SERVICE</strong>로 전달되는 트래픽을 차단 하기 위해 Docker Network를 임시로 연결을 끊는다. → 외부 DB 연결이 끊기며 ORM에서 DB 연결 초기화가 되지 않는 이슈가 발생하며 Health Check를 통과하지 못한다. 😅</li>\n<li><strong>TARGET_SERVICE</strong>가 새로 배포 후 Health Check를 통과하면 <strong>OLD_SERVICE</strong>를 바로 제거한다. → 수 초 내외로 두 서비스가 공존하는 순간이 발생할 수 밖에 없으며, 이상적인 Blue / Green 배포 전략과는 거리가 멀다. 😅</li>\n</ul>\n<br>\n<p>생각나는대로 적어보니 위와 같은 경우들이 생각이 난다.</p>\n<br>\r\n<br>\n<h2 id=\"-understanding\" style=\"position:relative;\"><a href=\"#-understanding\" aria-label=\" understanding permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>🤔 Understanding</h2>\n<p>사실 실제로 가장 많은 시간을 할애한 부분은 기술 검증이었다.</p>\n<ul>\n<li>유휴 컨테이너들로 인해 리소스 낭비가 발생할 수 밖에 없는데 이는 얼마나 큰 영향을 미치는가?</li>\n<li>기존에 배포하는 방식(Recreated)에 비해 어떤점이 얼마나 개선하는지에 대한 정량적인 수치화</li>\n<li>배포 실패시 플랜B 계획</li>\n</ul>\n<p>이 외에 무중단 배포를 활용할 수 있는 파이프라인 (Hotfix) 추가 등등.. 개발 외적인 부분들에서 더욱 더 시간과 신경을 많이 썼던거 같다.</p>\n<br>\r\n<br>","excerpt":"✍️ Today I Learned 사내 인프라는 비교적 성능이 좋은 서버를 사용하고 있다. (수평적 확장이 힘들어서.. 🥲) 그렇기에 초기 인프라를 구성할 땐 리소스 부족에 허덕이진 않고있다. (다만, 요청이 급증할꺼라 예상될 때 수평적으로 확장하기는 쉽지 않다.) 이러한 바탕을 토대로 온프레미스 환경에서 Docker Compose로 Blue/Green 배포 전략을 구현한 과정을 간략히 포스팅으로 남기려한다. 1. Blue/Green 배포란? 간단히 소개하자면, 여러 무중단 배포 기법 중 하나이며 두 개의 독립적인 환경 Blue(구버전) 환경과 Green(신버전) 환경을 가지고 진행되는 배포 전략이다. blue/green 구버전이 운영되는 동안 신버전의 인스턴스를 구성한 후 로드밸런서를 통해 신버전으로 모든 트래픽을 일시에 전환하는 배포 방식이다. 신버전에 문제가 생기는 경우 로드밸런서의 라우팅만 구버전으로 변경해주면 손 쉽게 롤백이 가능한 장점 또한 있지만 그 만큼 리소스를 많이 …","timeToRead":8,"tableOfContents":"<ul>\n<li>\n<p><a href=\"#%EF%B8%8F-today-i-learned\">✍️ <strong>T</strong>oday <strong>I</strong> <strong>L</strong>earned</a></p>\n<ul>\n<li>\n<p><a href=\"#1-bluegreen-%EB%B0%B0%ED%8F%AC%EB%9E%80\">1. Blue/Green 배포란?</a></p>\n</li>\n<li>\n<p><a href=\"#2-docker-compose\">2. Docker Compose</a></p>\n<ul>\n<li><a href=\"#2-1-traefik\">2-1. traefik</a></li>\n<li><a href=\"#2-2-web-server\">2-2. web-server</a></li>\n<li><a href=\"#2-3-%EB%B0%B0%ED%8F%AC-%EC%8A%A4%ED%81%AC%EB%A6%BD%ED%8A%B8\">2-3. 배포 스크립트</a></li>\n<li><a href=\"#2-4-%EB%9D%BC%EC%9A%B0%ED%8C%85-%EC%A0%95%EC%B1%85-%EB%B3%80%EA%B2%BD-%EC%8A%A4%ED%81%AC%EB%A6%BD%ED%8A%B8\">2-4. 라우팅 정책 변경 스크립트</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#3-%EC%96%B4%EB%A0%A4%EC%9B%A0%EB%8D%98-%EC%A0%90\">3. 어려웠던 점</a></p>\n</li>\n</ul>\n</li>\n<li>\n<p><a href=\"#-understanding\">🤔 Understanding</a></p>\n</li>\n</ul>","frontmatter":{"date":"2025.03.16","title":"Docker Compose와 Traefik을 활용한 Blue/Green 배포 전략","categories":"TIL","author":"JH8459","emoji":"📚"},"fields":{"slug":"/2025-03-16-TIL/"}},"next":{"id":"167d23d4-8f42-5908-bf81-be67083c9ef8","frontmatter":{"date":"2025.03.13","title":"프로그래머스 - 조이스틱 (JS)","categories":"TIL","author":"JH8459","emoji":"📚"},"fields":{"slug":"/2025-03-13-TIL/"}},"prev":{"id":"45a5dca2-a8e0-5043-b4f4-936e507bb529","frontmatter":{"date":"2025.03.19","title":"Nest CLI 뜯어보기 (nest start)","categories":"TIL","author":"JH8459","emoji":"📚"},"fields":{"slug":"/2025-03-19-TIL/"}},"site":{"siteMetadata":{"comments":{"giscus":{"repo":"JH8459/JH8459.github.io","repoId":"R_kgDOI03HgA","category":"Comments","categoryId":"DIC_kwDOI03HgM4CtuXL"}}}}},"pageContext":{"slug":"/2025-03-16-TIL/","nextSlug":"/2025-03-13-TIL/","prevSlug":"/2025-03-19-TIL/"}},"staticQueryHashes":["1073350324","2009502679","2938748437","962130685"],"slicesMap":{}}