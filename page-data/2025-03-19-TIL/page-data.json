{"componentChunkName":"component---src-templates-blog-template-js","path":"/2025-03-19-TIL/","result":{"data":{"cur":{"id":"53e1d582-9345-5f06-aa93-b8447eb29772","html":"<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 56.666666666666664%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAALABQDASIAAhEBAxEB/8QAFwAAAwEAAAAAAAAAAAAAAAAAAAECA//EABUBAQEAAAAAAAAAAAAAAAAAAAAF/9oADAMBAAIQAxAAAAHSaSawD//EABYQAAMAAAAAAAAAAAAAAAAAAAABIP/aAAgBAQABBQIU/wD/xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/AT//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/AT//xAAWEAADAAAAAAAAAAAAAAAAAAAAIDH/2gAIAQEABj8CIv8A/8QAGBAAAgMAAAAAAAAAAAAAAAAAAAERIDH/2gAIAQEAAT8hGb2Ff//aAAwDAQACAAMAAAAQHD//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/ED//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/ED//xAAZEAACAwEAAAAAAAAAAAAAAAABEQAgQVH/2gAIAQEAAT8QjVhju1//2Q=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"github-blog.png\"\n        title=\"github-blog.png\"\n        src=\"/static/7c4bbfe7d1a9d6bc02891c94bfe039dc/80e3c/TIL.jpg\"\n        srcset=\"/static/7c4bbfe7d1a9d6bc02891c94bfe039dc/4ec73/TIL.jpg 180w,\n/static/7c4bbfe7d1a9d6bc02891c94bfe039dc/158ba/TIL.jpg 360w,\n/static/7c4bbfe7d1a9d6bc02891c94bfe039dc/80e3c/TIL.jpg 720w,\n/static/7c4bbfe7d1a9d6bc02891c94bfe039dc/47311/TIL.jpg 1080w,\n/static/7c4bbfe7d1a9d6bc02891c94bfe039dc/ac614/TIL.jpg 1272w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<br>\n<h2 id=\"️-today-i-learned\" style=\"position:relative;\"><a href=\"#%EF%B8%8F-today-i-learned\" aria-label=\"️ today i learned permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>✍️ <strong>T</strong>oday <strong>I</strong> <strong>L</strong>earned</h2>\n<p><code class=\"language-text\">Docker</code> 파일을 작성할 때 습관처럼 큰 의심없이 아래와 같이 작성하곤한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token punctuation\">...</span>\n<span class=\"token comment\"># 3단계: 빌드</span>\nRUN npm run build\n\nCMD <span class=\"token punctuation\">[</span><span class=\"token string\">\"node\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"./dist/main.js\"</span><span class=\"token punctuation\">]</span></code></pre></div>\n<p><code class=\"language-text\">package.json</code>에 별다른 설정을 안해두었다면 아래와 같을꺼라 <strong>npm run start:prod</strong> 명령과 같은 명령어이지만 습관(?)처럼 <code class=\"language-text\">Dockerfile</code>을 작성할 땐 “./dist/main.js”를 직접 실행시키고 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token property\">\"scripts\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n  ...\n  <span class=\"token property\">\"start:prod\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"node dist/main\"</span><span class=\"token punctuation\">,</span>\n  ...</code></pre></div>\n<br>\n<br>\n<p>프레임워크에서 기본으로 제공하는 <strong>nest start</strong> CLI 명령어 또한 서버를 구동시키는 명령어인데, 빌드된 .js 파일을 직접 실행시키는 것과 어떤 차이가 있을지 궁금해서 찾아본 결과를 간략히 남기려한다.</p>\n<br>\n<br>\n<h3 id=\"1-눈에-띄는-차이점은\" style=\"position:relative;\"><a href=\"#1-%EB%88%88%EC%97%90-%EB%9D%84%EB%8A%94-%EC%B0%A8%EC%9D%B4%EC%A0%90%EC%9D%80\" aria-label=\"1 눈에 띄는 차이점은 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. 눈에 띄는 차이점은?</h3>\n<hr>\n<p>사실 입사 초기에 로컬 환경에서 쓰던 <code class=\"language-text\">Docker</code> 파일이 그대로 운영 환경<del>(심지어 —watch 옵션까지)</del>까지 이어진 경험이 있어서 Nest CLI 명령어는 어떤 사이드 이펙트를 발생시키는지 이미 몸소 체험해본적이 있다. 🥲</p>\n<p>간단히 같은 코드 베이스로 Nest CLI 명령어와 빌드된 .js 파일을 직접 실행한 환경으로 나누어서 컨테이너를 실행해보면 아래와 같이 눈으로도 확인이 가능할만한 차이점을 보이는 결과를 얻을 수 있다.</p>\n<br>\n<img src=\"https://jh8459.s3.ap-northeast-2.amazonaws.com/blog/2025-03-19-TIL/Initial.png\">\n<center>Nest CLI로 \"nest start\"로 실행한 컨테이너는 초기화 과정에서 CPU 점유율도 엄청나다 😲</center><br><br>\n<br>\n<img src=\"https://jh8459.s3.ap-northeast-2.amazonaws.com/blog/2025-03-19-TIL/Stabilization.png\">\n<center>초기화 과정 이후에도 메모리 점유율이 2배가 넘게 차이가 난다.</center><br><br>\n<p>유의미한 성능 차이가 존재한다는 점은 알고 있었으나 생각했었던 수치보다 더 크게 벌어진걸 눈으로 직접보니 놀라웠다.</p>\n<br>\n<br>\n<h3 id=\"2-nest-cli\" style=\"position:relative;\"><a href=\"#2-nest-cli\" aria-label=\"2 nest cli permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2. Nest CLI</h3>\n<hr>\n<p>왜 이런 큰 성능 차이를 보이는지는 Nest CLI의 actions에 정의된 <code class=\"language-text\">start.action.ts</code> 파일을 뜯어보면 알 수 있다.</p>\n<blockquote>\n<p><a href=\"https://github.com/nestjs/nest-cli/blob/c152351bba98b0562958b0d0223b7636c0183cb3/actions/start.action.ts#L17\" target=\"_blank\">nest-cli/actions/start.action.ts</a></p>\n</blockquote>\n<br>\n<br>\n<p>Nest CLI 명령으로 실행한 어플리케이션의 성능 저하 포인트들을 요약하자면 아래와 같다.</p>\n<ol>\n<li>\n<p>NestJS 설정 파일 로드</p>\n<ul>\n<li>\n<p><strong>commandOptions</strong>에서 config 옵션을 찾고, 이를 기반으로 <strong>this.loader.load(configFileName)</strong>을 호출하여 <code class=\"language-text\">nestjs-cli.json</code> 파일을 로드한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"$schema\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"https://json.schemastore.org/nest-cli\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"collection\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"@nestjs/schematics\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"sourceRoot\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"src\"</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n</li>\n</ul>\n</li>\n<li>\n<p>TS 컴파일러 설정 로드</p>\n<ul>\n<li>\n<p><strong>getTscConfigPath()</strong>를 통해 <code class=\"language-text\">tsconfig.json</code> 경로를 찾고, JSON 값을 파싱한 결과 중 outDir 값을 가져온다.</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"compilerOptions\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"module\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"commonjs\"</span><span class=\"token punctuation\">,</span>\n    ...\n    <span class=\"token property\">\"outDir\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"./dist\"</span><span class=\"token punctuation\">,</span>\n    ...\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n</li>\n</ul>\n</li>\n<li>\n<p>빌드 및 실행</p>\n<ul>\n<li>\n<p><strong>BuildAction.runBuild()</strong>가 실행되며 TypeScript를 빌드한다.</p>\n</li>\n<li>\n<p>빌드 후 <strong>createOnSuccessHook()</strong>이 실행되며 애플리케이션이 실행된다.</p>\n<ul>\n<li><strong>spawnChildProcess()</strong>를 통해 <strong>child_process.spawn()</strong>을 사용하여 새로운 프로세스로 감싸서 애플리케이션을 실행한다.</li>\n</ul>\n</li>\n</ul>\n</li>\n</ol>\n<br>\n<br>\n<p>즉, Nest CLI 명령어로 애플리케이션을 실행하면 여러 설정 파일들을 로드하며 새로이 빌드한 결과물을 새로운 프로세서로 감싸서 실행하고 있는 상황이다.</p>\n<br>\n<table>\n<thead>\n<tr>\n<th>항목</th>\n<th><strong>“nest start”</strong></th>\n<th><strong>“node dist/main.js”</strong></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><strong>설정 파일 로드</strong></td>\n<td>Nest CLI 설정 파일 (<code class=\"language-text\">nest-cli.json</code>)을 로드함</td>\n<td>설정 파일을 로드하지 않음</td>\n</tr>\n<tr>\n<td><strong>빌드 과정</strong></td>\n<td>TS 설정 파일(<code class=\"language-text\">tsconfig.json</code>)로 TypeScript 빌드</td>\n<td>이미 빌드된 JS 파일 실행</td>\n</tr>\n<tr>\n<td><strong>프로세스 관리</strong></td>\n<td><strong>spawnChildProcess()</strong>를 통해 별도 프로세스를 생성</td>\n<td><strong>node</strong> 프로세스를 직접 실행</td>\n</tr>\n<tr>\n<td><strong>옵션</strong></td>\n<td><code class=\"language-text\">--watch</code> 옵션 지원 (핫 리로드)</td>\n<td>없음</td>\n</tr>\n</tbody>\n</table>\n<br>\n<br>\n<h2 id=\"-understanding\" style=\"position:relative;\"><a href=\"#-understanding\" aria-label=\" understanding permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>🤔 Understanding</h2>\n<p>습관처럼 사용하고 있었던 명령어들을 이젠 어떠한 이유로 인해 사용 해야하는지 알고 쓸 수 있게 되었다.</p>\n<p>Nest CLI 명령어는 여러 개발 편의 옵션들을 지원 하고 별도의 빌드 과정없이 빠른 실행을 가능하게 한다는 점은 알고 있었지만, 세부적인 코드 흐름을 눈으로 보니 왜 초기화 단계에서 왜 높은 CPU 사용량과 메모리 점유율을 보이는지 이해할 수 있었다.</p>\n<br>\n<br>\n<div class=\"table-of-contents\">\n<ul>\n<li>\n<p><a href=\"#%EF%B8%8F-today-i-learned\">✍️ <strong>T</strong>oday <strong>I</strong> <strong>L</strong>earned</a></p>\n<ul>\n<li><a href=\"#1-%EB%88%88%EC%97%90-%EB%9D%84%EB%8A%94-%EC%B0%A8%EC%9D%B4%EC%A0%90%EC%9D%80\">1. 눈에 띄는 차이점은?</a></li>\n<li><a href=\"#2-nest-cli\">2. Nest CLI</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#-understanding\">🤔 Understanding</a></p>\n</li>\n</ul>\n</div>","excerpt":"✍️ Today I Learned  파일을 작성할 때 습관처럼 큰 의심없이 아래와 같이 작성하곤한다. 에 별다른 설정을 안해두었다면 아래와 같을꺼라 npm run start:prod 명령과 같은 명령어이지만 습관(?)처럼 을 작성할 땐 “./dist/main.js”를 직접 실행시키고 있다. 프레임워크에서 기본으로 제공하는 nest start CLI 명령어 또한 서버를 구동시키는 명령어인데, 빌드된 .js 파일을 직접 실행시키는 것과 어떤 차이가 있을지 궁금해서 찾아본 결과를 간략히 남기려한다. 1. 눈에 띄는 차이점은? 사실 입사 초기에 로컬 환경에서 쓰던  파일이 그대로 운영 환경(심지어 —watch 옵션까지)까지 이어진 경험이 있어서 Nest CLI 명령어는 어떤 사이드 이펙트를 발생시키는지 이미 몸소 체험해본적이 있다. 🥲 간단히 같은 코드 베이스로 Nest CLI 명령어와 빌드된 .js 파일을 직접 실행한 환경으로 나누어서 컨테이너를 실행해보면 아래와 같이 눈으로도 확인이 가…","frontmatter":{"date":"March 19, 2025","title":"Nest CLI 뜯어보기 (nest start)","categories":"TIL","author":"JH8459","emoji":"📚"},"fields":{"slug":"/2025-03-19-TIL/"}},"next":{"id":"ef14b66f-1f4b-5a84-b362-df00d9c6bfd9","html":"<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 56.666666666666664%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAALABQDASIAAhEBAxEB/8QAFwAAAwEAAAAAAAAAAAAAAAAAAAECA//EABUBAQEAAAAAAAAAAAAAAAAAAAAF/9oADAMBAAIQAxAAAAHSaSawD//EABYQAAMAAAAAAAAAAAAAAAAAAAABIP/aAAgBAQABBQIU/wD/xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/AT//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/AT//xAAWEAADAAAAAAAAAAAAAAAAAAAAIDH/2gAIAQEABj8CIv8A/8QAGBAAAgMAAAAAAAAAAAAAAAAAAAERIDH/2gAIAQEAAT8hGb2Ff//aAAwDAQACAAMAAAAQHD//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/ED//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/ED//xAAZEAACAwEAAAAAAAAAAAAAAAABEQAgQVH/2gAIAQEAAT8QjVhju1//2Q=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"github-blog.png\"\n        title=\"github-blog.png\"\n        src=\"/static/7c4bbfe7d1a9d6bc02891c94bfe039dc/80e3c/TIL.jpg\"\n        srcset=\"/static/7c4bbfe7d1a9d6bc02891c94bfe039dc/4ec73/TIL.jpg 180w,\n/static/7c4bbfe7d1a9d6bc02891c94bfe039dc/158ba/TIL.jpg 360w,\n/static/7c4bbfe7d1a9d6bc02891c94bfe039dc/80e3c/TIL.jpg 720w,\n/static/7c4bbfe7d1a9d6bc02891c94bfe039dc/47311/TIL.jpg 1080w,\n/static/7c4bbfe7d1a9d6bc02891c94bfe039dc/ac614/TIL.jpg 1272w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<br>\n<h2 id=\"️-today-i-learned\" style=\"position:relative;\"><a href=\"#%EF%B8%8F-today-i-learned\" aria-label=\"️ today i learned permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>✍️ <strong>T</strong>oday <strong>I</strong> <strong>L</strong>earned</h2>\n<p>사내 인프라는 비교적 성능이 좋은 서버를 사용하고 있다. <del>(수평적 확장이 힘들어서.. 🥲)</del> 그렇기에 초기 인프라를 구성할 땐 리소스 부족에 허덕이진 않고있다. (다만, 요청이 급증할꺼라 예상될 때 수평적으로 확장하기는 쉽지 않다.)</p>\n<p>이러한 바탕을 토대로 온프레미스 환경에서 Docker Compose로 Blue/Green 배포 전략을 구현한 과정을 간략히 포스팅으로 남기려한다.</p>\n<br>\n<br>\n<h3 id=\"1-bluegreen-배포란\" style=\"position:relative;\"><a href=\"#1-bluegreen-%EB%B0%B0%ED%8F%AC%EB%9E%80\" aria-label=\"1 bluegreen 배포란 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. Blue/Green 배포란?</h3>\n<hr>\n<p>간단히 소개하자면, 여러 무중단 배포 기법 중 하나이며 두 개의 독립적인 환경 Blue(구버전) 환경과 Green(신버전) 환경을 가지고 진행되는 배포 전략이다.</p>\n<br>\n<p><img src=\"https://jh8459.s3.ap-northeast-2.amazonaws.com/blog/2025-03-16-TIL/blue_green.jpg\" alt=\"blue/green\"></p>\n<center>출처 : <a href=\"https://www.samsungsds.com/kr/insights/1256264_4627.html\" target=\"_blank\">무중단 배포 아키텍처(Zero Downtime Deployment)- 글로벌 서비스 운영의 필수 요소\n</a></center><br><br>\n<p>구버전이 운영되는 동안 신버전의 인스턴스를 구성한 후 로드밸런서를 통해 신버전으로 모든 트래픽을 일시에 전환하는 배포 방식이다.</p>\n<p>신버전에 문제가 생기는 경우 로드밸런서의 라우팅만 구버전으로 변경해주면 손 쉽게 롤백이 가능한 장점 또한 있지만 그 만큼 리소스를 많이 사용한다. (동일한 환경으로 같은 수의 인스턴스가 추가로 필요하다.)</p>\n<p>사용한 만큼 지불하는 서버리스 컴퓨팅 환경이라면 채택 못할거같다. 🥲</p>\n<br>\n<br>\n<h3 id=\"2-docker-compose\" style=\"position:relative;\"><a href=\"#2-docker-compose\" aria-label=\"2 docker compose permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2. Docker Compose</h3>\n<hr>\n<p>Docker Compose로 구성하는 컨테이너 오케스트레이션은 최소한의 복잡성으로 패키지된 컨테이너들을 쉽게 운용할 수 있고 이식성 또한 뛰어나기에 현재 사내 인프라 구조에서 사용하기 알맞는다 생각한다.</p>\n<p>이번 배포 전략 예시 또한, 여러 컨테이너들을 Docker Compose 환경으로 구성하여 적절한 Bash 스크립팅으로 <code class=\"language-text\">traefik</code> 서비스에서 라우팅을 조절하는 방법으로 Blue/Green 배포 전략을 구현하였다.</p>\n<p>우선 샘플 <code class=\"language-text\">docker-compose.yml</code> 파일을 살펴보면 다음과 같이 구성하였다. (하나하나 천천히 살펴 볼 예정이다.)</p>\n<br>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">services</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">traefik</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> traefik<span class=\"token punctuation\">:</span>latest\n    <span class=\"token key atrule\">command</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>log.level=ERROR\n      <span class=\"token punctuation\">-</span> <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>providers.docker=true\n      <span class=\"token punctuation\">-</span> <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>providers.docker.watch=true\n      <span class=\"token punctuation\">-</span> <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>providers.docker.exposedbydefault=false\n      <span class=\"token punctuation\">-</span> <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>entrypoints.web.address=<span class=\"token punctuation\">:</span><span class=\"token number\">3000</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>entrypoints.web.forwardedHeaders.insecure=true\n      <span class=\"token punctuation\">-</span> <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>providers.file.filename=/etc/traefik/dynamic<span class=\"token punctuation\">-</span>config.yml\n      <span class=\"token punctuation\">-</span> <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>providers.file.watch=true\n    <span class=\"token key atrule\">ports</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token string\">\"3000:3000\"</span>\n    <span class=\"token key atrule\">restart</span><span class=\"token punctuation\">:</span> always\n    <span class=\"token key atrule\">volumes</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> /var/run/docker.sock<span class=\"token punctuation\">:</span>/var/run/docker.sock<span class=\"token punctuation\">:</span>ro\n      <span class=\"token punctuation\">-</span> ./dynamic<span class=\"token punctuation\">-</span>config.yml<span class=\"token punctuation\">:</span>/etc/traefik/dynamic<span class=\"token punctuation\">-</span>config.yml\n    <span class=\"token key atrule\">networks</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> net_default\n\n  <span class=\"token key atrule\">web-server-blue</span><span class=\"token punctuation\">:</span> <span class=\"token important\">&amp;web-server-template</span>\n    <span class=\"token key atrule\">build</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">context</span><span class=\"token punctuation\">:</span> .\n      <span class=\"token key atrule\">dockerfile</span><span class=\"token punctuation\">:</span> Dockerfile\n    <span class=\"token key atrule\">volumes</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> ./src<span class=\"token punctuation\">:</span>/myfolder/src\n    <span class=\"token key atrule\">env_file</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> ./.env\n    <span class=\"token key atrule\">restart</span><span class=\"token punctuation\">:</span> always\n    <span class=\"token key atrule\">deploy</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">replicas</span><span class=\"token punctuation\">:</span> <span class=\"token number\">2</span>\n    <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> traefik.enable=true\n      <span class=\"token punctuation\">-</span> traefik.http.services.web<span class=\"token punctuation\">-</span>server<span class=\"token punctuation\">-</span>blue.loadbalancer.server.port=3000\n    <span class=\"token key atrule\">healthcheck</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">test</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'CMD'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'curl'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'-f'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'http://localhost:3000/health'</span><span class=\"token punctuation\">]</span>\n      <span class=\"token key atrule\">interval</span><span class=\"token punctuation\">:</span> 30s\n      <span class=\"token key atrule\">timeout</span><span class=\"token punctuation\">:</span> 10s\n      <span class=\"token key atrule\">retries</span><span class=\"token punctuation\">:</span> <span class=\"token number\">5</span>\n      <span class=\"token key atrule\">start_period</span><span class=\"token punctuation\">:</span> 30s\n    <span class=\"token key atrule\">networks</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> net_default\n\n  <span class=\"token key atrule\">web-server-green</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">&lt;&lt;</span><span class=\"token punctuation\">:</span> <span class=\"token important\">*web-server-template</span>\n    <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> traefik.enable=true\n      <span class=\"token punctuation\">-</span> traefik.http.services.web<span class=\"token punctuation\">-</span>server<span class=\"token punctuation\">-</span>green.loadbalancer.server.port=3000\n\n<span class=\"token key atrule\">networks</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">net_default</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">driver</span><span class=\"token punctuation\">:</span> bridge</code></pre></div>\n<br>\n<br>\n<h4 id=\"2-1-traefik\" style=\"position:relative;\"><a href=\"#2-1-traefik\" aria-label=\"2 1 traefik permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2-1. traefik</h4>\n<hr>\n<p><code class=\"language-text\">traefik</code> 컨테이너는 로드밸런서 역할을 담당함으로써 구버전 환경과 신버전 환경에 현재 배포 요청에 알맞는 라우팅 정책을 담당할 예정이다.</p>\n<ul>\n<li><code class=\"language-text\">dynamic-config.yml</code> 파일을 제어해서 동적으로 라우팅을 변경할 예정이므로 해당 파일 볼룸을 꼭 설정해주자.</li>\n</ul>\n<br>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">traefik</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> traefik<span class=\"token punctuation\">:</span>latest\n  <span class=\"token key atrule\">command</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>log.level=ERROR\n    <span class=\"token punctuation\">-</span> <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>providers.docker=true  <span class=\"token comment\">#Docker 컨테이너에서 실행 중인 서비스들을 자동으로 감지하도록 설정</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>providers.docker.watch=true  <span class=\"token comment\">#Docker에서 새로운 컨테이너가 생성되거나 변경될 경우 자동으로 감지.</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>providers.docker.exposedbydefault=false  <span class=\"token comment\">#기본적으로 모든 Docker 컨테이너를 Traefik이 라우팅하지 않도록 설정. (labels를 통해 개별적으로 노출해야 함)</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>entrypoints.web.address=<span class=\"token punctuation\">:</span><span class=\"token number\">3000</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>entrypoints.web.forwardedHeaders.insecure=true\n    <span class=\"token punctuation\">-</span> <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>providers.file.filename=/etc/traefik/dynamic<span class=\"token punctuation\">-</span>config.yml  <span class=\"token comment\">#dynamic-config.yml 파일에서 추가적인 동적 설정을 읽도록 지정.</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>providers.file.watch=true  <span class=\"token comment\">#설정 파일(dynamic-config.yml)이 변경되면 자동으로 감지하여 적용하도록 설정.</span>\n  <span class=\"token key atrule\">ports</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> <span class=\"token string\">\"3000:3000\"</span>\n  <span class=\"token key atrule\">restart</span><span class=\"token punctuation\">:</span> always\n  <span class=\"token key atrule\">volumes</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> /var/run/docker.sock<span class=\"token punctuation\">:</span>/var/run/docker.sock<span class=\"token punctuation\">:</span>ro\n    <span class=\"token punctuation\">-</span> ./dynamic<span class=\"token punctuation\">-</span>config.yml<span class=\"token punctuation\">:</span>/etc/traefik/dynamic<span class=\"token punctuation\">-</span>config.yml\n  <span class=\"token key atrule\">networks</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> net_default</code></pre></div>\n<br>\n<p><code class=\"language-text\">docker-compose.yml</code> 파일은 컨테이너가 실행될 때만 적용되는 정적인 설정값들이다. 때문에 동적으로 변해야 하는 라우팅 대상은 현재 운영 중인 버전(Blue / Green)이 무엇인지를 확인해서 배포가 될 때마다 변환되어야 한다.</p>\n<p>동적 라우팅 변경은 <code class=\"language-text\">dynamic-config.yml</code> 파일을 Bash 스크립트에서 자동으로 생성 및 수정이 되게끔 구성하여 라우팅 정책을 제어할 예정이다.</p>\n<p>따라서 아래의 설정값이 반드시 반영되어야한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token punctuation\">-</span> <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>providers.file.filename=/etc/traefik/dynamic<span class=\"token punctuation\">-</span>config.yml  <span class=\"token comment\">#dynamic-config.yml 파일에서 추가적인 동적 설정을 읽도록 지정.</span>\n<span class=\"token punctuation\">-</span> <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>providers.file.watch=true  <span class=\"token comment\">#설정 파일(dynamic-config.yml)이 변경되면 자동으로 감지하여 적용하도록 설정.</span></code></pre></div>\n<br>\n<br>\n<h4 id=\"2-2-web-server\" style=\"position:relative;\"><a href=\"#2-2-web-server\" aria-label=\"2 2 web server permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2-2. web-server</h4>\n<hr>\n<p><code class=\"language-text\">web-server</code> 서비스들은 예시로 <code class=\"language-text\">replicas</code>를 2개로 구성해 두었다. 즉, 각각 2개의 컨테이너씩 Blue / Green 환경이 존재한다고 가정했다.</p>\n<ul>\n<li>동일한 환경으로 구성해야하므로 Blue 컨테이너를 템플릿으로 구성하여 Green 컨테이너에 사용하였다.</li>\n<li>샘플에서는 <code class=\"language-text\">Dockerfile</code>을 사용해서 Bash 스크립트에서 직접 빌드하여 배포하였지만, 이는 여러가지 방법으로 수정해도 무방하다.</li>\n</ul>\n<br>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">web-server-blue</span><span class=\"token punctuation\">:</span> <span class=\"token important\">&amp;web-server-template</span>  <span class=\"token comment\">#&amp;web-server-template을 사용하여 YAML 앵커(Anchor)로 설정을 저장. → web-server-green이 이 설정을 그대로 가져다 사용할 수 있음.</span>\n  <span class=\"token key atrule\">build</span><span class=\"token punctuation\">:</span>  <span class=\"token comment\">#현재 디렉토리(.)에서 Dockerfile을 사용하여 컨테이너 이미지를 빌드함. (이미지 파일을 사용해도 된다.)</span>\n    <span class=\"token key atrule\">context</span><span class=\"token punctuation\">:</span> .\n    <span class=\"token key atrule\">dockerfile</span><span class=\"token punctuation\">:</span> Dockerfile\n  <span class=\"token key atrule\">volumes</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> ./src<span class=\"token punctuation\">:</span>/myfolder/src\n  <span class=\"token key atrule\">env_file</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> ./.env\n  <span class=\"token key atrule\">restart</span><span class=\"token punctuation\">:</span> always\n  <span class=\"token key atrule\">deploy</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">replicas</span><span class=\"token punctuation\">:</span> <span class=\"token number\">2</span>\n  <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> traefik.enable=true  <span class=\"token comment\">#이 컨테이너가 Traefik의 라우팅 대상으로 포함되도록 설정.</span>\n    <span class=\"token punctuation\">-</span> traefik.http.services.web<span class=\"token punctuation\">-</span>server<span class=\"token punctuation\">-</span>blue.loadbalancer.server.port=3000\n  <span class=\"token key atrule\">healthcheck</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">test</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'CMD'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'curl'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'-f'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'http://localhost:3000/health'</span><span class=\"token punctuation\">]</span>\n    <span class=\"token key atrule\">interval</span><span class=\"token punctuation\">:</span> 30s\n    <span class=\"token key atrule\">timeout</span><span class=\"token punctuation\">:</span> 10s\n    <span class=\"token key atrule\">retries</span><span class=\"token punctuation\">:</span> <span class=\"token number\">5</span>\n    <span class=\"token key atrule\">start_period</span><span class=\"token punctuation\">:</span> 30s\n  <span class=\"token key atrule\">networks</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> net_default\n\n<span class=\"token key atrule\">web-server-green</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">&lt;&lt;</span><span class=\"token punctuation\">:</span> <span class=\"token important\">*web-server-template</span>  <span class=\"token comment\">#web-server-green은 web-server-blue와 같은 이미지, 볼륨, 네트워크 등을 사용.</span>\n  <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> traefik.enable=true\n    <span class=\"token punctuation\">-</span> traefik.http.services.web<span class=\"token punctuation\">-</span>server<span class=\"token punctuation\">-</span>green.loadbalancer.server.port=3000</code></pre></div>\n<br>\n<br>\n<h4 id=\"2-3-배포-스크립트\" style=\"position:relative;\"><a href=\"#2-3-%EB%B0%B0%ED%8F%AC-%EC%8A%A4%ED%81%AC%EB%A6%BD%ED%8A%B8\" aria-label=\"2 3 배포 스크립트 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2-3. 배포 스크립트</h4>\n<hr>\n<p>위에서 작성이 완성된 <code class=\"language-text\">docker-compose.yml</code> 파일을 <code class=\"language-text\">docker compose up --build -d</code> 명령어로 실행하면 Blue / Green 서비스마다 컨테이너가 2개씩 생성된다.</p>\n<p>이는 의도한바가 아니므로 Bash 스크립트로 현재 타겟 서비스가 무엇인지 확인하며 라우팅 대상을 변경하는 방식으로 배포가 이뤄진다.</p>\n<br>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token shebang important\">#!/bin/bash</span>\n<span class=\"token comment\"># 환경 변수 설정</span>\n<span class=\"token assign-left variable\">DYNAMIC_CONFIG</span><span class=\"token operator\">=</span><span class=\"token string\">\"dynamic-config.yml\"</span>\n<span class=\"token assign-left variable\">COMPOSE_FILE</span><span class=\"token operator\">=</span><span class=\"token string\">\"docker-compose.yml\"</span>\n<span class=\"token assign-left variable\">DOMAIN</span><span class=\"token operator\">=</span><span class=\"token string\">\"localhost\"</span>\n<span class=\"token assign-left variable\">SERVICE</span><span class=\"token operator\">=</span><span class=\"token string\">\"web-server\"</span>\n<span class=\"token assign-left variable\">BLUE_SERVICE</span><span class=\"token operator\">=</span><span class=\"token string\">\"web-server-blue\"</span>\n<span class=\"token assign-left variable\">GREEN_SERVICE</span><span class=\"token operator\">=</span><span class=\"token string\">\"web-server-green\"</span>\n<span class=\"token assign-left variable\">PORT</span><span class=\"token operator\">=</span><span class=\"token number\">3000</span>\n<span class=\"token assign-left variable\">REPLICAS</span><span class=\"token operator\">=</span><span class=\"token number\">2</span>\n\n<span class=\"token comment\"># 1️⃣ dynamic-config.yml 파일(동적 라우팅 담당)이 없으면 생성</span>\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">[</span> <span class=\"token operator\">!</span> <span class=\"token parameter variable\">-f</span> <span class=\"token string\">\"<span class=\"token variable\">$DYNAMIC_CONFIG</span>\"</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">then</span>\n  <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"⚠️ <span class=\"token variable\">$DYNAMIC_CONFIG</span> 파일이 존재하지 않습니다. 기본값으로 생성합니다.\"</span>\n  <span class=\"token function\">cat</span> <span class=\"token operator\">></span> <span class=\"token variable\">$DYNAMIC_CONFIG</span> <span class=\"token operator\">&lt;&lt;</span><span class=\"token string\">EOL\nhttp:\n  routers:\n    <span class=\"token variable\">$SERVICE</span>:\n      entryPoints:\n        - \"web\"\n      rule: \"Host(\\<span class=\"token variable\">$DOMAIN</span>\\)\"\n      service: \"<span class=\"token variable\">$BLUE_SERVICE</span>\"\n\n  services:\n    <span class=\"token variable\">$BLUE_SERVICE</span>:\n      loadBalancer:\n        servers:\n          - url: \"http://<span class=\"token variable\">$BLUE_SERVICE</span>:<span class=\"token variable\">$PORT</span>\"\n\n    <span class=\"token variable\">$GREEN_SERVICE</span>:\n      loadBalancer:\n        servers:\n          - url: \"http://<span class=\"token variable\">$GREEN_SERVICE</span>:<span class=\"token variable\">$PORT</span>\"\nEOL</span>\n  <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"✅ 기본 <span class=\"token variable\">$DYNAMIC_CONFIG</span> 파일이 생성되었습니다.\"</span>\n<span class=\"token keyword\">fi</span>\n\n<span class=\"token comment\"># 2️⃣ 현재 실행 중인 서비스 확인</span>\n<span class=\"token assign-left variable\">BLUE_RUNNING</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">docker</span> <span class=\"token function\">ps</span> <span class=\"token parameter variable\">--filter</span> <span class=\"token string\">\"name=<span class=\"token variable\">$BLUE_SERVICE</span>\"</span> <span class=\"token parameter variable\">--format</span> <span class=\"token string\">\"{{.Names}}\"</span> <span class=\"token operator\">|</span> <span class=\"token function\">wc</span> <span class=\"token parameter variable\">-l</span><span class=\"token variable\">)</span></span>\n<span class=\"token assign-left variable\">GREEN_RUNNING</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">docker</span> <span class=\"token function\">ps</span> <span class=\"token parameter variable\">--filter</span> <span class=\"token string\">\"name=<span class=\"token variable\">$GREEN_SERVICE</span>\"</span> <span class=\"token parameter variable\">--format</span> <span class=\"token string\">\"{{.Names}}\"</span> <span class=\"token operator\">|</span> <span class=\"token function\">wc</span> <span class=\"token parameter variable\">-l</span><span class=\"token variable\">)</span></span>\n\n<span class=\"token assign-left variable\">FIRST_DEPLOY</span><span class=\"token operator\">=</span>false\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">[</span> <span class=\"token string\">\"<span class=\"token variable\">$BLUE_RUNNING</span>\"</span> <span class=\"token parameter variable\">-eq</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">]</span> <span class=\"token operator\">&amp;&amp;</span> <span class=\"token punctuation\">[</span> <span class=\"token string\">\"<span class=\"token variable\">$GREEN_RUNNING</span>\"</span> <span class=\"token parameter variable\">-eq</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">then</span>\n  <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"🆕 최초 배포입니다. Blue 서비스부터 시작합니다.\"</span>\n  <span class=\"token assign-left variable\">TARGET_SERVICE</span><span class=\"token operator\">=</span><span class=\"token variable\">$BLUE_SERVICE</span>\n  <span class=\"token assign-left variable\">OLD_SERVICE</span><span class=\"token operator\">=</span><span class=\"token string\">\"\"</span>\n  <span class=\"token assign-left variable\">FIRST_DEPLOY</span><span class=\"token operator\">=</span>true\n<span class=\"token keyword\">else</span>\n  <span class=\"token comment\"># 3️⃣ dynamic-config.yml에서 OLD_SERVICE 가져오기</span>\n  <span class=\"token assign-left variable\">OLD_SERVICE</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">grep</span> <span class=\"token string\">\"service:\"</span> $DYNAMIC_CONFIG <span class=\"token operator\">|</span> <span class=\"token function\">awk</span> -F<span class=\"token string\">'\"'</span> <span class=\"token string\">'{print $2}'</span><span class=\"token variable\">)</span></span>\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">[</span> <span class=\"token parameter variable\">-z</span> <span class=\"token string\">\"<span class=\"token variable\">$OLD_SERVICE</span>\"</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">then</span>\n    <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"❌ 현재 라우팅된 서비스 정보를 가져오지 못했습니다. 배포를 중단합니다.\"</span>\n    <span class=\"token builtin class-name\">exit</span> <span class=\"token number\">1</span>\n  <span class=\"token keyword\">fi</span>\n\n  <span class=\"token comment\"># 4️⃣ 현재 실행 중인 컨테이너 확인하여 OLD_SERVICE가 아닌 컨테이너 찾기</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">[</span> <span class=\"token string\">\"<span class=\"token variable\">$OLD_SERVICE</span>\"</span> <span class=\"token operator\">==</span> <span class=\"token string\">\"<span class=\"token variable\">$BLUE_SERVICE</span>\"</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">then</span>\n    <span class=\"token assign-left variable\">TARGET_SERVICE</span><span class=\"token operator\">=</span><span class=\"token variable\">$GREEN_SERVICE</span>\n  <span class=\"token keyword\">else</span>\n    <span class=\"token assign-left variable\">TARGET_SERVICE</span><span class=\"token operator\">=</span><span class=\"token variable\">$BLUE_SERVICE</span>\n  <span class=\"token keyword\">fi</span>\n\n  <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"🔄 현재 라우팅된 서비스: <span class=\"token variable\">$OLD_SERVICE</span>\"</span>\n  <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"🚀 새로운 배포 대상 서비스: <span class=\"token variable\">$TARGET_SERVICE</span>\"</span>\n<span class=\"token keyword\">fi</span>\n\n<span class=\"token comment\"># 5️⃣ 새로운 서비스 빌드</span>\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"🚀 Building the new version of the service: <span class=\"token variable\">$TARGET_SERVICE</span>...\"</span>\n<span class=\"token function\">docker</span> compose <span class=\"token parameter variable\">-f</span> <span class=\"token variable\">$COMPOSE_FILE</span> build <span class=\"token variable\">$TARGET_SERVICE</span>\n\n<span class=\"token comment\"># 6️⃣ 새로운 컨테이너 실행</span>\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"🚀 Deploying new service: <span class=\"token variable\">$TARGET_SERVICE</span> with <span class=\"token variable\">$REPLICAS</span> replicas...\"</span>\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">[</span> <span class=\"token string\">\"<span class=\"token variable\">$FIRST_DEPLOY</span>\"</span> <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">then</span>\n  <span class=\"token function\">docker</span> compose <span class=\"token parameter variable\">-f</span> <span class=\"token variable\">$COMPOSE_FILE</span> up <span class=\"token parameter variable\">-d</span> <span class=\"token parameter variable\">--scale</span> <span class=\"token variable\">$BLUE_SERVICE</span><span class=\"token operator\">=</span><span class=\"token variable\">$REPLICAS</span> <span class=\"token parameter variable\">--scale</span> <span class=\"token variable\">$GREEN_SERVICE</span><span class=\"token operator\">=</span><span class=\"token number\">0</span>\n<span class=\"token keyword\">else</span>\n  <span class=\"token function\">docker</span> compose <span class=\"token parameter variable\">-f</span> <span class=\"token variable\">$COMPOSE_FILE</span> up <span class=\"token parameter variable\">-d</span> <span class=\"token parameter variable\">--scale</span> <span class=\"token variable\">$TARGET_SERVICE</span><span class=\"token operator\">=</span><span class=\"token variable\">$REPLICAS</span>\n<span class=\"token keyword\">fi</span>\n\n<span class=\"token comment\"># 7️⃣ 새로운 서비스 Health Check</span>\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"🛠️ Checking health status of <span class=\"token variable\">$TARGET_SERVICE</span>...\"</span>\n<span class=\"token function\">sleep</span> <span class=\"token number\">10</span>  <span class=\"token comment\"># 안정화 시간</span>\n\n<span class=\"token keyword\">for</span> <span class=\"token for-or-select variable\">i</span> <span class=\"token keyword\">in</span> <span class=\"token punctuation\">{</span><span class=\"token number\">1</span><span class=\"token punctuation\">..</span><span class=\"token number\">12</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">do</span>\n  <span class=\"token assign-left variable\">HEALTHY_COUNT</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">docker</span> <span class=\"token function\">ps</span> <span class=\"token parameter variable\">--filter</span> <span class=\"token string\">\"name=<span class=\"token variable\">$TARGET_SERVICE</span>\"</span> <span class=\"token parameter variable\">--filter</span> <span class=\"token string\">\"health=healthy\"</span> <span class=\"token parameter variable\">--format</span> <span class=\"token string\">\"{{.Names}}\"</span> <span class=\"token operator\">|</span> <span class=\"token function\">wc</span> <span class=\"token parameter variable\">-l</span><span class=\"token variable\">)</span></span>\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">[</span> <span class=\"token string\">\"<span class=\"token variable\">$HEALTHY_COUNT</span>\"</span> <span class=\"token parameter variable\">-gt</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">then</span>\n    <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"✅ New service <span class=\"token variable\">$TARGET_SERVICE</span> is healthy!\"</span>\n    <span class=\"token builtin class-name\">break</span>\n  <span class=\"token keyword\">fi</span>\n\n  <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"⏳ Waiting for <span class=\"token variable\">$TARGET_SERVICE</span> to be healthy... (<span class=\"token variable\">$i</span>/12)\"</span>\n  <span class=\"token function\">sleep</span> <span class=\"token number\">10</span>\n<span class=\"token keyword\">done</span>\n\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">[</span> <span class=\"token string\">\"<span class=\"token variable\">$HEALTHY_COUNT</span>\"</span> <span class=\"token parameter variable\">-eq</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">then</span>\n  <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"❌ New service <span class=\"token variable\">$TARGET_SERVICE</span> failed to start properly. Rolling back...\"</span>\n  <span class=\"token function\">docker</span> compose <span class=\"token parameter variable\">-f</span> <span class=\"token variable\">$COMPOSE_FILE</span> down <span class=\"token variable\">$TARGET_SERVICE</span>\n  <span class=\"token builtin class-name\">exit</span> <span class=\"token number\">1</span>\n<span class=\"token keyword\">fi</span>\n\n<span class=\"token comment\"># 8️⃣ `dynamic-config.yml` 업데이트 (새로운 서비스로 라우팅 변경)</span>\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"🔄 Updating dynamic-config.yml to point to <span class=\"token variable\">$TARGET_SERVICE</span>...\"</span>\n<span class=\"token function\">cat</span> <span class=\"token operator\">></span> <span class=\"token variable\">$DYNAMIC_CONFIG</span> <span class=\"token operator\">&lt;&lt;</span><span class=\"token string\">EOL\nhttp:\n  routers:\n    <span class=\"token variable\">$SERVICE</span>:\n      entryPoints:\n        - \"web\"\n      rule: \"Host(\\<span class=\"token variable\"><span class=\"token variable\">`</span>$DOMAIN<span class=\"token punctuation\">\\</span><span class=\"token variable\">`</span></span>)\"\n      service: \"<span class=\"token variable\">$TARGET_SERVICE</span>\"\n\n  services:\n    <span class=\"token variable\">$BLUE_SERVICE</span>:\n      loadBalancer:\n        servers:\n          - url: \"http://<span class=\"token variable\">$BLUE_SERVICE</span>:<span class=\"token variable\">$PORT</span>\"\n\n    <span class=\"token variable\">$GREEN_SERVICE</span>:\n      loadBalancer:\n        servers:\n          - url: \"http://<span class=\"token variable\">$GREEN_SERVICE</span>:<span class=\"token variable\">$PORT</span>\"\nEOL</span>\n\n<span class=\"token comment\"># 9️⃣ Traefik이 설정을 자동 감지하도록 트리거</span>\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"♻️ Triggering Traefik reload...\"</span>\n<span class=\"token function\">touch</span> <span class=\"token variable\">$DYNAMIC_CONFIG</span>\n\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"🎉 Deployment complete!\"</span></code></pre></div>\n<br>\n<p>각각 프로젝트마다 고유한 값들은 환경 변수로 만들어 두었으며 스크립트를 간단히 설명하자면 아래의 순서대로 스크립트가 실행되며 Blue / Green 배포가 진행된다.</p>\n<ol>\n<li>스크립트가 실행된 디렉토리에 <code class=\"language-text\">dynamic-config.yml</code> 파일이 존재하는지 감지하고 없다면 기본 라우팅 정책(Blue 환경 우선 라우팅)을 담은 파일을 생성한다.</li>\n<li>현재 실행 중인 Blue / Green 컨테이너들을 확인 후 최초 배포가 이뤄지는 경우인지 확인한다.</li>\n<li>최초 배포가 진행되는 경우라면 Blue 환경으로 배포를 진행한다. (Green 환경은 배포하지 않는다.)</li>\n<li>최초 배포가 진행되는 경우가 아니라면 운영 중인 <code class=\"language-text\">dynamic-config.yml</code> 파일을 확인하여 현재 라우팅 중인 컨테이너(OLD_SERVICE) 정보를 가져온다.</li>\n<li>새로운 서비스를 빌드한다.</li>\n<li>빌드된 이미지로 새로운 컨테이너(TARGET_SERVICE)를 실행한다.</li>\n<li>새로운 컨테이너의 Health Check를 기다린다. (실패시 TARGET_SERVICE 컨테이너를 삭제 후 스크립트를 종료)</li>\n<li><code class=\"language-text\">dynamic-config.yml</code>의 라우팅 대상을 업데이트 한다. (OLD_SERVICE → TARGET_SERVICE)</li>\n<li>설정 파일의 변경을 자동으로 감지할 수 있도록 <code class=\"language-text\">dynamic-config.yml</code> 파일을 수정한다.</li>\n</ol>\n<br>\n<br>\n<p>위 순서대로 동작하므로 신버전(TARGET_SERVICE)이 배포되고 안정화 되는 동안 구버전(OLD_SERVICE)이 트래픽을 받을 수 있으므로 무중단 배포가 가능하며, Blue / Green 환경이 모두 공존하므로 손 쉽게 롤백 또한 가능하다.</p>\n<br>\n<br>\n<h4 id=\"2-4-라우팅-정책-변경-스크립트\" style=\"position:relative;\"><a href=\"#2-4-%EB%9D%BC%EC%9A%B0%ED%8C%85-%EC%A0%95%EC%B1%85-%EB%B3%80%EA%B2%BD-%EC%8A%A4%ED%81%AC%EB%A6%BD%ED%8A%B8\" aria-label=\"2 4 라우팅 정책 변경 스크립트 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2-4. 라우팅 정책 변경 스크립트</h4>\n<hr>\n<p>신버전(TARGET_SERVICE)이 새로 배포가 되었다면, 구버전(OLD_SERVICE) 환경은 더이상 트래픽을 받지 못하는 유휴 컨테이너들로 존재한다.</p>\n<p>이 경우에 새로 배포한 환경에서 문제가 발생했다면 구버전(OLD_SERVICE) 환경으로 라우팅 정책만 변경하면 손 쉽게 롤백이 가능하다.</p>\n<br>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token shebang important\">#!/bin/bash</span>\n<span class=\"token comment\"># 환경 변수 설정</span>\n<span class=\"token assign-left variable\">DYNAMIC_CONFIG</span><span class=\"token operator\">=</span><span class=\"token string\">\"dynamic-config.yml\"</span>\n<span class=\"token assign-left variable\">COMPOSE_FILE</span><span class=\"token operator\">=</span><span class=\"token string\">\"docker-compose.yml\"</span>\n<span class=\"token assign-left variable\">DOMAIN</span><span class=\"token operator\">=</span><span class=\"token string\">\"localhost\"</span>\n<span class=\"token assign-left variable\">SERVICE</span><span class=\"token operator\">=</span><span class=\"token string\">\"web-server\"</span>\n<span class=\"token assign-left variable\">BLUE_SERVICE</span><span class=\"token operator\">=</span><span class=\"token string\">\"web-server-blue\"</span>\n<span class=\"token assign-left variable\">GREEN_SERVICE</span><span class=\"token operator\">=</span><span class=\"token string\">\"web-server-green\"</span>\n<span class=\"token assign-left variable\">PORT</span><span class=\"token operator\">=</span><span class=\"token number\">3000</span>\n\n<span class=\"token comment\"># 1️⃣ 현재 실행 중인 서비스 확인</span>\n<span class=\"token assign-left variable\">BLUE_RUNNING</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">docker</span> <span class=\"token function\">ps</span> <span class=\"token parameter variable\">--filter</span> <span class=\"token string\">\"name=<span class=\"token variable\">$BLUE_SERVICE</span>\"</span> <span class=\"token parameter variable\">--format</span> <span class=\"token string\">\"{{.Names}}\"</span> <span class=\"token operator\">|</span> <span class=\"token function\">wc</span> <span class=\"token parameter variable\">-l</span><span class=\"token variable\">)</span></span>\n<span class=\"token assign-left variable\">GREEN_RUNNING</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">docker</span> <span class=\"token function\">ps</span> <span class=\"token parameter variable\">--filter</span> <span class=\"token string\">\"name=<span class=\"token variable\">$GREEN_SERVICE</span>\"</span> <span class=\"token parameter variable\">--format</span> <span class=\"token string\">\"{{.Names}}\"</span> <span class=\"token operator\">|</span> <span class=\"token function\">wc</span> <span class=\"token parameter variable\">-l</span><span class=\"token variable\">)</span></span>\n\n<span class=\"token comment\"># 둘 다 실행 중이어야 라우팅 정책 변경 가능 (둘 중 하나라도 꺼져 있으면 종료)</span>\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">[</span> <span class=\"token string\">\"<span class=\"token variable\">$BLUE_RUNNING</span>\"</span> <span class=\"token parameter variable\">-eq</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">]</span> <span class=\"token operator\">||</span> <span class=\"token punctuation\">[</span> <span class=\"token string\">\"<span class=\"token variable\">$GREEN_RUNNING</span>\"</span> <span class=\"token parameter variable\">-eq</span> <span class=\"token number\">0</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">then</span>\n  <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"❌ Blue와 Green 중 하나라도 실행되지 않으면 라우팅을 변경할 수 없습니다.\"</span>\n  <span class=\"token builtin class-name\">exit</span> <span class=\"token number\">1</span>\n<span class=\"token keyword\">fi</span>\n\n<span class=\"token comment\"># 2️⃣ 현재 dynamic-config.yml에서 OLD_SERVICE 가져오기</span>\n<span class=\"token assign-left variable\">OLD_SERVICE</span><span class=\"token operator\">=</span><span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token function\">grep</span> <span class=\"token string\">\"service:\"</span> $DYNAMIC_CONFIG <span class=\"token operator\">|</span> <span class=\"token function\">awk</span> -F<span class=\"token string\">'\"'</span> <span class=\"token string\">'{print $2}'</span><span class=\"token variable\">)</span></span>\n\n<span class=\"token comment\"># OLD_SERVICE가 설정되지 않았다면 오류 처리</span>\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">[</span> <span class=\"token parameter variable\">-z</span> <span class=\"token string\">\"<span class=\"token variable\">$OLD_SERVICE</span>\"</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">then</span>\n  <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"❌ 현재 라우팅된 서비스 정보를 가져오지 못했습니다. 라우팅 변경을 중단합니다.\"</span>\n  <span class=\"token builtin class-name\">exit</span> <span class=\"token number\">1</span>\n<span class=\"token keyword\">fi</span>\n\n<span class=\"token comment\"># 3️⃣ OLD_SERVICE가 Blue인지 Green인지 확인하고 반대 서비스로 전환</span>\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">[</span> <span class=\"token string\">\"<span class=\"token variable\">$OLD_SERVICE</span>\"</span> <span class=\"token operator\">==</span> <span class=\"token string\">\"<span class=\"token variable\">$BLUE_SERVICE</span>\"</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">then</span>\n  <span class=\"token assign-left variable\">TARGET_SERVICE</span><span class=\"token operator\">=</span><span class=\"token variable\">$GREEN_SERVICE</span>\n<span class=\"token keyword\">else</span>\n  <span class=\"token assign-left variable\">TARGET_SERVICE</span><span class=\"token operator\">=</span><span class=\"token variable\">$BLUE_SERVICE</span>\n<span class=\"token keyword\">fi</span>\n\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"🔄 현재 운영 중인 서비스: <span class=\"token variable\">$OLD_SERVICE</span>\"</span>\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"🚀 새로운 라우팅 대상 서비스: <span class=\"token variable\">$TARGET_SERVICE</span>\"</span>\n\n<span class=\"token comment\"># 4️⃣ `dynamic-config.yml` 업데이트 (새로운 서비스로 라우팅 변경)</span>\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"🔄 Updating dynamic-config.yml to roll back to <span class=\"token variable\">$TARGET_SERVICE</span>...\"</span>\n<span class=\"token function\">cat</span> <span class=\"token operator\">></span> <span class=\"token variable\">$DYNAMIC_CONFIG</span> <span class=\"token operator\">&lt;&lt;</span><span class=\"token string\">EOL\nhttp:\n  routers:\n    <span class=\"token variable\">$SERVICE</span>:\n      entryPoints:\n        - \"web\"\n      rule: \"Host(\\<span class=\"token variable\"><span class=\"token variable\">`</span>$DOMAIN<span class=\"token punctuation\">\\</span><span class=\"token variable\">`</span></span>)\"\n      service: \"<span class=\"token variable\">$TARGET_SERVICE</span>\"\n\n  services:\n    <span class=\"token variable\">$BLUE_SERVICE</span>:\n      loadBalancer:\n        servers:\n          - url: \"http://<span class=\"token variable\">$BLUE_SERVICE</span>:<span class=\"token variable\">$PORT</span>\"\n\n    <span class=\"token variable\">$GREEN_SERVICE</span>:\n      loadBalancer:\n        servers:\n          - url: \"http://<span class=\"token variable\">$GREEN_SERVICE</span>:<span class=\"token variable\">$PORT</span>\"\nEOL</span>\n\n<span class=\"token comment\"># 5️⃣ Traefik이 설정을 자동 감지하도록 트리거</span>\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"♻️ Triggering Traefik reload...\"</span>\n<span class=\"token function\">touch</span> <span class=\"token variable\">$DYNAMIC_CONFIG</span>\n\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"🎉 Rollback complete! Traffic is now routed to <span class=\"token variable\">$TARGET_SERVICE</span>.\"</span></code></pre></div>\n<br>\n<br>\n<h3 id=\"3-어려웠던-점\" style=\"position:relative;\"><a href=\"#3-%EC%96%B4%EB%A0%A4%EC%9B%A0%EB%8D%98-%EC%A0%90\" aria-label=\"3 어려웠던 점 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3. 어려웠던 점</h3>\n<hr>\n<p>가장 많이 기술적으로 시간을 할애한 부분은 Blue 환경이 운영중에 Green 환경 추가로 컨테이너로 배포하면 <code class=\"language-text\">traefik</code>이 자동으로 Green 환경까지 인식하여 트래픽을 보내는 상황을 개선하는 부분이었다.</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token punctuation\">-</span> <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>providers.docker=true  <span class=\"token comment\">#Docker 컨테이너에서 실행 중인 서비스들을 자동으로 감지하도록 설정</span>\n<span class=\"token punctuation\">-</span> <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>providers.docker.watch=true  <span class=\"token comment\">#Docker에서 새로운 컨테이너가 생성되거나 변경될 경우 자동으로 감지.</span></code></pre></div>\n<p><code class=\"language-text\">traefik</code> 컨테이너의 위 두 설정은 반드시 필요하지만 그렇기에 Blue / Green 환경을 독립적인 환경으로 각각 분리하기가 어렵게하는 요인 중 하나였다. 🥲</p>\n<br>\n<p>최종적으로는 컨테이너마다 Blue / Green 라벨을 부여해서 라우팅을 동적으로 할당하는 방법을 채택하여 사용하였지만, 그 과정이 순탄하지는 않았다.</p>\n<ul>\n<li><strong>TARGET_SERVICE</strong>로 전달되는 트래픽을 차단 하기 위해 Docker Network를 임시로 연결을 끊는다. → 외부 DB 연결이 끊기며 ORM에서 DB 연결 초기화가 되지 않는 이슈가 발생하며 Health Check를 통과하지 못한다. 😅</li>\n<li><strong>TARGET_SERVICE</strong>가 새로 배포 후 Health Check를 통과하면 <strong>OLD_SERVICE</strong>를 바로 제거한다. → 수 초 내외로 두 서비스가 공존하는 순간이 발생할 수 밖에 없으며, 이상적인 Blue / Green 배포 전략과는 거리가 멀다. 😅</li>\n</ul>\n<br>\n<p>생각나는대로 적어보니 위와 같은 경우들이 생각이 난다.</p>\n<br>\n<br>\n<h2 id=\"-understanding\" style=\"position:relative;\"><a href=\"#-understanding\" aria-label=\" understanding permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>🤔 Understanding</h2>\n<p>사실 실제로 가장 많은 시간을 할애한 부분은 기술 검증이었다.</p>\n<ul>\n<li>유휴 컨테이너들로 인해 리소스 낭비가 발생할 수 밖에 없는데 이는 얼마나 큰 영향을 미치는가?</li>\n<li>기존에 배포하는 방식(Recreated)에 비해 어떤점이 얼마나 개선하는지에 대한 정량적인 수치화</li>\n<li>배포 실패시 플랜B 계획</li>\n</ul>\n<p>이 외에 무중단 배포를 활용할 수 있는 파이프라인 (Hotfix) 추가 등등.. 개발 외적인 부분들에서 더욱 더 시간과 신경을 많이 썼던거 같다.</p>\n<br>\n<br>\n<div class=\"table-of-contents\">\n<ul>\n<li>\n<p><a href=\"#%EF%B8%8F-today-i-learned\">✍️ <strong>T</strong>oday <strong>I</strong> <strong>L</strong>earned</a></p>\n<ul>\n<li>\n<p><a href=\"#1-bluegreen-%EB%B0%B0%ED%8F%AC%EB%9E%80\">1. Blue/Green 배포란?</a></p>\n</li>\n<li>\n<p><a href=\"#2-docker-compose\">2. Docker Compose</a></p>\n<ul>\n<li><a href=\"#2-1-traefik\">2-1. traefik</a></li>\n<li><a href=\"#2-2-web-server\">2-2. web-server</a></li>\n<li><a href=\"#2-3-%EB%B0%B0%ED%8F%AC-%EC%8A%A4%ED%81%AC%EB%A6%BD%ED%8A%B8\">2-3. 배포 스크립트</a></li>\n<li><a href=\"#2-4-%EB%9D%BC%EC%9A%B0%ED%8C%85-%EC%A0%95%EC%B1%85-%EB%B3%80%EA%B2%BD-%EC%8A%A4%ED%81%AC%EB%A6%BD%ED%8A%B8\">2-4. 라우팅 정책 변경 스크립트</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#3-%EC%96%B4%EB%A0%A4%EC%9B%A0%EB%8D%98-%EC%A0%90\">3. 어려웠던 점</a></p>\n</li>\n</ul>\n</li>\n<li>\n<p><a href=\"#-understanding\">🤔 Understanding</a></p>\n</li>\n</ul>\n</div>","frontmatter":{"date":"March 16, 2025","title":"Docker Compose와 Traefik을 활용한 Blue/Green 배포 전략","categories":"TIL","author":"JH8459","emoji":"📚"},"fields":{"slug":"/2025-03-16-TIL/"}},"prev":{"id":"6b675222-de1f-5125-a53e-fc1fe726bfed","html":"<img src=\"https://jh8459.s3.ap-northeast-2.amazonaws.com/blog/2025-03-31-PROJECT/banner.png\">\n<br>\n<h2 id=\"왜-ec2에서-nas로-옮기게-되었는가\" style=\"position:relative;\"><a href=\"#%EC%99%9C-ec2%EC%97%90%EC%84%9C-nas%EB%A1%9C-%EC%98%AE%EA%B8%B0%EA%B2%8C-%EB%90%98%EC%97%88%EB%8A%94%EA%B0%80\" aria-label=\"왜 ec2에서 nas로 옮기게 되었는가 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>왜 EC2에서 NAS로 옮기게 되었는가?</h2>\n<p>사용 중인 NAS의 사용성이 DSM 7.2+ (Synology사의 DS920+ 기준) 부터 많이 달라졌다. 단순히 UI/UX만 변경된것이 아니라 (구)Docker 패키지에서 변경된 <strong>Container Manager 패키지</strong>는 다중 컨테이너 환경을 지원한다.</p>\n<br>\n<img src=\"https://jh8459.s3.ap-northeast-2.amazonaws.com/blog/2025-03-31-PROJECT/container_manager.jpg\">\n<center>Docker Compose! 😲</center><br><br>\n<p>EC2 t2.micro 인스턴스로 사용 중이던 서버에 올려둔 컨테이너 기반의 <a href=\"https://blog.jh8459.com/2024-07-01-PROJECT/\" target=\"_blank\">프로젝트 (LOTTERY 🍀)</a>를 비용 효율적인 측면에서 마이그레이션하기 좋은 기회라 생각했다.</p>\n<p>EC2에서 NAS로 마이그레이션하는 과정과 Github Action + Docker Hub를 사용한 CI / CD 구축한 과정 또한 간략히 남겨 보려한다.</p>\n<br>\n<br>\n<h3 id=\"1-cicd-파이프라인-구성\" style=\"position:relative;\"><a href=\"#1-cicd-%ED%8C%8C%EC%9D%B4%ED%94%84%EB%9D%BC%EC%9D%B8-%EA%B5%AC%EC%84%B1\" aria-label=\"1 cicd 파이프라인 구성 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. CI/CD 파이프라인 구성</h3>\n<hr>\n<p>전반적인 CI/CD는 <strong>Github Action</strong> + <strong>Docker Hub</strong> 를 활용하였으며, CI / CD 나누어 Github 저장소의 브런치를 활용해서 파이프라인을 구성하였다. (CI/CD 모두를 자동화는 아래와 같은 무중단 배포 전략까지 도입 후 수정할 예정이다.)</p>\n<blockquote>\n<p>👉 <a href=\"https://blog.jh8459.com/2025-03-16-TIL/\" target=\"_blank\">Docker Compose와 Traefik을 활용한 Blue/Green 배포 전략</a></p>\n</blockquote>\n<br>\n<img src=\"https://jh8459.s3.ap-northeast-2.amazonaws.com/blog/2025-03-31-PROJECT/pipeline.png\">\n<center>전반적인 CI/CD 흐름은 위 사진과 같이 진행된다. 🤖</center><br><br>\n<ol>\n<li>\n<p>Local Repository에서 작업한 결과물을 Github 원격 Remote Repository의 <code class=\"language-text\">master</code> 브런치로 Push 한다.</p>\n</li>\n<li>\n<p><code class=\"language-text\">master</code> 브런치로 Commit이 Push되면 아래의 조건을 갖는 Github Action <strong>(CI)</strong> 이 동작한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"yml\"><pre class=\"language-yml\"><code class=\"language-yml\"><span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Build &amp; Push Docker Images (CI)\n\n<span class=\"token key atrule\">on</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">push</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">branches</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'master'</span><span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">...</span></code></pre></div>\n</li>\n<li>\n<p>Github Action Runner를 통해서 <code class=\"language-text\">master</code> 브런치에 올라간 코드를 기반으로 Docker Image가 빌드되고 빌드 성공시 Docker Hub에 Push한다.</p>\n</li>\n<li>\n<p>Github Action <strong>(CI)</strong> 이 성공하면 배포 준비가 완료된 상태이다. 배포가 필요하다면 <code class=\"language-text\">prod</code> 브런치로 PR을 날린다.</p>\n</li>\n<li>\n<p><code class=\"language-text\">prod</code> 브런치로 PR이 Merge되면 아래의 조건을 갖는 Github Action <strong>(CD)</strong> 이 동작한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"yml\"><pre class=\"language-yml\"><code class=\"language-yml\"><span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Deploy to NAS (CD)\n\n<span class=\"token key atrule\">on</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">pull_request</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">branches</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'prod'</span><span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">...</span></code></pre></div>\n</li>\n<li>\n<p>Github Action Runner를 통해서 NAS에 SSH접속이 이뤄지며 운영 환경에 알맞는 <code class=\"language-text\">.env</code> 환경변수 파일을 생성한다.</p>\n</li>\n<li>\n<p>Docker Hub에 올라간 Docker Image를 기반으로 NAS 서버에 배포를 진행한다.</p>\n</li>\n</ol>\n<br>\n<br>\n<h3 id=\"2-nas에서-환경-구성\" style=\"position:relative;\"><a href=\"#2-nas%EC%97%90%EC%84%9C-%ED%99%98%EA%B2%BD-%EA%B5%AC%EC%84%B1\" aria-label=\"2 nas에서 환경 구성 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2. NAS에서 환경 구성</h3>\n<hr>\n<p>위에서 언급한 CI/CD 파이프라인을 구성하려면 NAS에도 아래와 같은 환경 구성이 필요하다.</p>\n<blockquote>\n<p>이용 중인 NAS의 OS는 <strong>Ubuntu OS</strong>가 아닌 Synology에서 개발된 자체 OS인 <strong>DSM</strong>을 사용하기 때문에, <code class=\"language-text\">sudo apt-get install git</code> 같은 CLI 명령어가 아닌 DSM 패키지 센터를 통해 아래와 같은 환경을 구성해줘야 한다.</p>\n</blockquote>\n<br>\n<br>\n<h4 id=\"2-1-container-manager-패키지-설치\" style=\"position:relative;\"><a href=\"#2-1-container-manager-%ED%8C%A8%ED%82%A4%EC%A7%80-%EC%84%A4%EC%B9%98\" aria-label=\"2 1 container manager 패키지 설치 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2-1. Container Manager 패키지 설치</h4>\n<hr>\n<p>전반적인 <strong>Container Manager</strong>를 활용한 NAS 환경 구성은 서버 포럼의<a href=\"https://svrforum.com/nas/695302\" target=\"_blank\">“이제 시놀로지에서 Docker-compose를(?) DSM 7.2의 Container Mananger”</a>게시글을 보고 구성하였다. 🙏🙏🙏</p>\n<p>volume을 설정할때 디렉토리는 추후 <strong>docker-compose.yml</strong> 파일이 수정되는 경우에도 Github 원격 저장소의 <code class=\"language-text\">prod</code> 브런치의 코드를 내려받아 최신화되어야한다. (이를 염두하고 설정하자.)</p>\n<img src=\"https://jh8459.s3.ap-northeast-2.amazonaws.com/blog/2025-03-31-PROJECT/volume.png\">\n<br>\n<br>\n<h4 id=\"2-2-git-server-패키지-설치\" style=\"position:relative;\"><a href=\"#2-2-git-server-%ED%8C%A8%ED%82%A4%EC%A7%80-%EC%84%A4%EC%B9%98\" aria-label=\"2 2 git server 패키지 설치 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2-2. Git Server 패키지 설치</h4>\n<hr>\n<p>CLI 명령으로 설치가 안되므로 DSM 패키지 센터의 <strong>Git Server</strong> 패키지를 내려 받아야 한다.</p>\n<img src=\"https://jh8459.s3.ap-northeast-2.amazonaws.com/blog/2025-03-31-PROJECT/git.png\">\n<br>\n<br>\n<h4 id=\"2-3-nas의-ssh-원격-접속-포트-허용\" style=\"position:relative;\"><a href=\"#2-3-nas%EC%9D%98-ssh-%EC%9B%90%EA%B2%A9-%EC%A0%91%EC%86%8D-%ED%8F%AC%ED%8A%B8-%ED%97%88%EC%9A%A9\" aria-label=\"2 3 nas의 ssh 원격 접속 포트 허용 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2-3. NAS의 SSH 원격 접속 포트 허용</h4>\n<hr>\n<p>CI/CD 과정에서 Github Action 통해서 NAS로 SSH 접속이 이뤄져야 하므로 해당 옵션을 허용해주자.</p>\n<img src=\"https://jh8459.s3.ap-northeast-2.amazonaws.com/blog/2025-03-31-PROJECT/ssh.png\">\n<br>\n<br>\n<h4 id=\"2-4-nas의-역방향-프록시-설정\" style=\"position:relative;\"><a href=\"#2-4-nas%EC%9D%98-%EC%97%AD%EB%B0%A9%ED%96%A5-%ED%94%84%EB%A1%9D%EC%8B%9C-%EC%84%A4%EC%A0%95\" aria-label=\"2 4 nas의 역방향 프록시 설정 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2-4. NAS의 역방향 프록시 설정</h4>\n<hr>\n<p>Ubuntu OS에서 웹 서버를 구성할 땐 <strong>traefik</strong> 혹은 <strong>nginx</strong>를 사용하여 역방향 프록시(Reverse Proxy) 서버 구성을 하였지만, DSM 기본 기능인 역방향 프록시 기능을 사용하여 도메인 소스와 NAS 내부 서비스를 맵핑 시켜주었다.</p>\n<img src=\"https://jh8459.s3.ap-northeast-2.amazonaws.com/blog/2025-03-31-PROJECT/reverse.png\">\n<br>\n<br>\n<h4 id=\"2-4-공유기-포트포워딩-설정\" style=\"position:relative;\"><a href=\"#2-4-%EA%B3%B5%EC%9C%A0%EA%B8%B0-%ED%8F%AC%ED%8A%B8%ED%8F%AC%EC%9B%8C%EB%94%A9-%EC%84%A4%EC%A0%95\" aria-label=\"2 4 공유기 포트포워딩 설정 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2-4. 공유기 포트포워딩 설정</h4>\n<hr>\n<p>홈 네트워크는 보통 공유기를 사용중일텐데 외부망을 통해 NAS에서 실행중인 어플리케이션에 도달하려면 공유기의 포트 포워딩 규칙을 허용해줘야 한다.</p>\n<p>어플리케이션이 NAS의 1111번 포트를 사용중이라면 아래와 같은 규칙을 허용해주어야 한다.</p>\n<p><img src=\"https://jh8459.s3.ap-northeast-2.amazonaws.com/blog/2025-03-31-PROJECT/port.png\"><br></p>\n<br>\n<br>\n<h3 id=\"3-github-actions-살펴보기\" style=\"position:relative;\"><a href=\"#3-github-actions-%EC%82%B4%ED%8E%B4%EB%B3%B4%EA%B8%B0\" aria-label=\"3 github actions 살펴보기 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3. GitHub Actions 살펴보기</h3>\n<hr>\n<p>기본적으로 <strong>Public</strong> 저장소이기 때문에 노출되면 안되는 값들은 Github Repository에서 제공하는 환경 변수를 통해 변인 요인들을 관리하고 있.</p>\n<p>Github Action은 CI/CD 파이프라인이 모두 자동화되고 있진 않으므로 이미지 빌드를 담당하는 <strong>ci.yml</strong>과 NAS로 원격 접속하여 배포를 진행하는 <strong>cd.yml</strong> 두개로 분리하여 구성하였다.</p>\n<br>\n<br>\n<h4 id=\"3-1-ciyml\" style=\"position:relative;\"><a href=\"#3-1-ciyml\" aria-label=\"3 1 ciyml permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3-1. ci.yml</h4>\n<hr>\n<div class=\"gatsby-highlight\" data-language=\"yml\"><pre class=\"language-yml\"><code class=\"language-yml\"><span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Build &amp; Push Docker Images (CI)\n\n<span class=\"token key atrule\">on</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">push</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">branches</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>master<span class=\"token punctuation\">]</span>\n\n<span class=\"token key atrule\">jobs</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">deploy</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> CI\n    <span class=\"token key atrule\">runs-on</span><span class=\"token punctuation\">:</span> ubuntu<span class=\"token punctuation\">-</span>latest\n\n    <span class=\"token key atrule\">steps</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Checkout Repository\n        <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> actions/checkout@v4\n\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Set up Docker Buildx\n        <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> docker/setup<span class=\"token punctuation\">-</span>buildx<span class=\"token punctuation\">-</span>action@v3\n\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Login to DockerHub\n        <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> docker/login<span class=\"token punctuation\">-</span>action@v3\n        <span class=\"token key atrule\">with</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">username</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.DOCKERHUB_USERNAME <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n          <span class=\"token key atrule\">password</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.DOCKERHUB_PASSWORD <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n\n      <span class=\"token comment\"># Build and push API</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Build and Push lottery_api_server Image\n        <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">|</span><span class=\"token scalar string\">\n          docker build -t ${{ secrets.DOCKERHUB_USERNAME }}/lottery_api_server:latest ./api\n          docker push ${{ secrets.DOCKERHUB_USERNAME }}/lottery_api_server:latest</span>\n\n      <span class=\"token comment\"># Build and push Crawler</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Build and Push lottery_crawler_server Image\n        <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">|</span><span class=\"token scalar string\">\n          docker build -t ${{ secrets.DOCKERHUB_USERNAME }}/lottery_crawler_server:latest ./crawler\n          docker push ${{ secrets.DOCKERHUB_USERNAME }}/lottery_crawler_server:latest</span>\n\n      <span class=\"token comment\"># Build and push Website</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Build and Push lottery_website Image\n        <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">|</span><span class=\"token scalar string\">\n          docker build -t ${{ secrets.DOCKERHUB_USERNAME }}/lottery_website:latest ./website\n          docker push ${{ secrets.DOCKERHUB_USERNAME }}/lottery_website:latest</span></code></pre></div>\n<br>\n<br>\n<h4 id=\"3-2-cdyml\" style=\"position:relative;\"><a href=\"#3-2-cdyml\" aria-label=\"3 2 cdyml permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3-2. cd.yml</h4>\n<hr>\n<div class=\"gatsby-highlight\" data-language=\"yml\"><pre class=\"language-yml\"><code class=\"language-yml\"><span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Deploy to NAS (CD)\n\n<span class=\"token key atrule\">on</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">pull_request</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">branches</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>prod<span class=\"token punctuation\">]</span>\n\n<span class=\"token key atrule\">jobs</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">deploy</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Deploy to NAS\n    <span class=\"token key atrule\">runs-on</span><span class=\"token punctuation\">:</span> ubuntu<span class=\"token punctuation\">-</span>latest\n\n    <span class=\"token key atrule\">steps</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Connect to NAS via SSH and deploy\n        <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> appleboy/ssh<span class=\"token punctuation\">-</span>action@v0.1.6\n        <span class=\"token key atrule\">with</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">host</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.NAS_HOST <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n          <span class=\"token key atrule\">username</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.NAS_USER <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n          <span class=\"token key atrule\">password</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.NAS_PASSWORD <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n          <span class=\"token key atrule\">port</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.NAS_PORT <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n          <span class=\"token key atrule\">script</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">|</span><span class=\"token scalar string\">\n            echo \"✅ NAS 접속 성공\"</span>\n\n            cd /volume1/docker/lottery\n\n            echo \"📦 COMMON .env 생성\"\n            <span class=\"token punctuation\">[</span> <span class=\"token punctuation\">-</span>f .env <span class=\"token punctuation\">]</span> <span class=\"token important\">&amp;&amp;</span> rm .env\n            cat &lt;&lt;EOF <span class=\"token punctuation\">></span> .env\n            NODE_ENV=$<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.NODE_ENV <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n            API_SERVER_PORT=$<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.API_SERVER_PORT <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n            CRAWLER_SERVER_PORT=$<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.CRAWLER_SERVER_PORT <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n            WEBSITE_PORT=$<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.WEBSITE_PORT <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n            EOF\n\n            echo \"📦 API .env 생성\"\n            mkdir <span class=\"token punctuation\">-</span>p ./api\n            <span class=\"token punctuation\">[</span> <span class=\"token punctuation\">-</span>f ./api/.env <span class=\"token punctuation\">]</span> <span class=\"token important\">&amp;&amp;</span> rm ./api/.env\n            cat &lt;&lt;EOF <span class=\"token punctuation\">></span> ./api/.env\n            DB_HOST=$<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.DB_HOST <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n            DB_PORT=$<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.DB_PORT <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n            DB_USER=$<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.DB_USER <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n            DB_PASSWORD=$<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.DB_PASSWORD <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n            DB_DATABASE=$<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.DB_DATABASE <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n            API_NODE_ENV=$<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.API_NODE_ENV <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n            API_SERVER_PORT=$<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.API_SERVER_PORT <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n            API_EMAIL_USERNAME=$<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.API_EMAIL_USERNAME <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n            API_EMAIL_PASSWORD=$<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.API_EMAIL_PASSWORD <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n            API_EMAIL_HOST=$<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.API_EMAIL_HOST <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n            API_EMAIL_PORT=$<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.API_EMAIL_PORT <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n            API_EMAIL_FROM=$<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.API_EMAIL_FROM <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n            API_REDIS_HOST=$<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.API_REDIS_HOST <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n            API_REDIS_PORT=$<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.API_REDIS_PORT <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n            API_SLACK_SIGNING_SECRET=$<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.API_SLACK_SIGNING_SECRET <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n            API_SLACK_BOT_TOKEN=$<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.API_SLACK_BOT_TOKEN <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n            API_SLACK_CLIENT_ID=$<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.API_SLACK_CLIENT_ID <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n            API_SLACK_CLIENT_SECRET=$<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.API_SLACK_CLIENT_SECRET <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n            COMMON_GITHUB_TOKEN=$<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.COMMON_GITHUB_TOKEN <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n            SWAGGER_USERNAME=$<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.SWAGGER_USERNAME <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n            SWAGGER_PASSWORD=$<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.SWAGGER_PASSWORD <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n            EOF\n\n            echo \"📦 CRAWLER .env 생성\"\n            mkdir <span class=\"token punctuation\">-</span>p ./crawler\n            <span class=\"token punctuation\">[</span> <span class=\"token punctuation\">-</span>f ./crawler/.env <span class=\"token punctuation\">]</span> <span class=\"token important\">&amp;&amp;</span> rm ./crawler/.env\n            cat &lt;&lt;EOF <span class=\"token punctuation\">></span> ./crawler/.env\n            DB_HOST=$<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.DB_HOST <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n            DB_PORT=$<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.DB_PORT <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n            DB_USER=$<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.DB_USER <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n            DB_PASSWORD=$<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.DB_PASSWORD <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n            DB_DATABASE=$<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.DB_DATABASE <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n            CRAWLER_SERVER_PORT=$<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.CRAWLER_SERVER_PORT <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n            COMMON_GITHUB_TOKEN=$<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.COMMON_GITHUB_TOKEN <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n            EOF\n\n            echo \"🌀 GitHub prod 브랜치 코드 최신화\"\n            git fetch origin\n            git reset <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>hard origin/prod\n\n            echo \"📁 필요한 디렉토리 생성\"\n            mkdir <span class=\"token punctuation\">-</span>p ./api/logs ./api/public ./api/resource\n            mkdir <span class=\"token punctuation\">-</span>p ./crawler/logs ./crawler/public ./crawler/resource\n            mkdir <span class=\"token punctuation\">-</span>p ./redis<span class=\"token punctuation\">-</span>data\n\n            echo \"🐳 Docker 이미지 Pull\"\n            /usr/local/bin/docker<span class=\"token punctuation\">-</span>compose pull\n\n            echo \"🧨 기존 컨테이너 중지\"\n            /usr/local/bin/docker<span class=\"token punctuation\">-</span>compose down\n\n            echo \"🚀 최신 이미지로 컨테이너 재시작\"\n            /usr/local/bin/docker<span class=\"token punctuation\">-</span>compose up <span class=\"token punctuation\">-</span>d\n\n            echo \"✅ 배포 완료 🎉\"</code></pre></div>\n<br>\n<br>\n<h2 id=\"-understanding\" style=\"position:relative;\"><a href=\"#-understanding\" aria-label=\" understanding permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>🤔 Understanding</h2>\n<p>사진이나 중요 자료 백업 목적으로 구매했던 NAS를 다양하게 활용할 수 있는 방법을 알게되었다. (또한, 얼마 안되지만 EC2로 매달 나가는 비용을 아낄 수 있게 되었다.)</p>\n<p>NAS의 스펙이 그리 좋지 않기에 훌륭한 서버까진 아니지만, 토이 프로젝트 정도는 거뜬히 소화할 수 있을거같다. (훌륭한 장난감이 생겼다 😀)</p>\n<p>EC2에서 Synology NAS로 옮겨온 이번 과정에서 가장 크게 느낀 점은, <strong>결국 중요한 건 도구가 아니라 흐름에 대한 이해</strong>를 하는게 가장 중요하다는 점이었다. 언어나 특정 프레임워크에 종속되지 말고 전반적인 CS 지식을 조금 더 공부해보고 싶어졌다.</p>\n<br>\n<br>\n<div class=\"table-of-contents\">\n<ul>\n<li>\n<p><a href=\"#%EC%99%9C-ec2%EC%97%90%EC%84%9C-nas%EB%A1%9C-%EC%98%AE%EA%B8%B0%EA%B2%8C-%EB%90%98%EC%97%88%EB%8A%94%EA%B0%80\">왜 EC2에서 NAS로 옮기게 되었는가?</a></p>\n<ul>\n<li>\n<p><a href=\"#1-cicd-%ED%8C%8C%EC%9D%B4%ED%94%84%EB%9D%BC%EC%9D%B8-%EA%B5%AC%EC%84%B1\">1. CI/CD 파이프라인 구성</a></p>\n</li>\n<li>\n<p><a href=\"#2-nas%EC%97%90%EC%84%9C-%ED%99%98%EA%B2%BD-%EA%B5%AC%EC%84%B1\">2. NAS에서 환경 구성</a></p>\n<ul>\n<li><a href=\"#2-1-container-manager-%ED%8C%A8%ED%82%A4%EC%A7%80-%EC%84%A4%EC%B9%98\">2-1. Container Manager 패키지 설치</a></li>\n<li><a href=\"#2-2-git-server-%ED%8C%A8%ED%82%A4%EC%A7%80-%EC%84%A4%EC%B9%98\">2-2. Git Server 패키지 설치</a></li>\n<li><a href=\"#2-3-nas%EC%9D%98-ssh-%EC%9B%90%EA%B2%A9-%EC%A0%91%EC%86%8D-%ED%8F%AC%ED%8A%B8-%ED%97%88%EC%9A%A9\">2-3. NAS의 SSH 원격 접속 포트 허용</a></li>\n<li><a href=\"#2-4-nas%EC%9D%98-%EC%97%AD%EB%B0%A9%ED%96%A5-%ED%94%84%EB%A1%9D%EC%8B%9C-%EC%84%A4%EC%A0%95\">2-4. NAS의 역방향 프록시 설정</a></li>\n<li><a href=\"#2-4-%EA%B3%B5%EC%9C%A0%EA%B8%B0-%ED%8F%AC%ED%8A%B8%ED%8F%AC%EC%9B%8C%EB%94%A9-%EC%84%A4%EC%A0%95\">2-4. 공유기 포트포워딩 설정</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#3-github-actions-%EC%82%B4%ED%8E%B4%EB%B3%B4%EA%B8%B0\">3. GitHub Actions 살펴보기</a></p>\n<ul>\n<li><a href=\"#3-1-ciyml\">3-1. ci.yml</a></li>\n<li><a href=\"#3-2-cdyml\">3-2. cd.yml</a></li>\n</ul>\n</li>\n</ul>\n</li>\n<li>\n<p><a href=\"#-understanding\">🤔 Understanding</a></p>\n</li>\n</ul>\n</div>","frontmatter":{"date":"March 31, 2025","title":"EC2에서 NAS로, 개인 서버 CI/CD 자동화","categories":"Project","author":"JH8459","emoji":"🔥"},"fields":{"slug":"/2025-03-31-TIL/"}},"site":{"siteMetadata":{"siteUrl":"https://blog.jh8459.com","comments":{"utterances":{"repo":"JH8459/JH8459.github.io"}}}}},"pageContext":{"slug":"/2025-03-19-TIL/","nextSlug":"/2025-03-16-TIL/","prevSlug":"/2025-03-31-TIL/"}},"staticQueryHashes":["1073350324","1956554647","2938748437"]}