{"componentChunkName":"component---src-templates-blog-template-js","path":"/2025-03-31-TIL/","result":{"data":{"cur":{"id":"6b675222-de1f-5125-a53e-fc1fe726bfed","html":"<img src=\"https://jh8459.s3.ap-northeast-2.amazonaws.com/blog/2025-03-31-PROJECT/banner.png\">\n<br>\n<h2 id=\"왜-ec2에서-nas로-옮기게-되었는가\" style=\"position:relative;\"><a href=\"#%EC%99%9C-ec2%EC%97%90%EC%84%9C-nas%EB%A1%9C-%EC%98%AE%EA%B8%B0%EA%B2%8C-%EB%90%98%EC%97%88%EB%8A%94%EA%B0%80\" aria-label=\"왜 ec2에서 nas로 옮기게 되었는가 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>왜 EC2에서 NAS로 옮기게 되었는가?</h2>\n<p>사용 중인 NAS의 사용성이 DSM 7.2+ (Synology사의 DS920+ 기준) 부터 많이 달라졌다. 단순히 UI/UX만 변경된것이 아니라 (구)Docker 패키지에서 변경된 <strong>Container Manager 패키지</strong>는 다중 컨테이너 환경을 지원한다.</p>\n<br>\n<img src=\"https://jh8459.s3.ap-northeast-2.amazonaws.com/blog/2025-03-31-PROJECT/container_manager.jpg\">\n<center>Docker Compose! 😲</center><br><br>\n<p>EC2 t2.micro 인스턴스로 사용 중이던 서버에 올려둔 컨테이너 기반의 <a href=\"https://blog.jh8459.com/2024-07-01-PROJECT/\" target=\"_blank\">프로젝트 (LOTTERY 🍀)</a>를 비용 효율적인 측면에서 마이그레이션하기 좋은 기회라 생각했다.</p>\n<p>EC2에서 NAS로 마이그레이션하는 과정과 Github Action + Docker Hub를 사용한 CI / CD 구축한 과정 또한 간략히 남겨 보려한다.</p>\n<br>\n<br>\n<h3 id=\"1-cicd-파이프라인-구성\" style=\"position:relative;\"><a href=\"#1-cicd-%ED%8C%8C%EC%9D%B4%ED%94%84%EB%9D%BC%EC%9D%B8-%EA%B5%AC%EC%84%B1\" aria-label=\"1 cicd 파이프라인 구성 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. CI/CD 파이프라인 구성</h3>\n<hr>\n<p>전반적인 CI/CD는 <strong>Github Action</strong> + <strong>Docker Hub</strong> 를 활용하였으며, CI / CD 나누어 Github 저장소의 브런치를 활용해서 파이프라인을 구성하였다. (CI/CD 모두를 자동화는 아래와 같은 무중단 배포 전략까지 도입 후 수정할 예정이다.)</p>\n<blockquote>\n<p>👉 <a href=\"https://blog.jh8459.com/2025-03-16-TIL/\" target=\"_blank\">Docker Compose와 Traefik을 활용한 Blue/Green 배포 전략</a></p>\n</blockquote>\n<br>\n<img src=\"https://jh8459.s3.ap-northeast-2.amazonaws.com/blog/2025-03-31-PROJECT/pipeline.png\">\n<center>전반적인 CI/CD 흐름은 위 사진과 같이 진행된다. 🤖</center><br><br>\n<ol>\n<li>\n<p>Local Repository에서 작업한 결과물을 Github 원격 Remote Repository의 <code class=\"language-text\">master</code> 브런치로 Push 한다.</p>\n</li>\n<li>\n<p><code class=\"language-text\">master</code> 브런치로 Commit이 Push되면 아래의 조건을 갖는 Github Action <strong>(CI)</strong> 이 동작한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"yml\"><pre class=\"language-yml\"><code class=\"language-yml\"><span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Build &amp; Push Docker Images (CI)\n\n<span class=\"token key atrule\">on</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">push</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">branches</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'master'</span><span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">...</span></code></pre></div>\n</li>\n<li>\n<p>Github Action Runner를 통해서 <code class=\"language-text\">master</code> 브런치에 올라간 코드를 기반으로 Docker Image가 빌드되고 빌드 성공시 Docker Hub에 Push한다.</p>\n</li>\n<li>\n<p>Github Action <strong>(CI)</strong> 이 성공하면 배포 준비가 완료된 상태이다. 배포가 필요하다면 <code class=\"language-text\">prod</code> 브런치로 PR을 날린다.</p>\n</li>\n<li>\n<p><code class=\"language-text\">prod</code> 브런치로 PR이 Merge되면 아래의 조건을 갖는 Github Action <strong>(CD)</strong> 이 동작한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"yml\"><pre class=\"language-yml\"><code class=\"language-yml\"><span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Deploy to NAS (CD)\n\n<span class=\"token key atrule\">on</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">pull_request</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">branches</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'prod'</span><span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">...</span></code></pre></div>\n</li>\n<li>\n<p>Github Action Runner를 통해서 NAS에 SSH접속이 이뤄지며 운영 환경에 알맞는 <code class=\"language-text\">.env</code> 환경변수 파일을 생성한다.</p>\n</li>\n<li>\n<p>Docker Hub에 올라간 Docker Image를 기반으로 NAS 서버에 배포를 진행한다.</p>\n</li>\n</ol>\n<br>\n<br>\n<h3 id=\"2-nas에서-환경-구성\" style=\"position:relative;\"><a href=\"#2-nas%EC%97%90%EC%84%9C-%ED%99%98%EA%B2%BD-%EA%B5%AC%EC%84%B1\" aria-label=\"2 nas에서 환경 구성 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2. NAS에서 환경 구성</h3>\n<hr>\n<p>위에서 언급한 CI/CD 파이프라인을 구성하려면 NAS에도 아래와 같은 환경 구성이 필요하다.</p>\n<blockquote>\n<p>이용 중인 NAS의 OS는 <strong>Ubuntu OS</strong>가 아닌 Synology에서 개발된 자체 OS인 <strong>DSM</strong>을 사용하기 때문에, <code class=\"language-text\">sudo apt-get install git</code> 같은 CLI 명령어가 아닌 DSM 패키지 센터를 통해 아래와 같은 환경을 구성해줘야 한다.</p>\n</blockquote>\n<br>\n<br>\n<h4 id=\"2-1-container-manager-패키지-설치\" style=\"position:relative;\"><a href=\"#2-1-container-manager-%ED%8C%A8%ED%82%A4%EC%A7%80-%EC%84%A4%EC%B9%98\" aria-label=\"2 1 container manager 패키지 설치 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2-1. Container Manager 패키지 설치</h4>\n<hr>\n<p>전반적인 <strong>Container Manager</strong>를 활용한 NAS 환경 구성은 서버 포럼의<a href=\"https://svrforum.com/nas/695302\" target=\"_blank\">“이제 시놀로지에서 Docker-compose를(?) DSM 7.2의 Container Mananger”</a>게시글을 보고 구성하였다. 🙏🙏🙏</p>\n<p>volume을 설정할때 디렉토리는 추후 <strong>docker-compose.yml</strong> 파일이 수정되는 경우에도 Github 원격 저장소의 <code class=\"language-text\">prod</code> 브런치의 코드를 내려받아 최신화되어야한다. (이를 염두하고 설정하자.)</p>\n<img src=\"https://jh8459.s3.ap-northeast-2.amazonaws.com/blog/2025-03-31-PROJECT/volume.png\">\n<br>\n<br>\n<h4 id=\"2-2-git-server-패키지-설치\" style=\"position:relative;\"><a href=\"#2-2-git-server-%ED%8C%A8%ED%82%A4%EC%A7%80-%EC%84%A4%EC%B9%98\" aria-label=\"2 2 git server 패키지 설치 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2-2. Git Server 패키지 설치</h4>\n<hr>\n<p>CLI 명령으로 설치가 안되므로 DSM 패키지 센터의 <strong>Git Server</strong> 패키지를 내려 받아야 한다.</p>\n<img src=\"https://jh8459.s3.ap-northeast-2.amazonaws.com/blog/2025-03-31-PROJECT/git.png\">\n<br>\n<br>\n<h4 id=\"2-3-nas의-ssh-원격-접속-포트-허용\" style=\"position:relative;\"><a href=\"#2-3-nas%EC%9D%98-ssh-%EC%9B%90%EA%B2%A9-%EC%A0%91%EC%86%8D-%ED%8F%AC%ED%8A%B8-%ED%97%88%EC%9A%A9\" aria-label=\"2 3 nas의 ssh 원격 접속 포트 허용 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2-3. NAS의 SSH 원격 접속 포트 허용</h4>\n<hr>\n<p>CI/CD 과정에서 Github Action 통해서 NAS로 SSH 접속이 이뤄져야 하므로 해당 옵션을 허용해주자.</p>\n<img src=\"https://jh8459.s3.ap-northeast-2.amazonaws.com/blog/2025-03-31-PROJECT/ssh.png\">\n<br>\n<br>\n<h4 id=\"2-4-nas의-역방향-프록시-설정\" style=\"position:relative;\"><a href=\"#2-4-nas%EC%9D%98-%EC%97%AD%EB%B0%A9%ED%96%A5-%ED%94%84%EB%A1%9D%EC%8B%9C-%EC%84%A4%EC%A0%95\" aria-label=\"2 4 nas의 역방향 프록시 설정 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2-4. NAS의 역방향 프록시 설정</h4>\n<hr>\n<p>Ubuntu OS에서 웹 서버를 구성할 땐 <strong>traefik</strong> 혹은 <strong>nginx</strong>를 사용하여 역방향 프록시(Reverse Proxy) 서버 구성을 하였지만, DSM 기본 기능인 역방향 프록시 기능을 사용하여 도메인 소스와 NAS 내부 서비스를 맵핑 시켜주었다.</p>\n<img src=\"https://jh8459.s3.ap-northeast-2.amazonaws.com/blog/2025-03-31-PROJECT/reverse.png\">\n<br>\n<br>\n<h4 id=\"2-4-공유기-포트포워딩-설정\" style=\"position:relative;\"><a href=\"#2-4-%EA%B3%B5%EC%9C%A0%EA%B8%B0-%ED%8F%AC%ED%8A%B8%ED%8F%AC%EC%9B%8C%EB%94%A9-%EC%84%A4%EC%A0%95\" aria-label=\"2 4 공유기 포트포워딩 설정 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2-4. 공유기 포트포워딩 설정</h4>\n<hr>\n<p>홈 네트워크는 보통 공유기를 사용중일텐데 외부망을 통해 NAS에서 실행중인 어플리케이션에 도달하려면 공유기의 포트 포워딩 규칙을 허용해줘야 한다.</p>\n<p>어플리케이션이 NAS의 1111번 포트를 사용중이라면 아래와 같은 규칙을 허용해주어야 한다.</p>\n<p><img src=\"https://jh8459.s3.ap-northeast-2.amazonaws.com/blog/2025-03-31-PROJECT/port.png\"><br></p>\n<br>\n<br>\n<h3 id=\"3-github-actions-살펴보기\" style=\"position:relative;\"><a href=\"#3-github-actions-%EC%82%B4%ED%8E%B4%EB%B3%B4%EA%B8%B0\" aria-label=\"3 github actions 살펴보기 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3. GitHub Actions 살펴보기</h3>\n<hr>\n<p>기본적으로 <strong>Public</strong> 저장소이기 때문에 노출되면 안되는 값들은 Github Repository에서 제공하는 환경 변수를 통해 변인 요인들을 관리하고 있다.</p>\n<p>Github Action은 CI/CD 파이프라인이 모두 자동화되고 있진 않으므로 이미지 빌드를 담당하는 <strong>ci.yml</strong>과 NAS로 원격 접속하여 배포를 진행하는 <strong>cd.yml</strong> 두개로 분리하여 구성하였다.</p>\n<br>\n<br>\n<h4 id=\"3-1-ciyml\" style=\"position:relative;\"><a href=\"#3-1-ciyml\" aria-label=\"3 1 ciyml permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3-1. ci.yml</h4>\n<hr>\n<div class=\"gatsby-highlight\" data-language=\"yml\"><pre class=\"language-yml\"><code class=\"language-yml\"><span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Build &amp; Push Docker Images (CI)\n\n<span class=\"token key atrule\">on</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">push</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">branches</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>master<span class=\"token punctuation\">]</span>\n\n<span class=\"token key atrule\">jobs</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">deploy</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> CI\n    <span class=\"token key atrule\">runs-on</span><span class=\"token punctuation\">:</span> ubuntu<span class=\"token punctuation\">-</span>latest\n\n    <span class=\"token key atrule\">steps</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Checkout Repository\n        <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> actions/checkout@v4\n\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Set up Docker Buildx\n        <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> docker/setup<span class=\"token punctuation\">-</span>buildx<span class=\"token punctuation\">-</span>action@v3\n\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Login to DockerHub\n        <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> docker/login<span class=\"token punctuation\">-</span>action@v3\n        <span class=\"token key atrule\">with</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">username</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.DOCKERHUB_USERNAME <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n          <span class=\"token key atrule\">password</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.DOCKERHUB_PASSWORD <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n\n      <span class=\"token comment\"># Build and push API</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Build and Push lottery_api_server Image\n        <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">|</span><span class=\"token scalar string\">\n          docker build -t ${{ secrets.DOCKERHUB_USERNAME }}/lottery_api_server:latest ./api\n          docker push ${{ secrets.DOCKERHUB_USERNAME }}/lottery_api_server:latest</span>\n\n      <span class=\"token comment\"># Build and push Crawler</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Build and Push lottery_crawler_server Image\n        <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">|</span><span class=\"token scalar string\">\n          docker build -t ${{ secrets.DOCKERHUB_USERNAME }}/lottery_crawler_server:latest ./crawler\n          docker push ${{ secrets.DOCKERHUB_USERNAME }}/lottery_crawler_server:latest</span>\n\n      <span class=\"token comment\"># Build and push Website</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Build and Push lottery_website Image\n        <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">|</span><span class=\"token scalar string\">\n          docker build -t ${{ secrets.DOCKERHUB_USERNAME }}/lottery_website:latest ./website\n          docker push ${{ secrets.DOCKERHUB_USERNAME }}/lottery_website:latest</span></code></pre></div>\n<br>\n<br>\n<h4 id=\"3-2-cdyml\" style=\"position:relative;\"><a href=\"#3-2-cdyml\" aria-label=\"3 2 cdyml permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3-2. cd.yml</h4>\n<hr>\n<div class=\"gatsby-highlight\" data-language=\"yml\"><pre class=\"language-yml\"><code class=\"language-yml\"><span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Deploy to NAS (CD)\n\n<span class=\"token key atrule\">on</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">pull_request</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">branches</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>prod<span class=\"token punctuation\">]</span>\n\n<span class=\"token key atrule\">jobs</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">deploy</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Deploy to NAS\n    <span class=\"token key atrule\">runs-on</span><span class=\"token punctuation\">:</span> ubuntu<span class=\"token punctuation\">-</span>latest\n\n    <span class=\"token key atrule\">steps</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Connect to NAS via SSH and deploy\n        <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> appleboy/ssh<span class=\"token punctuation\">-</span>action@v0.1.6\n        <span class=\"token key atrule\">with</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">host</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.NAS_HOST <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n          <span class=\"token key atrule\">username</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.NAS_USER <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n          <span class=\"token key atrule\">password</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.NAS_PASSWORD <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n          <span class=\"token key atrule\">port</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.NAS_PORT <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n          <span class=\"token key atrule\">script</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">|</span><span class=\"token scalar string\">\n            echo \"✅ NAS 접속 성공\"</span>\n\n            cd /volume1/docker/lottery\n\n            echo \"📦 COMMON .env 생성\"\n            <span class=\"token punctuation\">[</span> <span class=\"token punctuation\">-</span>f .env <span class=\"token punctuation\">]</span> <span class=\"token important\">&amp;&amp;</span> rm .env\n            cat &lt;&lt;EOF <span class=\"token punctuation\">></span> .env\n            NODE_ENV=$<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.NODE_ENV <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n            API_SERVER_PORT=$<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.API_SERVER_PORT <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n            CRAWLER_SERVER_PORT=$<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.CRAWLER_SERVER_PORT <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n            WEBSITE_PORT=$<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.WEBSITE_PORT <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n            EOF\n\n            echo \"📦 API .env 생성\"\n            mkdir <span class=\"token punctuation\">-</span>p ./api\n            <span class=\"token punctuation\">[</span> <span class=\"token punctuation\">-</span>f ./api/.env <span class=\"token punctuation\">]</span> <span class=\"token important\">&amp;&amp;</span> rm ./api/.env\n            cat &lt;&lt;EOF <span class=\"token punctuation\">></span> ./api/.env\n            DB_HOST=$<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.DB_HOST <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n            DB_PORT=$<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.DB_PORT <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n            DB_USER=$<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.DB_USER <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n            DB_PASSWORD=$<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.DB_PASSWORD <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n            DB_DATABASE=$<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.DB_DATABASE <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n            API_NODE_ENV=$<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.API_NODE_ENV <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n            API_SERVER_PORT=$<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.API_SERVER_PORT <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n            API_EMAIL_USERNAME=$<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.API_EMAIL_USERNAME <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n            API_EMAIL_PASSWORD=$<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.API_EMAIL_PASSWORD <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n            API_EMAIL_HOST=$<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.API_EMAIL_HOST <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n            API_EMAIL_PORT=$<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.API_EMAIL_PORT <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n            API_EMAIL_FROM=$<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.API_EMAIL_FROM <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n            API_REDIS_HOST=$<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.API_REDIS_HOST <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n            API_REDIS_PORT=$<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.API_REDIS_PORT <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n            API_SLACK_SIGNING_SECRET=$<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.API_SLACK_SIGNING_SECRET <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n            API_SLACK_BOT_TOKEN=$<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.API_SLACK_BOT_TOKEN <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n            API_SLACK_CLIENT_ID=$<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.API_SLACK_CLIENT_ID <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n            API_SLACK_CLIENT_SECRET=$<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.API_SLACK_CLIENT_SECRET <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n            COMMON_GITHUB_TOKEN=$<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.COMMON_GITHUB_TOKEN <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n            SWAGGER_USERNAME=$<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.SWAGGER_USERNAME <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n            SWAGGER_PASSWORD=$<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.SWAGGER_PASSWORD <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n            EOF\n\n            echo \"📦 CRAWLER .env 생성\"\n            mkdir <span class=\"token punctuation\">-</span>p ./crawler\n            <span class=\"token punctuation\">[</span> <span class=\"token punctuation\">-</span>f ./crawler/.env <span class=\"token punctuation\">]</span> <span class=\"token important\">&amp;&amp;</span> rm ./crawler/.env\n            cat &lt;&lt;EOF <span class=\"token punctuation\">></span> ./crawler/.env\n            DB_HOST=$<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.DB_HOST <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n            DB_PORT=$<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.DB_PORT <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n            DB_USER=$<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.DB_USER <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n            DB_PASSWORD=$<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.DB_PASSWORD <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n            DB_DATABASE=$<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.DB_DATABASE <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n            CRAWLER_SERVER_PORT=$<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.CRAWLER_SERVER_PORT <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n            COMMON_GITHUB_TOKEN=$<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.COMMON_GITHUB_TOKEN <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n            EOF\n\n            echo \"🌀 GitHub prod 브랜치 코드 최신화\"\n            git fetch origin\n            git reset <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>hard origin/prod\n\n            echo \"📁 필요한 디렉토리 생성\"\n            mkdir <span class=\"token punctuation\">-</span>p ./api/logs ./api/public ./api/resource\n            mkdir <span class=\"token punctuation\">-</span>p ./crawler/logs ./crawler/public ./crawler/resource\n            mkdir <span class=\"token punctuation\">-</span>p ./redis<span class=\"token punctuation\">-</span>data\n\n            echo \"🐳 Docker 이미지 Pull\"\n            /usr/local/bin/docker<span class=\"token punctuation\">-</span>compose pull\n\n            echo \"🧨 기존 컨테이너 중지\"\n            /usr/local/bin/docker<span class=\"token punctuation\">-</span>compose down\n\n            echo \"🚀 최신 이미지로 컨테이너 재시작\"\n            /usr/local/bin/docker<span class=\"token punctuation\">-</span>compose up <span class=\"token punctuation\">-</span>d\n\n            echo \"✅ 배포 완료 🎉\"</code></pre></div>\n<br>\n<br>\n<h2 id=\"-understanding\" style=\"position:relative;\"><a href=\"#-understanding\" aria-label=\" understanding permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>🤔 Understanding</h2>\n<p>사진이나 중요 자료 백업 목적으로 구매했던 NAS를 다양하게 활용할 수 있는 방법을 알게되었다. (또한, 얼마 안되지만 EC2로 매달 나가는 비용을 아낄 수 있게 되었다.)</p>\n<p>NAS의 스펙이 그리 좋지 않기에 훌륭한 서버까진 아니지만, 토이 프로젝트 정도는 거뜬히 소화할 수 있을거같다. (훌륭한 장난감이 생겼다 😀)</p>\n<p>EC2에서 Synology NAS로 옮겨온 이번 과정에서 가장 크게 느낀 점은, <strong>결국 중요한 건 도구가 아니라 흐름에 대한 이해</strong>를 하는게 가장 중요하다는 점이었다. 언어나 특정 프레임워크에 종속되지 말고 전반적인 CS 지식을 조금 더 공부해보고 싶어졌다.</p>\n<br>\n<br>\n<div class=\"table-of-contents\">\n<ul>\n<li>\n<p><a href=\"#%EC%99%9C-ec2%EC%97%90%EC%84%9C-nas%EB%A1%9C-%EC%98%AE%EA%B8%B0%EA%B2%8C-%EB%90%98%EC%97%88%EB%8A%94%EA%B0%80\">왜 EC2에서 NAS로 옮기게 되었는가?</a></p>\n<ul>\n<li>\n<p><a href=\"#1-cicd-%ED%8C%8C%EC%9D%B4%ED%94%84%EB%9D%BC%EC%9D%B8-%EA%B5%AC%EC%84%B1\">1. CI/CD 파이프라인 구성</a></p>\n</li>\n<li>\n<p><a href=\"#2-nas%EC%97%90%EC%84%9C-%ED%99%98%EA%B2%BD-%EA%B5%AC%EC%84%B1\">2. NAS에서 환경 구성</a></p>\n<ul>\n<li><a href=\"#2-1-container-manager-%ED%8C%A8%ED%82%A4%EC%A7%80-%EC%84%A4%EC%B9%98\">2-1. Container Manager 패키지 설치</a></li>\n<li><a href=\"#2-2-git-server-%ED%8C%A8%ED%82%A4%EC%A7%80-%EC%84%A4%EC%B9%98\">2-2. Git Server 패키지 설치</a></li>\n<li><a href=\"#2-3-nas%EC%9D%98-ssh-%EC%9B%90%EA%B2%A9-%EC%A0%91%EC%86%8D-%ED%8F%AC%ED%8A%B8-%ED%97%88%EC%9A%A9\">2-3. NAS의 SSH 원격 접속 포트 허용</a></li>\n<li><a href=\"#2-4-nas%EC%9D%98-%EC%97%AD%EB%B0%A9%ED%96%A5-%ED%94%84%EB%A1%9D%EC%8B%9C-%EC%84%A4%EC%A0%95\">2-4. NAS의 역방향 프록시 설정</a></li>\n<li><a href=\"#2-4-%EA%B3%B5%EC%9C%A0%EA%B8%B0-%ED%8F%AC%ED%8A%B8%ED%8F%AC%EC%9B%8C%EB%94%A9-%EC%84%A4%EC%A0%95\">2-4. 공유기 포트포워딩 설정</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#3-github-actions-%EC%82%B4%ED%8E%B4%EB%B3%B4%EA%B8%B0\">3. GitHub Actions 살펴보기</a></p>\n<ul>\n<li><a href=\"#3-1-ciyml\">3-1. ci.yml</a></li>\n<li><a href=\"#3-2-cdyml\">3-2. cd.yml</a></li>\n</ul>\n</li>\n</ul>\n</li>\n<li>\n<p><a href=\"#-understanding\">🤔 Understanding</a></p>\n</li>\n</ul>\n</div>","excerpt":"왜 EC2에서 NAS로 옮기게 되었는가? 사용 중인 NAS의 사용성이 DSM 7.2+ (Synology사의 DS920+ 기준) 부터 많이 달라졌다. 단순히 UI/UX만 변경된것이 아니라 (구)Docker 패키지에서 변경된 Container Manager 패키지는 다중 컨테이너 환경을 지원한다. EC2 t2.micro 인스턴스로 사용 중이던 서버에 올려둔 컨테이너 기반의 프로젝트 (LOTTERY 🍀)를 비용 효율적인 측면에서 마이그레이션하기 좋은 기회라 생각했다. EC2에서 NAS로 마이그레이션하는 과정과 Github Action + Docker Hub를 사용한 CI / CD 구축한 과정 또한 간략히 남겨 보려한다. 1. CI/CD 파이프라인 구성 전반적인 CI/CD는 Github Action + Docker Hub 를 활용하였으며, CI / CD 나누어 Github 저장소의 브런치를 활용해서 파이프라인을 구성하였다. (CI/CD 모두를 자동화는 아래와 같은 무중단 배포 전략까지 도…","frontmatter":{"date":"March 31, 2025","title":"EC2에서 NAS로, 개인 서버 CI/CD 자동화","categories":"Project","author":"JH8459","emoji":"🔥"},"fields":{"slug":"/2025-03-31-TIL/"}},"next":{"id":"53e1d582-9345-5f06-aa93-b8447eb29772","html":"<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 56.666666666666664%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAALABQDASIAAhEBAxEB/8QAFwAAAwEAAAAAAAAAAAAAAAAAAAECA//EABUBAQEAAAAAAAAAAAAAAAAAAAAF/9oADAMBAAIQAxAAAAHSaSawD//EABYQAAMAAAAAAAAAAAAAAAAAAAABIP/aAAgBAQABBQIU/wD/xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/AT//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/AT//xAAWEAADAAAAAAAAAAAAAAAAAAAAIDH/2gAIAQEABj8CIv8A/8QAGBAAAgMAAAAAAAAAAAAAAAAAAAERIDH/2gAIAQEAAT8hGb2Ff//aAAwDAQACAAMAAAAQHD//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAEDAQE/ED//xAAUEQEAAAAAAAAAAAAAAAAAAAAQ/9oACAECAQE/ED//xAAZEAACAwEAAAAAAAAAAAAAAAABEQAgQVH/2gAIAQEAAT8QjVhju1//2Q=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"github-blog.png\"\n        title=\"github-blog.png\"\n        src=\"/static/7c4bbfe7d1a9d6bc02891c94bfe039dc/80e3c/TIL.jpg\"\n        srcset=\"/static/7c4bbfe7d1a9d6bc02891c94bfe039dc/4ec73/TIL.jpg 180w,\n/static/7c4bbfe7d1a9d6bc02891c94bfe039dc/158ba/TIL.jpg 360w,\n/static/7c4bbfe7d1a9d6bc02891c94bfe039dc/80e3c/TIL.jpg 720w,\n/static/7c4bbfe7d1a9d6bc02891c94bfe039dc/47311/TIL.jpg 1080w,\n/static/7c4bbfe7d1a9d6bc02891c94bfe039dc/ac614/TIL.jpg 1272w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<br>\n<h2 id=\"️-today-i-learned\" style=\"position:relative;\"><a href=\"#%EF%B8%8F-today-i-learned\" aria-label=\"️ today i learned permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>✍️ <strong>T</strong>oday <strong>I</strong> <strong>L</strong>earned</h2>\n<p><code class=\"language-text\">Docker</code> 파일을 작성할 때 습관처럼 큰 의심없이 아래와 같이 작성하곤한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token punctuation\">...</span>\n<span class=\"token comment\"># 3단계: 빌드</span>\nRUN npm run build\n\nCMD <span class=\"token punctuation\">[</span><span class=\"token string\">\"node\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"./dist/main.js\"</span><span class=\"token punctuation\">]</span></code></pre></div>\n<p><code class=\"language-text\">package.json</code>에 별다른 설정을 안해두었다면 아래와 같을꺼라 <strong>npm run start:prod</strong> 명령과 같은 명령어이지만 습관(?)처럼 <code class=\"language-text\">Dockerfile</code>을 작성할 땐 “./dist/main.js”를 직접 실행시키고 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token property\">\"scripts\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n  ...\n  <span class=\"token property\">\"start:prod\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"node dist/main\"</span><span class=\"token punctuation\">,</span>\n  ...</code></pre></div>\n<br>\n<br>\n<p>프레임워크에서 기본으로 제공하는 <strong>nest start</strong> CLI 명령어 또한 서버를 구동시키는 명령어인데, 빌드된 .js 파일을 직접 실행시키는 것과 어떤 차이가 있을지 궁금해서 찾아본 결과를 간략히 남기려한다.</p>\n<br>\n<br>\n<h3 id=\"1-눈에-띄는-차이점은\" style=\"position:relative;\"><a href=\"#1-%EB%88%88%EC%97%90-%EB%9D%84%EB%8A%94-%EC%B0%A8%EC%9D%B4%EC%A0%90%EC%9D%80\" aria-label=\"1 눈에 띄는 차이점은 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. 눈에 띄는 차이점은?</h3>\n<hr>\n<p>사실 입사 초기에 로컬 환경에서 쓰던 <code class=\"language-text\">Docker</code> 파일이 그대로 운영 환경<del>(심지어 —watch 옵션까지)</del>까지 이어진 경험이 있어서 Nest CLI 명령어는 어떤 사이드 이펙트를 발생시키는지 이미 몸소 체험해본적이 있다. 🥲</p>\n<p>간단히 같은 코드 베이스로 Nest CLI 명령어와 빌드된 .js 파일을 직접 실행한 환경으로 나누어서 컨테이너를 실행해보면 아래와 같이 눈으로도 확인이 가능할만한 차이점을 보이는 결과를 얻을 수 있다.</p>\n<br>\n<img src=\"https://jh8459.s3.ap-northeast-2.amazonaws.com/blog/2025-03-19-TIL/Initial.png\">\n<center>Nest CLI로 \"nest start\"로 실행한 컨테이너는 초기화 과정에서 CPU 점유율도 엄청나다 😲</center><br><br>\n<br>\n<img src=\"https://jh8459.s3.ap-northeast-2.amazonaws.com/blog/2025-03-19-TIL/Stabilization.png\">\n<center>초기화 과정 이후에도 메모리 점유율이 2배가 넘게 차이가 난다.</center><br><br>\n<p>유의미한 성능 차이가 존재한다는 점은 알고 있었으나 생각했었던 수치보다 더 크게 벌어진걸 눈으로 직접보니 놀라웠다.</p>\n<br>\n<br>\n<h3 id=\"2-nest-cli\" style=\"position:relative;\"><a href=\"#2-nest-cli\" aria-label=\"2 nest cli permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2. Nest CLI</h3>\n<hr>\n<p>왜 이런 큰 성능 차이를 보이는지는 Nest CLI의 actions에 정의된 <code class=\"language-text\">start.action.ts</code> 파일을 뜯어보면 알 수 있다.</p>\n<blockquote>\n<p><a href=\"https://github.com/nestjs/nest-cli/blob/c152351bba98b0562958b0d0223b7636c0183cb3/actions/start.action.ts#L17\" target=\"_blank\">nest-cli/actions/start.action.ts</a></p>\n</blockquote>\n<br>\n<br>\n<p>Nest CLI 명령으로 실행한 어플리케이션의 성능 저하 포인트들을 요약하자면 아래와 같다.</p>\n<ol>\n<li>\n<p>NestJS 설정 파일 로드</p>\n<ul>\n<li>\n<p><strong>commandOptions</strong>에서 config 옵션을 찾고, 이를 기반으로 <strong>this.loader.load(configFileName)</strong>을 호출하여 <code class=\"language-text\">nestjs-cli.json</code> 파일을 로드한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"$schema\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"https://json.schemastore.org/nest-cli\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"collection\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"@nestjs/schematics\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"sourceRoot\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"src\"</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n</li>\n</ul>\n</li>\n<li>\n<p>TS 컴파일러 설정 로드</p>\n<ul>\n<li>\n<p><strong>getTscConfigPath()</strong>를 통해 <code class=\"language-text\">tsconfig.json</code> 경로를 찾고, JSON 값을 파싱한 결과 중 outDir 값을 가져온다.</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"compilerOptions\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"module\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"commonjs\"</span><span class=\"token punctuation\">,</span>\n    ...\n    <span class=\"token property\">\"outDir\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"./dist\"</span><span class=\"token punctuation\">,</span>\n    ...\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n</li>\n</ul>\n</li>\n<li>\n<p>빌드 및 실행</p>\n<ul>\n<li>\n<p><strong>BuildAction.runBuild()</strong>가 실행되며 TypeScript를 빌드한다.</p>\n</li>\n<li>\n<p>빌드 후 <strong>createOnSuccessHook()</strong>이 실행되며 애플리케이션이 실행된다.</p>\n<ul>\n<li><strong>spawnChildProcess()</strong>를 통해 <strong>child_process.spawn()</strong>을 사용하여 새로운 프로세스로 감싸서 애플리케이션을 실행한다.</li>\n</ul>\n</li>\n</ul>\n</li>\n</ol>\n<br>\n<br>\n<p>즉, Nest CLI 명령어로 애플리케이션을 실행하면 여러 설정 파일들을 로드하며 새로이 빌드한 결과물을 새로운 프로세서로 감싸서 실행하고 있는 상황이다.</p>\n<br>\n<table>\n<thead>\n<tr>\n<th>항목</th>\n<th><strong>“nest start”</strong></th>\n<th><strong>“node dist/main.js”</strong></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><strong>설정 파일 로드</strong></td>\n<td>Nest CLI 설정 파일 (<code class=\"language-text\">nest-cli.json</code>)을 로드함</td>\n<td>설정 파일을 로드하지 않음</td>\n</tr>\n<tr>\n<td><strong>빌드 과정</strong></td>\n<td>TS 설정 파일(<code class=\"language-text\">tsconfig.json</code>)로 TypeScript 빌드</td>\n<td>이미 빌드된 JS 파일 실행</td>\n</tr>\n<tr>\n<td><strong>프로세스 관리</strong></td>\n<td><strong>spawnChildProcess()</strong>를 통해 별도 프로세스를 생성</td>\n<td><strong>node</strong> 프로세스를 직접 실행</td>\n</tr>\n<tr>\n<td><strong>옵션</strong></td>\n<td><code class=\"language-text\">--watch</code> 옵션 지원 (핫 리로드)</td>\n<td>없음</td>\n</tr>\n</tbody>\n</table>\n<br>\n<br>\n<h2 id=\"-understanding\" style=\"position:relative;\"><a href=\"#-understanding\" aria-label=\" understanding permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>🤔 Understanding</h2>\n<p>습관처럼 사용하고 있었던 명령어들을 이젠 어떠한 이유로 인해 사용 해야하는지 알고 쓸 수 있게 되었다.</p>\n<p>Nest CLI 명령어는 여러 개발 편의 옵션들을 지원 하고 별도의 빌드 과정없이 빠른 실행을 가능하게 한다는 점은 알고 있었지만, 세부적인 코드 흐름을 눈으로 보니 왜 초기화 단계에서 왜 높은 CPU 사용량과 메모리 점유율을 보이는지 이해할 수 있었다.</p>\n<br>\n<br>\n<div class=\"table-of-contents\">\n<ul>\n<li>\n<p><a href=\"#%EF%B8%8F-today-i-learned\">✍️ <strong>T</strong>oday <strong>I</strong> <strong>L</strong>earned</a></p>\n<ul>\n<li><a href=\"#1-%EB%88%88%EC%97%90-%EB%9D%84%EB%8A%94-%EC%B0%A8%EC%9D%B4%EC%A0%90%EC%9D%80\">1. 눈에 띄는 차이점은?</a></li>\n<li><a href=\"#2-nest-cli\">2. Nest CLI</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#-understanding\">🤔 Understanding</a></p>\n</li>\n</ul>\n</div>","frontmatter":{"date":"March 19, 2025","title":"Nest CLI 뜯어보기 (nest start)","categories":"TIL","author":"JH8459","emoji":"📚"},"fields":{"slug":"/2025-03-19-TIL/"}},"prev":null,"site":{"siteMetadata":{"siteUrl":"https://blog.jh8459.com","comments":{"utterances":{"repo":"JH8459/JH8459.github.io"}}}}},"pageContext":{"slug":"/2025-03-31-TIL/","nextSlug":"/2025-03-19-TIL/","prevSlug":""}},"staticQueryHashes":["1073350324","1956554647","2938748437"]}