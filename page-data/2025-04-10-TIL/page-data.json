{"componentChunkName":"component---src-templates-blog-template-js","path":"/2025-04-10-TIL/","result":{"data":{"cur":{"id":"eba0e70c-51e6-5384-9c0b-ce6ff6e624e2","html":"<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 56.666666666666664%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAALABQDASIAAhEBAxEB/8QAFgABAQEAAAAAAAAAAAAAAAAAAAID/8QAFQEBAQAAAAAAAAAAAAAAAAAAAAX/2gAMAwEAAhADEAAAAdJomgf/xAAWEAADAAAAAAAAAAAAAAAAAAAAASD/2gAIAQEAAQUCFP8A/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPwE//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPwE//8QAFhAAAwAAAAAAAAAAAAAAAAAAACAx/9oACAEBAAY/AiL/AP/EABgQAAIDAAAAAAAAAAAAAAAAAAABESAx/9oACAEBAAE/IRm9hX//2gAMAwEAAgADAAAAEEw//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPxA//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPxA//8QAGRAAAgMBAAAAAAAAAAAAAAAAAREAIEFR/9oACAEBAAE/EI1YY7tf/9k='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"github-blog.png\"\n        title=\"\"\n        src=\"/static/7c4bbfe7d1a9d6bc02891c94bfe039dc/80e3c/TIL.jpg\"\n        srcset=\"/static/7c4bbfe7d1a9d6bc02891c94bfe039dc/4ec73/TIL.jpg 180w,\n/static/7c4bbfe7d1a9d6bc02891c94bfe039dc/158ba/TIL.jpg 360w,\n/static/7c4bbfe7d1a9d6bc02891c94bfe039dc/80e3c/TIL.jpg 720w,\n/static/7c4bbfe7d1a9d6bc02891c94bfe039dc/47311/TIL.jpg 1080w,\n/static/7c4bbfe7d1a9d6bc02891c94bfe039dc/ac614/TIL.jpg 1272w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<br>\n<h2 id=\"️-today-i-learned\" style=\"position:relative;\"><a href=\"#%EF%B8%8F-today-i-learned\" aria-label=\"️ today i learned permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>✍️ <strong>T</strong>oday <strong>I</strong> <strong>L</strong>earned</h2>\n<p>현재 사내 프레임워크는 NestJS를 사용하고 있으며 클라이언트에게 요청을 받고 응답을 반환하는 <strong>Controller</strong> 클래스와 비즈니스 로직을 담당하는 <strong>Service</strong> 클래스 그리고 최종적으로 데이터베이스에 CRUD 작업을 담당하는 <strong>Repository</strong> 클래스를 사용하는 계층형 아키텍처로 구성하여 사용하고 있다.</p>\n<p>단순한 단일 <strong>INSERT</strong>, <strong>UPDATE</strong>를 넘어서, <strong>“모든 작업이 성공해야만 커밋하고, 하나라도 실패하면 전부 롤백”</strong> 되어야 하는 비즈니스 구조는 빈번히 일어난다. <del>(이러한 상황은 실무에서 꽤나 자주 마주친다. 🥲)</del></p>\n<p>이런 경우 <strong>Service</strong> 클래스의 하나의 메서드 안에서 여러 개의 DB 작업을 처리해야 할 때 <code class=\"language-text\">typeorm</code>을 활용해서 트랜잭션을 사용하고 있다.</p>\n<p>꼭 이렇게 사용해야만 한다는건 아니지만, 이 점은 꼭 주의해야할 패턴에 대해 느낀점이 있다. 오늘은 이를 간략하게 기록으로 남겨보려한다.</p>\n<br>\r\n<br>\n<h3 id=\"1-트랜잭션이란\" style=\"position:relative;\"><a href=\"#1-%ED%8A%B8%EB%9E%9C%EC%9E%AD%EC%85%98%EC%9D%B4%EB%9E%80\" aria-label=\"1 트랜잭션이란 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. 트랜잭션이란?</h3>\n<hr>\n<p>사실, 우리가 흔히 말하는 트랜잭션(Transaction)은 그다지 어려운 개념이 아니라 “하나의 작업 단위”다.</p>\n<p>따라서 데이터베이스 입장에서는 이 작업 단위가 <strong>전부 성공하면 커밋(commit)</strong>, 하나라도 실패하면 <strong>전부 롤백(rollback)</strong> 되어야 한다는 원자성(Atomicity)을 보장해야 한다.</p>\n<img src=\"https://jh8459.s3.ap-northeast-2.amazonaws.com/blog/2025-04-10-TIL/transaction.png\">\n<center>A, B, C가 개별 작업이 아니라 <strong>하나의 작업 단위</strong>인 경우 트랜잭션 흐름도</center><br><br>\n<p>만약, <u><strong>“비회원 유저의 상품 주문 시나리오”</strong></u>가 비즈니스 모델에 필요하다면 이를 단계별로 작성해보면 아래의 흐름으로 구성해볼 수 있다.</p>\n<blockquote>\n<ol>\n<li>비회원 유저는 회원가입 없이 구매를 하기 위해 이름, 이메일 정보를 입력한다.</li>\n<li>상품 구매 정보를 저장한다.</li>\n<li>추후 구매 정보 추적을 위해 비회원 구매 이력 로그를 저장한다.</li>\n</ol>\n</blockquote>\n<br>\r\n<br>\n<p>각각 단계는 개별 작업이 아니므로 하나의 작업 단위로 묶어서 바라봐야 한다.</p>\n<blockquote>\n<p>재고 부족으로 구매에 실패하였으나 구매 이력이 남는다면..?? 👀</p>\n</blockquote>\n<br>\r\n<br>\n<p>따라서, 이 단계들을 트랜잭션으로 묶어 하나의 작업으로 바라봐야하며 이를 코드로 작성해보면 아래와 같이 구성할 수 있다. (흐름을 이해하기 위한 예시코드이므로 간략히 작성해보았다.)</p>\n<ul>\n<li>\n<p><strong>GuestOrderService</strong> 클래스</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token decorator\"><span class=\"token at operator\">@</span><span class=\"token function\">Injectable</span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\r\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">GuestOrderService</span> <span class=\"token punctuation\">{</span>\r\n  <span class=\"token function\">constructor</span><span class=\"token punctuation\">(</span>\r\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">readonly</span> guestOrderRepository<span class=\"token operator\">:</span> GuestOrderRepository<span class=\"token punctuation\">,</span>\r\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">readonly</span> dataSource<span class=\"token operator\">:</span> DataSource<span class=\"token punctuation\">,</span>\r\n  <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\r\n\r\n  <span class=\"token comment\">/**\r\n   * 비회원 유저의 상품 주문 요청 처리\r\n   * - A. 유저 정보 저장\r\n   * - B. 주문 정보 저장\r\n   * - C. 주문 로그 기록\r\n   * 모든 과정이 성공해야만 트랜잭션 커밋\r\n   */</span>\r\n  <span class=\"token keyword\">async</span> <span class=\"token function\">processGuestOrder</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token builtin\">Promise</span><span class=\"token operator\">&lt;</span><span class=\"token keyword\">void</span><span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token comment\">// 트랜잭션 시작</span>\r\n    <span class=\"token keyword\">await</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>dataSource<span class=\"token punctuation\">.</span><span class=\"token function\">transaction</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span>manager<span class=\"token operator\">:</span> EntityManager<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n      <span class=\"token keyword\">const</span> guestInfo <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\r\n        name<span class=\"token operator\">:</span> <span class=\"token string\">'홍길동'</span><span class=\"token punctuation\">,</span>\r\n        email<span class=\"token operator\">:</span> <span class=\"token string\">'guest@example.com'</span><span class=\"token punctuation\">,</span>\r\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\r\n\r\n      <span class=\"token comment\">// A. 유저 정보 저장</span>\r\n      <span class=\"token keyword\">const</span> guestUser <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>guestOrderRepository<span class=\"token punctuation\">.</span><span class=\"token function\">createGuestUser</span><span class=\"token punctuation\">(</span>manager<span class=\"token punctuation\">,</span> guestInfo<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n\r\n      <span class=\"token keyword\">const</span> orderInfo <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\r\n        guestUserId<span class=\"token operator\">:</span> guestUser<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">,</span>\r\n        productName<span class=\"token operator\">:</span> <span class=\"token string\">'무선 키보드'</span><span class=\"token punctuation\">,</span>\r\n        quantity<span class=\"token operator\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span>\r\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\r\n\r\n      <span class=\"token comment\">// B. 주문 정보 저장</span>\r\n      <span class=\"token keyword\">await</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>guestOrderRepository<span class=\"token punctuation\">.</span><span class=\"token function\">createProductOrder</span><span class=\"token punctuation\">(</span>manager<span class=\"token punctuation\">,</span> orderInfo<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n\r\n      <span class=\"token keyword\">const</span> logInfo <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\r\n        message<span class=\"token operator\">:</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">비회원 주문 발생 (ID: </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>guestUser<span class=\"token punctuation\">.</span>id<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">)</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">,</span>\r\n        createdAt<span class=\"token operator\">:</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Date</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\r\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\r\n\r\n      <span class=\"token comment\">// C. 주문 로그 기록</span>\r\n      <span class=\"token keyword\">await</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>guestOrderRepository<span class=\"token punctuation\">.</span><span class=\"token function\">createOrderLog</span><span class=\"token punctuation\">(</span>manager<span class=\"token punctuation\">,</span> logInfo<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n  <span class=\"token punctuation\">}</span>\r\n<span class=\"token punctuation\">}</span></code></pre></div>\n</li>\n<li>\n<p><strong>GuestOrderRepository</strong> 클래스</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token decorator\"><span class=\"token at operator\">@</span><span class=\"token function\">Injectable</span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\r\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">GuestOrderRepository</span> <span class=\"token punctuation\">{</span>\r\n  <span class=\"token comment\">/**\r\n  * 비회원 유저 정보 저장\r\n  */</span>\r\n  <span class=\"token keyword\">async</span> <span class=\"token function\">createGuestUser</span><span class=\"token punctuation\">(</span>\r\n    manager<span class=\"token operator\">:</span> EntityManager<span class=\"token punctuation\">,</span>\r\n    userInfo<span class=\"token operator\">:</span> Partial<span class=\"token operator\">&lt;</span>GuestUserEntity<span class=\"token operator\">></span><span class=\"token punctuation\">,</span>\r\n  <span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token builtin\">Promise</span><span class=\"token operator\">&lt;</span>GuestUserEntity<span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token keyword\">const</span> repo <span class=\"token operator\">=</span> manager<span class=\"token punctuation\">.</span><span class=\"token function\">getRepository</span><span class=\"token punctuation\">(</span>GuestUserEntity<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n    <span class=\"token keyword\">const</span> user <span class=\"token operator\">=</span> repo<span class=\"token punctuation\">.</span><span class=\"token function\">create</span><span class=\"token punctuation\">(</span>userInfo<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n\r\n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">await</span> repo<span class=\"token punctuation\">.</span><span class=\"token function\">save</span><span class=\"token punctuation\">(</span>user<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n  <span class=\"token punctuation\">}</span>\r\n\r\n  <span class=\"token comment\">/**\r\n  * 주문 정보 저장\r\n  */</span>\r\n  <span class=\"token keyword\">async</span> <span class=\"token function\">createProductOrder</span><span class=\"token punctuation\">(</span>\r\n    manager<span class=\"token operator\">:</span> EntityManager<span class=\"token punctuation\">,</span>\r\n    orderInfo<span class=\"token operator\">:</span> Partial<span class=\"token operator\">&lt;</span>ProductOrderEntity<span class=\"token operator\">></span><span class=\"token punctuation\">,</span>\r\n  <span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token builtin\">Promise</span><span class=\"token operator\">&lt;</span>ProductOrderEntity<span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token keyword\">const</span> repo <span class=\"token operator\">=</span> manager<span class=\"token punctuation\">.</span><span class=\"token function\">getRepository</span><span class=\"token punctuation\">(</span>ProductOrderEntity<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n    <span class=\"token keyword\">const</span> order <span class=\"token operator\">=</span> repo<span class=\"token punctuation\">.</span><span class=\"token function\">create</span><span class=\"token punctuation\">(</span>orderInfo<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n\r\n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">await</span> repo<span class=\"token punctuation\">.</span><span class=\"token function\">save</span><span class=\"token punctuation\">(</span>order<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n  <span class=\"token punctuation\">}</span>\r\n\r\n  <span class=\"token comment\">/**\r\n  * 주문 로그 기록\r\n  */</span>\r\n  <span class=\"token keyword\">async</span> <span class=\"token function\">createOrderLog</span><span class=\"token punctuation\">(</span>\r\n    manager<span class=\"token operator\">:</span> EntityManager<span class=\"token punctuation\">,</span>\r\n    logInfo<span class=\"token operator\">:</span> Partial<span class=\"token operator\">&lt;</span>OrderLogEntity<span class=\"token operator\">></span><span class=\"token punctuation\">,</span>\r\n  <span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token builtin\">Promise</span><span class=\"token operator\">&lt;</span><span class=\"token keyword\">void</span><span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token keyword\">const</span> repo <span class=\"token operator\">=</span> manager<span class=\"token punctuation\">.</span><span class=\"token function\">getRepository</span><span class=\"token punctuation\">(</span>OrderLogEntity<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n    <span class=\"token keyword\">const</span> log <span class=\"token operator\">=</span> repo<span class=\"token punctuation\">.</span><span class=\"token function\">create</span><span class=\"token punctuation\">(</span>logInfo<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n    \r\n    <span class=\"token keyword\">await</span> repo<span class=\"token punctuation\">.</span><span class=\"token function\">save</span><span class=\"token punctuation\">(</span>log<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n  <span class=\"token punctuation\">}</span>\r\n<span class=\"token punctuation\">}</span></code></pre></div>\n</li>\n</ul>\n<br>\r\n<br>\n<p>위 예시는 하나의 트랜잭션 컨텍스트에서 여러 작업(A, B, C 단계)을 진행하는 예시이다. 비즈니스 모델은 Service에서 담당하고 있으며 트랜잭션 제어를 위해 <strong>EntityManager</strong>를 레포지토리의 각 메서드에 전달하여 작업을 나누되 전체 흐름은 Service에서 제어하도록 구성해보았다.</p>\n<p>이 처럼 트랜잭션 처리는 단순히 기술적인 개념을 넘어서 <strong>“실제로 실패하면 어떤 데이터가 남는가?”</strong> 를 고민하는 문제라 생각한다.</p>\n<p>위 예시처럼 하나의 주문 요청에서 유저, 주문, 로그가 모두 성공해야만 저장되는 구조는 안정적인 서비스 운영을 위한 기본이 된다.</p>\n<br>\r\n<br>\n<h3 id=\"2-트랜잭션의-특징과-피해야할-패턴\" style=\"position:relative;\"><a href=\"#2-%ED%8A%B8%EB%9E%9C%EC%9E%AD%EC%85%98%EC%9D%98-%ED%8A%B9%EC%A7%95%EA%B3%BC-%ED%94%BC%ED%95%B4%EC%95%BC%ED%95%A0-%ED%8C%A8%ED%84%B4\" aria-label=\"2 트랜잭션의 특징과 피해야할 패턴 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2. 트랜잭션의 특징과 피해야할 패턴</h3>\n<hr>\n<p>트랜잭션의 흐름은 기본적으로 순차적이다. 위에서 예시를 들었지만 A → B → C 작업 순서대로 실행되고 중간에 하나라도 실패하면 롤백이 되어야한다.</p>\n<blockquote>\n<p>트랜잭션은 단순히 여러 작업을 하나로 묶는 것이 아니라 <strong>하나의 일관된 흐름으로 실행되어야 하는 작업 집합</strong>이다. 즉, 트랜잭션은 <strong>A 작업이 끝난 뒤 B, 그 다음 C</strong>와 같이  <strong>“순차적으로 실행되는 흐름”을 전제로 설계</strong>되어있다.</p>\n</blockquote>\n<br>\r\n<br>\n<p>특히 주의해야할 패턴은 <code class=\"language-text\">Promise.all()</code>과 같은 <strong>여러 비동기 작업을 동시에 실행</strong>하는 병렬 처리 방식이다.</p>\n<p>이 패턴은 각 작업의 결과가 성공이든 실패든 동시에 진행되며 서로의 실행 결과를 기다리지 않기 때문에 트랜잭션이 의도한 <strong>순차적 흐름</strong>이 무너지고 실패와 커밋 타이밍이 엇갈리면서 데이터 정합성 문제가 발생할 수 있다.</p>\n<p>예시를 들어보자면 다음과 같은 상황이 발생할 수 있다.</p>\n<ul>\n<li>\n<p><strong>GuestOrderService</strong> 클래스 → <code class=\"language-text\">Promise.all()</code> 문법 적용</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token decorator\"><span class=\"token at operator\">@</span><span class=\"token function\">Injectable</span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\r\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">GuestOrderService</span> <span class=\"token punctuation\">{</span>\r\n  <span class=\"token function\">constructor</span><span class=\"token punctuation\">(</span>\r\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">readonly</span> guestOrderRepository<span class=\"token operator\">:</span> GuestOrderRepository<span class=\"token punctuation\">,</span>\r\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">readonly</span> dataSource<span class=\"token operator\">:</span> DataSource<span class=\"token punctuation\">,</span>\r\n  <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\r\n\r\n  <span class=\"token comment\">/**\r\n   * 비회원 유저의 상품 주문 요청 처리\r\n   * - A. 유저 정보 저장\r\n   * - B. 주문 정보 저장\r\n   * - C. 주문 로그 기록\r\n   * 모든 과정이 성공해야만 트랜잭션 커밋\r\n   */</span>\r\n  <span class=\"token keyword\">async</span> <span class=\"token function\">processGuestOrder</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token builtin\">Promise</span><span class=\"token operator\">&lt;</span><span class=\"token keyword\">void</span><span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token comment\">// 트랜잭션 시작</span>\r\n    <span class=\"token keyword\">await</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>dataSource<span class=\"token punctuation\">.</span><span class=\"token function\">transaction</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span>manager<span class=\"token operator\">:</span> EntityManager<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n      <span class=\"token keyword\">await</span> <span class=\"token builtin\">Promise</span><span class=\"token punctuation\">.</span><span class=\"token function\">all</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>\r\n        <span class=\"token comment\">// A. 유저 정보 저장 → 성공 ✅</span>\r\n        <span class=\"token keyword\">await</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>guestOrderRepository<span class=\"token punctuation\">.</span><span class=\"token function\">createGuestUser</span><span class=\"token punctuation\">(</span>manager<span class=\"token punctuation\">,</span> guestInfo<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n        <span class=\"token comment\">// B. 주문 정보 저장 → 실패 ❌</span>\r\n        <span class=\"token keyword\">await</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>guestOrderRepository<span class=\"token punctuation\">.</span><span class=\"token function\">createProductOrder</span><span class=\"token punctuation\">(</span>manager<span class=\"token punctuation\">,</span> orderInfo<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n        <span class=\"token comment\">// C. 주문 로그 기록 → 이미 실행됨 😱</span>\r\n        <span class=\"token keyword\">await</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>guestOrderRepository<span class=\"token punctuation\">.</span><span class=\"token function\">createOrderLog</span><span class=\"token punctuation\">(</span>manager<span class=\"token punctuation\">,</span> logInfo<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n      <span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n  <span class=\"token punctuation\">}</span>\r\n<span class=\"token punctuation\">}</span></code></pre></div>\n</li>\n</ul>\n<br>\r\n<br>\n<p>위 예시 코드의 실행 결과 기대값은 아래와 같다.</p>\n<blockquote>\n<ol>\n<li>B에서 에러가 발생하더라도 C가 이미 실행되어 DB에 영향을 줬을 가능성이 존재한다.</li>\n<li>ROLLBACK 타이밍이 어긋나므로 데이터 정합성이 깨진다.</li>\n</ol>\n</blockquote>\n<br>\r\n<br>\n<p>위 코드를 실제로 <code class=\"language-text\">typeorm</code>의 로깅 기능을 활성화 한 뒤 실행해보면 <code class=\"language-text\">query: ROLLBACK</code> 로그 이후에도 이미 실행되어 진행 중인 쿼리 로그가 찍히고 있음을 확인 할 수 있다. (아래 로그는 같은 환경을 구성하여 출력해본 예시이다.)</p>\n<img src=\"https://jh8459.s3.ap-northeast-2.amazonaws.com/blog/2025-04-10-TIL/log.png\">\n<center><u><strong>query: ROLLBACK</strong></u> 로그 이후에도 이미 실행된 쿼리 로그들을 확인할 수 있다. 🥲</center><br><br>\n<p>즉, <strong>트랜잭션은 비동기 처리를 허용</strong>하지만 병렬 실행을 전제로 하지 않는다. 내부 흐름은 “차례차례 실행될 것”이라는 가정 위에 작동하므로 사용에 유의해야한다.</p>\n<br>\r\n<br>\n<h2 id=\"-understanding\" style=\"position:relative;\"><a href=\"#-understanding\" aria-label=\" understanding permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>🤔 Understanding</h2>\n<p>성능을 위해 병렬로 처리하고 싶은 욕구는 항상 생기지만 트랜잭션이 개입되는 순간 안정성 vs 성능의 균형을 따져야 한다. <del>(코드의 문제는 에러로 끝나지만, 데이터 문제는 비즈니스 모델 신뢰성에 영향을 준다.. 😂)</del></p>\n<p>이번 포스팅을 정리하면서 단순히 비즈니스 요구사항에 따라 트랜잭션을 적용하는 것에서 그치지 않고 <strong>트랜잭션을 중심으로 Repository 구조를 어떻게 설계해야 하는지</strong>, 그리고 나아가 별도 트랜잭션 관리 도구 도입 여부까지 고민해보는 계기가 되었다.</p>\n<p>아래의 고민들은 아직 정리가 안되어서 추후 포스팅으로 남길 수 있으면 남겨보도록해야겠다.</p>\n<blockquote>\n<ol>\n<li>트랜잭션을 고려한 Repository 디자인 패턴 검토</li>\n<li>별도 라이브러리 도입 검토 (typeorm-transactional)</li>\n</ol>\n</blockquote>\n<br>\r\n<br>","excerpt":"✍️ Today I Learned 현재 사내 프레임워크는 NestJS를 사용하고 있으며 클라이언트에게 요청을 받고 응답을 반환하는 Controller 클래스와 비즈니스 로직을 담당하는 Service 클래스 그리고 최종적으로 데이터베이스에 CRUD 작업을 담당하는 Repository 클래스를 사용하는 계층형 아키텍처로 구성하여 사용하고 있다. 단순한 단일 INSERT, UPDATE를 넘어서, “모든 작업이 성공해야만 커밋하고, 하나라도 실패하면 전부 롤백” 되어야 하는 비즈니스 구조는 빈번히 일어난다. (이러한 상황은 실무에서 꽤나 자주 마주친다. 🥲) 이런 경우 Service 클래스의 하나의 메서드 안에서 여러 개의 DB 작업을 처리해야 할 때 을 활용해서 트랜잭션을 사용하고 있다. 꼭 이렇게 사용해야만 한다는건 아니지만, 이 점은 꼭 주의해야할 패턴에 대해 느낀점이 있다. 오늘은 이를 간략하게 기록으로 남겨보려한다. 1. 트랜잭션이란? 사실, 우리가 흔히 말하는 트랜잭션(Trans…","timeToRead":4,"tableOfContents":"<ul>\n<li>\n<p><a href=\"#%EF%B8%8F-today-i-learned\">✍️ <strong>T</strong>oday <strong>I</strong> <strong>L</strong>earned</a></p>\n<ul>\n<li><a href=\"#1-%ED%8A%B8%EB%9E%9C%EC%9E%AD%EC%85%98%EC%9D%B4%EB%9E%80\">1. 트랜잭션이란?</a></li>\n<li><a href=\"#2-%ED%8A%B8%EB%9E%9C%EC%9E%AD%EC%85%98%EC%9D%98-%ED%8A%B9%EC%A7%95%EA%B3%BC-%ED%94%BC%ED%95%B4%EC%95%BC%ED%95%A0-%ED%8C%A8%ED%84%B4\">2. 트랜잭션의 특징과 피해야할 패턴</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#-understanding\">🤔 Understanding</a></p>\n</li>\n</ul>","frontmatter":{"date":"2025.04.10","title":"NestJS + TypeORM 트랜잭션을 다룰 때 반드시 피해야 할 패턴","categories":"TIL","author":"JH8459","emoji":"📚"},"fields":{"slug":"/2025-04-10-TIL/"}},"next":{"id":"339c4b95-e05a-5ddc-8f1f-eb9e6ff88faf","frontmatter":{"date":"2025.03.31","title":"EC2에서 NAS로, 개인 서버 CI/CD 자동화","categories":"Project","author":"JH8459","emoji":"🔥"},"fields":{"slug":"/2025-03-31-PROJECT/"}},"prev":{"id":"df72ad6e-8bde-5e71-bee8-f3d9375b3382","frontmatter":{"date":"2025.04.29","title":"E2E 테스트 설계와 테스트 자동화","categories":"Project","author":"JH8459","emoji":"🔥"},"fields":{"slug":"/2025-04-29-PROJECT/"}},"site":{"siteMetadata":{"comments":{"giscus":{"repo":"JH8459/JH8459.github.io","repoId":"R_kgDOI03HgA","category":"Comments","categoryId":"DIC_kwDOI03HgM4CtuXL"}}}}},"pageContext":{"slug":"/2025-04-10-TIL/","nextSlug":"/2025-03-31-PROJECT/","prevSlug":"/2025-04-29-PROJECT/"}},"staticQueryHashes":["1073350324","2009502679","2938748437","962130685"],"slicesMap":{}}