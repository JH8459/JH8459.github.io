{"componentChunkName":"component---src-templates-blog-template-js","path":"/2025-04-10-TIL/","result":{"data":{"cur":{"id":"eba0e70c-51e6-5384-9c0b-ce6ff6e624e2","html":"<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 56.666666666666664%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAALABQDASIAAhEBAxEB/8QAFgABAQEAAAAAAAAAAAAAAAAAAAID/8QAFQEBAQAAAAAAAAAAAAAAAAAAAAX/2gAMAwEAAhADEAAAAdJomgf/xAAWEAADAAAAAAAAAAAAAAAAAAAAASD/2gAIAQEAAQUCFP8A/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPwE//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPwE//8QAFhAAAwAAAAAAAAAAAAAAAAAAACAx/9oACAEBAAY/AiL/AP/EABgQAAIDAAAAAAAAAAAAAAAAAAABESAx/9oACAEBAAE/IRm9hX//2gAMAwEAAgADAAAAEEw//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPxA//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPxA//8QAGRAAAgMBAAAAAAAAAAAAAAAAAREAIEFR/9oACAEBAAE/EI1YY7tf/9k='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"github-blog.png\"\n        title=\"\"\n        src=\"/static/7c4bbfe7d1a9d6bc02891c94bfe039dc/80e3c/TIL.jpg\"\n        srcset=\"/static/7c4bbfe7d1a9d6bc02891c94bfe039dc/4ec73/TIL.jpg 180w,\n/static/7c4bbfe7d1a9d6bc02891c94bfe039dc/158ba/TIL.jpg 360w,\n/static/7c4bbfe7d1a9d6bc02891c94bfe039dc/80e3c/TIL.jpg 720w,\n/static/7c4bbfe7d1a9d6bc02891c94bfe039dc/47311/TIL.jpg 1080w,\n/static/7c4bbfe7d1a9d6bc02891c94bfe039dc/ac614/TIL.jpg 1272w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<br>\n<h2 id=\"️-today-i-learned\" style=\"position:relative;\"><a href=\"#%EF%B8%8F-today-i-learned\" aria-label=\"️ today i learned permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>✍️ <strong>T</strong>oday <strong>I</strong> <strong>L</strong>earned</h2>\n<p>현재 사내 프레임워크는 NestJS를 사용하고 있으며 클라이언트에게 요청을 받고 응답을 반환하는 <strong>Controller</strong> 클래스와 비즈니스 로직을 담당하는 <strong>Service</strong> 클래스 그리고 최종적으로 데이터베이스에 CRUD 작업을 담당하는 <strong>Repository</strong> 클래스를 사용하는 계층형 아키텍처로 구성하여 사용하고 있다.</p>\n<p>단순한 단일 <strong>INSERT</strong>, <strong>UPDATE</strong>를 넘어서, <strong>“모든 작업이 성공해야만 커밋하고, 하나라도 실패하면 전부 롤백”</strong> 되어야 하는 비즈니스 구조는 빈번히 일어난다. <del>(이러한 상황은 실무에서 꽤나 자주 마주친다. 🥲)</del></p>\n<p>이런 경우 <strong>Service</strong> 클래스의 하나의 메서드 안에서 여러 개의 DB 작업을 처리해야 할 때 <code class=\"language-text\">typeorm</code>을 활용해서 트랜잭션을 사용하고 있다.</p>\n<p>꼭 이렇게 사용해야만 한다는건 아니지만, 이 점은 꼭 주의해야할 패턴에 대해 느낀점이 있다. 오늘은 이를 간략하게 기록으로 남겨보려한다.</p>\n<br>\r\n<br>\n<h3 id=\"1-트랜잭션이란\" style=\"position:relative;\"><a href=\"#1-%ED%8A%B8%EB%9E%9C%EC%9E%AD%EC%85%98%EC%9D%B4%EB%9E%80\" aria-label=\"1 트랜잭션이란 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. 트랜잭션이란?</h3>\n<hr>\n<p>사실, 우리가 흔히 말하는 트랜잭션(Transaction)은 그다지 어려운 개념이 아니라 “하나의 작업 단위”다.</p>\n<p>따라서 데이터베이스 입장에서는 이 작업 단위가 <strong>전부 성공하면 커밋(commit)</strong>, 하나라도 실패하면 <strong>전부 롤백(rollback)</strong> 되어야 한다는 원자성(Atomicity)을 보장해야 한다.</p>\n<img src=\"https://jh8459.s3.ap-northeast-2.amazonaws.com/blog/2025-04-10-TIL/transaction.png\">\n<center>A, B, C가 개별 작업이 아니라 <strong>하나의 작업 단위</strong>인 경우 트랜잭션 흐름도</center><br><br>\n<p>만약, <u><strong>“비회원 유저의 상품 주문 시나리오”</strong></u>가 비즈니스 모델에 필요하다면 이를 단계별로 작성해보면 아래의 흐름으로 구성해볼 수 있다.</p>\n<blockquote>\n<ol>\n<li>비회원 유저는 회원가입 없이 구매를 하기 위해 이름, 이메일 정보를 입력한다.</li>\n<li>상품 구매 정보를 저장한다.</li>\n<li>추후 구매 정보 추적을 위해 비회원 구매 이력 로그를 저장한다.</li>\n</ol>\n</blockquote>\n<br>\r\n<br>\n<p>각각 단계는 개별 작업이 아니므로 하나의 작업 단위로 묶어서 바라봐야 한다.</p>\n<blockquote>\n<p>재고 부족으로 구매에 실패하였으나 구매 이력이 남는다면..?? 👀</p>\n</blockquote>\n<br>\r\n<br>\n<p>따라서, 이 단계들을 트랜잭션으로 묶어 하나의 작업으로 바라봐야하며 이를 코드로 작성해보면 아래와 같이 구성할 수 있다. (흐름을 이해하기 위한 예시코드이므로 간략히 작성해보았다.)</p>\n<ul>\n<li>\n<p><strong>GuestOrderService</strong> 클래스</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token decorator\"><span class=\"token at operator\">@</span><span class=\"token function\">Injectable</span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\r\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">GuestOrderService</span> <span class=\"token punctuation\">{</span>\r\n  <span class=\"token function\">constructor</span><span class=\"token punctuation\">(</span>\r\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">readonly</span> guestOrderRepository<span class=\"token operator\">:</span> GuestOrderRepository<span class=\"token punctuation\">,</span>\r\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">readonly</span> dataSource<span class=\"token operator\">:</span> DataSource<span class=\"token punctuation\">,</span>\r\n  <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\r\n\r\n  <span class=\"token comment\">/**\r\n   * 비회원 유저의 상품 주문 요청 처리\r\n   * - A. 유저 정보 저장\r\n   * - B. 주문 정보 저장\r\n   * - C. 주문 로그 기록\r\n   * 모든 과정이 성공해야만 트랜잭션 커밋\r\n   */</span>\r\n  <span class=\"token keyword\">async</span> <span class=\"token function\">processGuestOrder</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token builtin\">Promise</span><span class=\"token operator\">&lt;</span><span class=\"token keyword\">void</span><span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token comment\">// 트랜잭션 시작</span>\r\n    <span class=\"token keyword\">await</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>dataSource<span class=\"token punctuation\">.</span><span class=\"token function\">transaction</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span>manager<span class=\"token operator\">:</span> EntityManager<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n      <span class=\"token keyword\">const</span> guestInfo <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\r\n        name<span class=\"token operator\">:</span> <span class=\"token string\">'홍길동'</span><span class=\"token punctuation\">,</span>\r\n        email<span class=\"token operator\">:</span> <span class=\"token string\">'guest@example.com'</span><span class=\"token punctuation\">,</span>\r\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\r\n\r\n      <span class=\"token comment\">// A. 유저 정보 저장</span>\r\n      <span class=\"token keyword\">const</span> guestUser <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>guestOrderRepository<span class=\"token punctuation\">.</span><span class=\"token function\">createGuestUser</span><span class=\"token punctuation\">(</span>manager<span class=\"token punctuation\">,</span> guestInfo<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n\r\n      <span class=\"token keyword\">const</span> orderInfo <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\r\n        guestUserId<span class=\"token operator\">:</span> guestUser<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">,</span>\r\n        productName<span class=\"token operator\">:</span> <span class=\"token string\">'무선 키보드'</span><span class=\"token punctuation\">,</span>\r\n        quantity<span class=\"token operator\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span>\r\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\r\n\r\n      <span class=\"token comment\">// B. 주문 정보 저장</span>\r\n      <span class=\"token keyword\">await</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>guestOrderRepository<span class=\"token punctuation\">.</span><span class=\"token function\">createProductOrder</span><span class=\"token punctuation\">(</span>manager<span class=\"token punctuation\">,</span> orderInfo<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n\r\n      <span class=\"token keyword\">const</span> logInfo <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\r\n        message<span class=\"token operator\">:</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">비회원 주문 발생 (ID: </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>guestUser<span class=\"token punctuation\">.</span>id<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">)</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">,</span>\r\n        createdAt<span class=\"token operator\">:</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Date</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\r\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\r\n\r\n      <span class=\"token comment\">// C. 주문 로그 기록</span>\r\n      <span class=\"token keyword\">await</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>guestOrderRepository<span class=\"token punctuation\">.</span><span class=\"token function\">createOrderLog</span><span class=\"token punctuation\">(</span>manager<span class=\"token punctuation\">,</span> logInfo<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n  <span class=\"token punctuation\">}</span>\r\n<span class=\"token punctuation\">}</span></code></pre></div>\n</li>\n<li>\n<p><strong>GuestOrderRepository</strong> 클래스</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token decorator\"><span class=\"token at operator\">@</span><span class=\"token function\">Injectable</span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\r\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">GuestOrderRepository</span> <span class=\"token punctuation\">{</span>\r\n  <span class=\"token comment\">/**\r\n  * 비회원 유저 정보 저장\r\n  */</span>\r\n  <span class=\"token keyword\">async</span> <span class=\"token function\">createGuestUser</span><span class=\"token punctuation\">(</span>\r\n    manager<span class=\"token operator\">:</span> EntityManager<span class=\"token punctuation\">,</span>\r\n    userInfo<span class=\"token operator\">:</span> Partial<span class=\"token operator\">&lt;</span>GuestUserEntity<span class=\"token operator\">></span><span class=\"token punctuation\">,</span>\r\n  <span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token builtin\">Promise</span><span class=\"token operator\">&lt;</span>GuestUserEntity<span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token keyword\">const</span> repo <span class=\"token operator\">=</span> manager<span class=\"token punctuation\">.</span><span class=\"token function\">getRepository</span><span class=\"token punctuation\">(</span>GuestUserEntity<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n    <span class=\"token keyword\">const</span> user <span class=\"token operator\">=</span> repo<span class=\"token punctuation\">.</span><span class=\"token function\">create</span><span class=\"token punctuation\">(</span>userInfo<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n\r\n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">await</span> repo<span class=\"token punctuation\">.</span><span class=\"token function\">save</span><span class=\"token punctuation\">(</span>user<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n  <span class=\"token punctuation\">}</span>\r\n\r\n  <span class=\"token comment\">/**\r\n  * 주문 정보 저장\r\n  */</span>\r\n  <span class=\"token keyword\">async</span> <span class=\"token function\">createProductOrder</span><span class=\"token punctuation\">(</span>\r\n    manager<span class=\"token operator\">:</span> EntityManager<span class=\"token punctuation\">,</span>\r\n    orderInfo<span class=\"token operator\">:</span> Partial<span class=\"token operator\">&lt;</span>ProductOrderEntity<span class=\"token operator\">></span><span class=\"token punctuation\">,</span>\r\n  <span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token builtin\">Promise</span><span class=\"token operator\">&lt;</span>ProductOrderEntity<span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token keyword\">const</span> repo <span class=\"token operator\">=</span> manager<span class=\"token punctuation\">.</span><span class=\"token function\">getRepository</span><span class=\"token punctuation\">(</span>ProductOrderEntity<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n    <span class=\"token keyword\">const</span> order <span class=\"token operator\">=</span> repo<span class=\"token punctuation\">.</span><span class=\"token function\">create</span><span class=\"token punctuation\">(</span>orderInfo<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n\r\n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">await</span> repo<span class=\"token punctuation\">.</span><span class=\"token function\">save</span><span class=\"token punctuation\">(</span>order<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n  <span class=\"token punctuation\">}</span>\r\n\r\n  <span class=\"token comment\">/**\r\n  * 주문 로그 기록\r\n  */</span>\r\n  <span class=\"token keyword\">async</span> <span class=\"token function\">createOrderLog</span><span class=\"token punctuation\">(</span>\r\n    manager<span class=\"token operator\">:</span> EntityManager<span class=\"token punctuation\">,</span>\r\n    logInfo<span class=\"token operator\">:</span> Partial<span class=\"token operator\">&lt;</span>OrderLogEntity<span class=\"token operator\">></span><span class=\"token punctuation\">,</span>\r\n  <span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token builtin\">Promise</span><span class=\"token operator\">&lt;</span><span class=\"token keyword\">void</span><span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token keyword\">const</span> repo <span class=\"token operator\">=</span> manager<span class=\"token punctuation\">.</span><span class=\"token function\">getRepository</span><span class=\"token punctuation\">(</span>OrderLogEntity<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n    <span class=\"token keyword\">const</span> log <span class=\"token operator\">=</span> repo<span class=\"token punctuation\">.</span><span class=\"token function\">create</span><span class=\"token punctuation\">(</span>logInfo<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n    \r\n    <span class=\"token keyword\">await</span> repo<span class=\"token punctuation\">.</span><span class=\"token function\">save</span><span class=\"token punctuation\">(</span>log<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n  <span class=\"token punctuation\">}</span>\r\n<span class=\"token punctuation\">}</span></code></pre></div>\n</li>\n</ul>\n<br>\r\n<br>\n<p>위 예시는 하나의 트랜잭션 컨텍스트에서 여러 작업(A, B, C 단계)을 진행하는 예시이다. 비즈니스 모델은 Service에서 담당하고 있으며 트랜잭션 제어를 위해 <strong>EntityManager</strong>를 레포지토리의 각 메서드에 전달하여 작업을 나누되 전체 흐름은 Service에서 제어하도록 구성해보았다.</p>\n<p>이 처럼 트랜잭션 처리는 단순히 기술적인 개념을 넘어서 <strong>“실제로 실패하면 어떤 데이터가 남는가?”</strong> 를 고민하는 문제라 생각한다.</p>\n<p>위 예시처럼 하나의 주문 요청에서 유저, 주문, 로그가 모두 성공해야만 저장되는 구조는 안정적인 서비스 운영을 위한 기본이 된다.</p>\n<br>\r\n<br>\n<h3 id=\"2-트랜잭션의-특징과-피해야할-패턴\" style=\"position:relative;\"><a href=\"#2-%ED%8A%B8%EB%9E%9C%EC%9E%AD%EC%85%98%EC%9D%98-%ED%8A%B9%EC%A7%95%EA%B3%BC-%ED%94%BC%ED%95%B4%EC%95%BC%ED%95%A0-%ED%8C%A8%ED%84%B4\" aria-label=\"2 트랜잭션의 특징과 피해야할 패턴 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2. 트랜잭션의 특징과 피해야할 패턴</h3>\n<hr>\n<p>트랜잭션의 흐름은 기본적으로 순차적이다. 위에서 예시를 들었지만 A → B → C 작업 순서대로 실행되고 중간에 하나라도 실패하면 롤백이 되어야한다.</p>\n<blockquote>\n<p>트랜잭션은 단순히 여러 작업을 하나로 묶는 것이 아니라 <strong>하나의 일관된 흐름으로 실행되어야 하는 작업 집합</strong>이다. 즉, 트랜잭션은 <strong>A 작업이 끝난 뒤 B, 그 다음 C</strong>와 같이  <strong>“순차적으로 실행되는 흐름”을 전제로 설계</strong>되어있다.</p>\n</blockquote>\n<br>\r\n<br>\n<p>특히 주의해야할 패턴은 <code class=\"language-text\">Promise.all()</code>과 같은 <strong>여러 비동기 작업을 동시에 실행</strong>하는 병렬 처리 방식이다.</p>\n<p>이 패턴은 각 작업의 결과가 성공이든 실패든 동시에 진행되며 서로의 실행 결과를 기다리지 않기 때문에 트랜잭션이 의도한 <strong>순차적 흐름</strong>이 무너지고 실패와 커밋 타이밍이 엇갈리면서 데이터 정합성 문제가 발생할 수 있다.</p>\n<p>예시를 들어보자면 다음과 같은 상황이 발생할 수 있다.</p>\n<ul>\n<li>\n<p><strong>GuestOrderService</strong> 클래스 → <code class=\"language-text\">Promise.all()</code> 문법 적용</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token decorator\"><span class=\"token at operator\">@</span><span class=\"token function\">Injectable</span></span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\r\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">GuestOrderService</span> <span class=\"token punctuation\">{</span>\r\n  <span class=\"token function\">constructor</span><span class=\"token punctuation\">(</span>\r\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">readonly</span> guestOrderRepository<span class=\"token operator\">:</span> GuestOrderRepository<span class=\"token punctuation\">,</span>\r\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">readonly</span> dataSource<span class=\"token operator\">:</span> DataSource<span class=\"token punctuation\">,</span>\r\n  <span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\r\n\r\n  <span class=\"token comment\">/**\r\n   * 비회원 유저의 상품 주문 요청 처리\r\n   * - A. 유저 정보 저장\r\n   * - B. 주문 정보 저장\r\n   * - C. 주문 로그 기록\r\n   * 모든 과정이 성공해야만 트랜잭션 커밋\r\n   */</span>\r\n  <span class=\"token keyword\">async</span> <span class=\"token function\">processGuestOrder</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token builtin\">Promise</span><span class=\"token operator\">&lt;</span><span class=\"token keyword\">void</span><span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\r\n    <span class=\"token comment\">// 트랜잭션 시작</span>\r\n    <span class=\"token keyword\">await</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>dataSource<span class=\"token punctuation\">.</span><span class=\"token function\">transaction</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span>manager<span class=\"token operator\">:</span> EntityManager<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\r\n      <span class=\"token keyword\">await</span> <span class=\"token builtin\">Promise</span><span class=\"token punctuation\">.</span><span class=\"token function\">all</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>\r\n        <span class=\"token comment\">// A. 유저 정보 저장 → 성공 ✅</span>\r\n        <span class=\"token keyword\">await</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>guestOrderRepository<span class=\"token punctuation\">.</span><span class=\"token function\">createGuestUser</span><span class=\"token punctuation\">(</span>manager<span class=\"token punctuation\">,</span> guestInfo<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n        <span class=\"token comment\">// B. 주문 정보 저장 → 실패 ❌</span>\r\n        <span class=\"token keyword\">await</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>guestOrderRepository<span class=\"token punctuation\">.</span><span class=\"token function\">createProductOrder</span><span class=\"token punctuation\">(</span>manager<span class=\"token punctuation\">,</span> orderInfo<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n        <span class=\"token comment\">// C. 주문 로그 기록 → 이미 실행됨 😱</span>\r\n        <span class=\"token keyword\">await</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>guestOrderRepository<span class=\"token punctuation\">.</span><span class=\"token function\">createOrderLog</span><span class=\"token punctuation\">(</span>manager<span class=\"token punctuation\">,</span> logInfo<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n      <span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\r\n  <span class=\"token punctuation\">}</span>\r\n<span class=\"token punctuation\">}</span></code></pre></div>\n</li>\n</ul>\n<br>\r\n<br>\n<p>위 예시 코드의 실행 결과 기대값은 아래와 같다.</p>\n<blockquote>\n<ol>\n<li>B에서 에러가 발생하더라도 C가 이미 실행되어 DB에 영향을 줬을 가능성이 존재한다.</li>\n<li>ROLLBACK 타이밍이 어긋나므로 데이터 정합성이 깨진다.</li>\n</ol>\n</blockquote>\n<br>\r\n<br>\n<p>위 코드를 실제로 <code class=\"language-text\">typeorm</code>의 로깅 기능을 활성화 한 뒤 실행해보면 <code class=\"language-text\">query: ROLLBACK</code> 로그 이후에도 이미 실행되어 진행 중인 쿼리 로그가 찍히고 있음을 확인 할 수 있다. (아래 로그는 같은 환경을 구성하여 출력해본 예시이다.)</p>\n<img src=\"https://jh8459.s3.ap-northeast-2.amazonaws.com/blog/2025-04-10-TIL/log.png\">\n<center><u><strong>query: ROLLBACK</strong></u> 로그 이후에도 이미 실행된 쿼리 로그들을 확인할 수 있다. 🥲</center><br><br>\n<p>즉, <strong>트랜잭션은 비동기 처리를 허용</strong>하지만 병렬 실행을 전제로 하지 않는다. 내부 흐름은 “차례차례 실행될 것”이라는 가정 위에 작동하므로 사용에 유의해야한다.</p>\n<br>\r\n<br>\n<h2 id=\"-understanding\" style=\"position:relative;\"><a href=\"#-understanding\" aria-label=\" understanding permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>🤔 Understanding</h2>\n<p>성능을 위해 병렬로 처리하고 싶은 욕구는 항상 생기지만 트랜잭션이 개입되는 순간 안정성 vs 성능의 균형을 따져야 한다. <del>(코드의 문제는 에러로 끝나지만, 데이터 문제는 비즈니스 모델 신뢰성에 영향을 준다.. 😂)</del></p>\n<p>이번 포스팅을 정리하면서 단순히 비즈니스 요구사항에 따라 트랜잭션을 적용하는 것에서 그치지 않고 <strong>트랜잭션을 중심으로 Repository 구조를 어떻게 설계해야 하는지</strong>, 그리고 나아가 별도 트랜잭션 관리 도구 도입 여부까지 고민해보는 계기가 되었다.</p>\n<p>아래의 고민들은 아직 정리가 안되어서 추후 포스팅으로 남길 수 있으면 남겨보도록해야겠다.</p>\n<blockquote>\n<ol>\n<li>트랜잭션을 고려한 Repository 디자인 패턴 검토</li>\n<li>별도 라이브러리 도입 검토 (typeorm-transactional)</li>\n</ol>\n</blockquote>\n<br>\r\n<br>\n<div class=\"gatsby-highlight\" data-language=\"toc\"><pre class=\"language-toc\"><code class=\"language-toc\"></code></pre></div>","excerpt":"✍️ Today I Learned 현재 사내 프레임워크는 NestJS를 사용하고 있으며 클라이언트에게 요청을 받고 응답을 반환하는 Controller 클래스와 비즈니스 로직을 담당하는 Service 클래스 그리고 최종적으로 데이터베이스에 CRUD 작업을 담당하는 Repository 클래스를 사용하는 계층형 아키텍처로 구성하여 사용하고 있다. 단순한 단일 INSERT, UPDATE를 넘어서, “모든 작업이 성공해야만 커밋하고, 하나라도 실패하면 전부 롤백” 되어야 하는 비즈니스 구조는 빈번히 일어난다. (이러한 상황은 실무에서 꽤나 자주 마주친다. 🥲) 이런 경우 Service 클래스의 하나의 메서드 안에서 여러 개의 DB 작업을 처리해야 할 때 을 활용해서 트랜잭션을 사용하고 있다. 꼭 이렇게 사용해야만 한다는건 아니지만, 이 점은 꼭 주의해야할 패턴에 대해 느낀점이 있다. 오늘은 이를 간략하게 기록으로 남겨보려한다. 1. 트랜잭션이란? 사실, 우리가 흔히 말하는 트랜잭션(Trans…","timeToRead":4,"tableOfContents":"<ul>\n<li>\n<p><a href=\"#%EF%B8%8F-today-i-learned\">✍️ <strong>T</strong>oday <strong>I</strong> <strong>L</strong>earned</a></p>\n<ul>\n<li><a href=\"#1-%ED%8A%B8%EB%9E%9C%EC%9E%AD%EC%85%98%EC%9D%B4%EB%9E%80\">1. 트랜잭션이란?</a></li>\n<li><a href=\"#2-%ED%8A%B8%EB%9E%9C%EC%9E%AD%EC%85%98%EC%9D%98-%ED%8A%B9%EC%A7%95%EA%B3%BC-%ED%94%BC%ED%95%B4%EC%95%BC%ED%95%A0-%ED%8C%A8%ED%84%B4\">2. 트랜잭션의 특징과 피해야할 패턴</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#-understanding\">🤔 Understanding</a></p>\n</li>\n</ul>","frontmatter":{"date":"2025.04.10","title":"NestJS + TypeORM 트랜잭션을 다룰 때 반드시 피해야 할 패턴","categories":"TIL","author":"JH8459","emoji":"📚"},"fields":{"slug":"/2025-04-10-TIL/"}},"next":{"id":"339c4b95-e05a-5ddc-8f1f-eb9e6ff88faf","html":"<img src=\"https://jh8459.s3.ap-northeast-2.amazonaws.com/blog/2025-03-31-PROJECT/banner.png\">\n<br>\n<h2 id=\"왜-ec2에서-nas로-옮기게-되었는가\" style=\"position:relative;\"><a href=\"#%EC%99%9C-ec2%EC%97%90%EC%84%9C-nas%EB%A1%9C-%EC%98%AE%EA%B8%B0%EA%B2%8C-%EB%90%98%EC%97%88%EB%8A%94%EA%B0%80\" aria-label=\"왜 ec2에서 nas로 옮기게 되었는가 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>왜 EC2에서 NAS로 옮기게 되었는가?</h2>\n<p>사용 중인 NAS의 사용성이 DSM 7.2+ (Synology사의 DS920+ 기준) 부터 많이 달라졌다. 단순히 UI/UX만 변경된것이 아니라 (구)Docker 패키지에서 변경된 <strong>Container Manager 패키지</strong>는 다중 컨테이너 환경을 지원한다.</p>\n<br>\n<img src=\"https://jh8459.s3.ap-northeast-2.amazonaws.com/blog/2025-03-31-PROJECT/container_manager.jpg\">\n<center>Docker Compose! 😲</center><br><br>\n<p>EC2 t2.micro 인스턴스로 사용 중이던 서버에 올려둔 컨테이너 기반의 <a href=\"https://blog.jh8459.com/2024-07-01-PROJECT/\" target=\"_blank\">프로젝트 (LOTTERY 🍀)</a>를 비용 효율적인 측면에서 마이그레이션하기 좋은 기회라 생각했다.</p>\n<p>EC2에서 NAS로 마이그레이션하는 과정과 Github Action + Docker Hub를 사용한 CI / CD 구축한 과정 또한 간략히 남겨 보려한다.</p>\n<br>\r\n<br>\n<h3 id=\"1-cicd-파이프라인-구성\" style=\"position:relative;\"><a href=\"#1-cicd-%ED%8C%8C%EC%9D%B4%ED%94%84%EB%9D%BC%EC%9D%B8-%EA%B5%AC%EC%84%B1\" aria-label=\"1 cicd 파이프라인 구성 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. CI/CD 파이프라인 구성</h3>\n<hr>\n<p>전반적인 CI/CD는 <strong>Github Action</strong> + <strong>Docker Hub</strong> 를 활용하였으며, CI / CD 나누어 Github 저장소의 브런치를 활용해서 파이프라인을 구성하였다. (CI/CD 모두를 자동화는 아래와 같은 무중단 배포 전략까지 도입 후 수정할 예정이다.)</p>\n<blockquote>\n<p>👉 <a href=\"https://blog.jh8459.com/2025-03-16-TIL/\" target=\"_blank\">Docker Compose와 Traefik을 활용한 Blue/Green 배포 전략</a></p>\n</blockquote>\n<br>\n<img src=\"https://jh8459.s3.ap-northeast-2.amazonaws.com/blog/2025-03-31-PROJECT/pipeline.png\">\n<center>전반적인 CI/CD 흐름은 위 사진과 같이 진행된다. 🤖</center><br><br>\n<ol>\n<li>\n<p>Local Repository에서 작업한 결과물을 Github 원격 Remote Repository의 <code class=\"language-text\">master</code> 브런치로 Push 한다.</p>\n</li>\n<li>\n<p><code class=\"language-text\">master</code> 브런치로 Commit이 Push되면 아래의 조건을 갖는 Github Action <strong>(CI)</strong> 이 동작한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"yml\"><pre class=\"language-yml\"><code class=\"language-yml\"><span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Build &amp; Push Docker Images (CI)\r\n\r\n<span class=\"token key atrule\">on</span><span class=\"token punctuation\">:</span>\r\n  <span class=\"token key atrule\">push</span><span class=\"token punctuation\">:</span>\r\n    <span class=\"token key atrule\">branches</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'master'</span><span class=\"token punctuation\">]</span>\r\n<span class=\"token punctuation\">...</span></code></pre></div>\n</li>\n<li>\n<p>Github Action Runner를 통해서 <code class=\"language-text\">master</code> 브런치에 올라간 코드를 기반으로 Docker Image가 빌드되고 빌드 성공시 Docker Hub에 Push한다.</p>\n</li>\n<li>\n<p>Github Action <strong>(CI)</strong> 이 성공하면 배포 준비가 완료된 상태이다. 배포가 필요하다면 <code class=\"language-text\">prod</code> 브런치로 PR을 날린다.</p>\n</li>\n<li>\n<p><code class=\"language-text\">prod</code> 브런치로 PR이 Merge되면 아래의 조건을 갖는 Github Action <strong>(CD)</strong> 이 동작한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"yml\"><pre class=\"language-yml\"><code class=\"language-yml\"><span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Deploy to NAS (CD)\r\n\r\n<span class=\"token key atrule\">on</span><span class=\"token punctuation\">:</span>\r\n  <span class=\"token key atrule\">pull_request</span><span class=\"token punctuation\">:</span>\r\n    <span class=\"token key atrule\">branches</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'prod'</span><span class=\"token punctuation\">]</span>\r\n<span class=\"token punctuation\">...</span></code></pre></div>\n</li>\n<li>\n<p>Github Action Runner를 통해서 NAS에 SSH접속이 이뤄지며 운영 환경에 알맞는 <code class=\"language-text\">.env</code> 환경변수 파일을 생성한다.</p>\n</li>\n<li>\n<p>Docker Hub에 올라간 Docker Image를 기반으로 NAS 서버에 배포를 진행한다.</p>\n</li>\n</ol>\n<br>\r\n<br>\n<h3 id=\"2-nas에서-환경-구성\" style=\"position:relative;\"><a href=\"#2-nas%EC%97%90%EC%84%9C-%ED%99%98%EA%B2%BD-%EA%B5%AC%EC%84%B1\" aria-label=\"2 nas에서 환경 구성 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2. NAS에서 환경 구성</h3>\n<hr>\n<p>위에서 언급한 CI/CD 파이프라인을 구성하려면 NAS에도 아래와 같은 환경 구성이 필요하다.</p>\n<blockquote>\n<p>이용 중인 NAS의 OS는 <strong>Ubuntu OS</strong>가 아닌 Synology에서 개발된 자체 OS인 <strong>DSM</strong>을 사용하기 때문에, <code class=\"language-text\">sudo apt-get install git</code> 같은 CLI 명령어가 아닌 DSM 패키지 센터를 통해 아래와 같은 환경을 구성해줘야 한다.</p>\n</blockquote>\n<br>\r\n<br>\n<h4 id=\"2-1-container-manager-패키지-설치\" style=\"position:relative;\"><a href=\"#2-1-container-manager-%ED%8C%A8%ED%82%A4%EC%A7%80-%EC%84%A4%EC%B9%98\" aria-label=\"2 1 container manager 패키지 설치 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2-1. Container Manager 패키지 설치</h4>\n<hr>\n<p>전반적인 <strong>Container Manager</strong>를 활용한 NAS 환경 구성은 서버 포럼의<a href=\"https://svrforum.com/nas/695302\" target=\"_blank\">“이제 시놀로지에서 Docker-compose를(?) DSM 7.2의 Container Mananger”</a>게시글을 보고 구성하였다. 🙏🙏🙏</p>\n<p>volume을 설정할때 디렉토리는 추후 <strong>docker-compose.yml</strong> 파일이 수정되는 경우에도 Github 원격 저장소의 <code class=\"language-text\">prod</code> 브런치의 코드를 내려받아 최신화되어야한다. (이를 염두하고 설정하자.)</p>\n<img src=\"https://jh8459.s3.ap-northeast-2.amazonaws.com/blog/2025-03-31-PROJECT/volume.png\">\n<br>\r\n<br>\n<h4 id=\"2-2-git-server-패키지-설치\" style=\"position:relative;\"><a href=\"#2-2-git-server-%ED%8C%A8%ED%82%A4%EC%A7%80-%EC%84%A4%EC%B9%98\" aria-label=\"2 2 git server 패키지 설치 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2-2. Git Server 패키지 설치</h4>\n<hr>\n<p>CLI 명령으로 설치가 안되므로 DSM 패키지 센터의 <strong>Git Server</strong> 패키지를 내려 받아야 한다.</p>\n<img src=\"https://jh8459.s3.ap-northeast-2.amazonaws.com/blog/2025-03-31-PROJECT/git.png\">\n<br>\r\n<br>\n<h4 id=\"2-3-nas의-ssh-원격-접속-포트-허용\" style=\"position:relative;\"><a href=\"#2-3-nas%EC%9D%98-ssh-%EC%9B%90%EA%B2%A9-%EC%A0%91%EC%86%8D-%ED%8F%AC%ED%8A%B8-%ED%97%88%EC%9A%A9\" aria-label=\"2 3 nas의 ssh 원격 접속 포트 허용 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2-3. NAS의 SSH 원격 접속 포트 허용</h4>\n<hr>\n<p>CI/CD 과정에서 Github Action 통해서 NAS로 SSH 접속이 이뤄져야 하므로 해당 옵션을 허용해주자.</p>\n<img src=\"https://jh8459.s3.ap-northeast-2.amazonaws.com/blog/2025-03-31-PROJECT/ssh.png\">\n<br>\r\n<br>\n<h4 id=\"2-4-nas의-역방향-프록시-설정\" style=\"position:relative;\"><a href=\"#2-4-nas%EC%9D%98-%EC%97%AD%EB%B0%A9%ED%96%A5-%ED%94%84%EB%A1%9D%EC%8B%9C-%EC%84%A4%EC%A0%95\" aria-label=\"2 4 nas의 역방향 프록시 설정 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2-4. NAS의 역방향 프록시 설정</h4>\n<hr>\n<p>Ubuntu OS에서 웹 서버를 구성할 땐 <strong>traefik</strong> 혹은 <strong>nginx</strong>를 사용하여 역방향 프록시(Reverse Proxy) 서버 구성을 하였지만, DSM 기본 기능인 역방향 프록시 기능을 사용하여 도메인 소스와 NAS 내부 서비스를 맵핑 시켜주었다.</p>\n<img src=\"https://jh8459.s3.ap-northeast-2.amazonaws.com/blog/2025-03-31-PROJECT/reverse.png\">\n<br>\r\n<br>\n<h4 id=\"2-4-공유기-포트포워딩-설정\" style=\"position:relative;\"><a href=\"#2-4-%EA%B3%B5%EC%9C%A0%EA%B8%B0-%ED%8F%AC%ED%8A%B8%ED%8F%AC%EC%9B%8C%EB%94%A9-%EC%84%A4%EC%A0%95\" aria-label=\"2 4 공유기 포트포워딩 설정 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2-4. 공유기 포트포워딩 설정</h4>\n<hr>\n<p>홈 네트워크는 보통 공유기를 사용중일텐데 외부망을 통해 NAS에서 실행중인 어플리케이션에 도달하려면 공유기의 포트 포워딩 규칙을 허용해줘야 한다.</p>\n<p>어플리케이션이 NAS의 1111번 포트를 사용중이라면 아래와 같은 규칙을 허용해주어야 한다.</p>\n<p><img src=\"https://jh8459.s3.ap-northeast-2.amazonaws.com/blog/2025-03-31-PROJECT/port.png\"><br></p>\n<br>\r\n<br>\n<h3 id=\"3-github-actions-살펴보기\" style=\"position:relative;\"><a href=\"#3-github-actions-%EC%82%B4%ED%8E%B4%EB%B3%B4%EA%B8%B0\" aria-label=\"3 github actions 살펴보기 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3. GitHub Actions 살펴보기</h3>\n<hr>\n<p>기본적으로 <strong>Public</strong> 저장소이기 때문에 노출되면 안되는 값들은 Github Repository에서 제공하는 환경 변수를 통해 변인 요인들을 관리하고 있다.</p>\n<p>Github Action은 CI/CD 파이프라인이 모두 자동화되고 있진 않으므로 이미지 빌드를 담당하는 <strong>ci.yml</strong>과 NAS로 원격 접속하여 배포를 진행하는 <strong>cd.yml</strong> 두개로 분리하여 구성하였다.</p>\n<br>\r\n<br>\n<h4 id=\"3-1-ciyml\" style=\"position:relative;\"><a href=\"#3-1-ciyml\" aria-label=\"3 1 ciyml permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3-1. ci.yml</h4>\n<hr>\n<div class=\"gatsby-highlight\" data-language=\"yml\"><pre class=\"language-yml\"><code class=\"language-yml\"><span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Build &amp; Push Docker Images (CI)\r\n\r\n<span class=\"token key atrule\">on</span><span class=\"token punctuation\">:</span>\r\n  <span class=\"token key atrule\">push</span><span class=\"token punctuation\">:</span>\r\n    <span class=\"token key atrule\">branches</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>master<span class=\"token punctuation\">]</span>\r\n\r\n<span class=\"token key atrule\">jobs</span><span class=\"token punctuation\">:</span>\r\n  <span class=\"token key atrule\">deploy</span><span class=\"token punctuation\">:</span>\r\n    <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> CI\r\n    <span class=\"token key atrule\">runs-on</span><span class=\"token punctuation\">:</span> ubuntu<span class=\"token punctuation\">-</span>latest\r\n\r\n    <span class=\"token key atrule\">steps</span><span class=\"token punctuation\">:</span>\r\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Checkout Repository\r\n        <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> actions/checkout@v4\r\n\r\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Set up Docker Buildx\r\n        <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> docker/setup<span class=\"token punctuation\">-</span>buildx<span class=\"token punctuation\">-</span>action@v3\r\n\r\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Login to DockerHub\r\n        <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> docker/login<span class=\"token punctuation\">-</span>action@v3\r\n        <span class=\"token key atrule\">with</span><span class=\"token punctuation\">:</span>\r\n          <span class=\"token key atrule\">username</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.DOCKERHUB_USERNAME <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\r\n          <span class=\"token key atrule\">password</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.DOCKERHUB_PASSWORD <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\r\n\r\n      <span class=\"token comment\"># Build and push API</span>\r\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Build and Push lottery_api_server Image\r\n        <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">|</span><span class=\"token scalar string\">\r\n          docker build -t ${{ secrets.DOCKERHUB_USERNAME }}/lottery_api_server:latest ./api\r\n          docker push ${{ secrets.DOCKERHUB_USERNAME }}/lottery_api_server:latest</span>\r\n\r\n      <span class=\"token comment\"># Build and push Crawler</span>\r\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Build and Push lottery_crawler_server Image\r\n        <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">|</span><span class=\"token scalar string\">\r\n          docker build -t ${{ secrets.DOCKERHUB_USERNAME }}/lottery_crawler_server:latest ./crawler\r\n          docker push ${{ secrets.DOCKERHUB_USERNAME }}/lottery_crawler_server:latest</span>\r\n\r\n      <span class=\"token comment\"># Build and push Website</span>\r\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Build and Push lottery_website Image\r\n        <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">|</span><span class=\"token scalar string\">\r\n          docker build -t ${{ secrets.DOCKERHUB_USERNAME }}/lottery_website:latest ./website\r\n          docker push ${{ secrets.DOCKERHUB_USERNAME }}/lottery_website:latest</span></code></pre></div>\n<br>\r\n<br>\n<h4 id=\"3-2-cdyml\" style=\"position:relative;\"><a href=\"#3-2-cdyml\" aria-label=\"3 2 cdyml permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3-2. cd.yml</h4>\n<hr>\n<div class=\"gatsby-highlight\" data-language=\"yml\"><pre class=\"language-yml\"><code class=\"language-yml\"><span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Deploy to NAS (CD)\r\n\r\n<span class=\"token key atrule\">on</span><span class=\"token punctuation\">:</span>\r\n  <span class=\"token key atrule\">pull_request</span><span class=\"token punctuation\">:</span>\r\n    <span class=\"token key atrule\">branches</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>prod<span class=\"token punctuation\">]</span>\r\n\r\n<span class=\"token key atrule\">jobs</span><span class=\"token punctuation\">:</span>\r\n  <span class=\"token key atrule\">deploy</span><span class=\"token punctuation\">:</span>\r\n    <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Deploy to NAS\r\n    <span class=\"token key atrule\">runs-on</span><span class=\"token punctuation\">:</span> ubuntu<span class=\"token punctuation\">-</span>latest\r\n\r\n    <span class=\"token key atrule\">steps</span><span class=\"token punctuation\">:</span>\r\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Connect to NAS via SSH and deploy\r\n        <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> appleboy/ssh<span class=\"token punctuation\">-</span>action@v0.1.6\r\n        <span class=\"token key atrule\">with</span><span class=\"token punctuation\">:</span>\r\n          <span class=\"token key atrule\">host</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.NAS_HOST <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\r\n          <span class=\"token key atrule\">username</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.NAS_USER <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\r\n          <span class=\"token key atrule\">password</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.NAS_PASSWORD <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\r\n          <span class=\"token key atrule\">port</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.NAS_PORT <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\r\n          <span class=\"token key atrule\">script</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">|</span><span class=\"token scalar string\">\r\n            echo \"✅ NAS 접속 성공\"</span>\r\n\r\n            cd /volume1/docker/lottery\r\n\r\n            echo \"📦 COMMON .env 생성\"\r\n            <span class=\"token punctuation\">[</span> <span class=\"token punctuation\">-</span>f .env <span class=\"token punctuation\">]</span> <span class=\"token important\">&amp;&amp;</span> rm .env\r\n            cat &lt;&lt;EOF <span class=\"token punctuation\">></span> .env\r\n            NODE_ENV=$<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.NODE_ENV <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\r\n            API_SERVER_PORT=$<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.API_SERVER_PORT <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\r\n            CRAWLER_SERVER_PORT=$<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.CRAWLER_SERVER_PORT <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\r\n            WEBSITE_PORT=$<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.WEBSITE_PORT <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\r\n            EOF\r\n\r\n            echo \"📦 API .env 생성\"\r\n            mkdir <span class=\"token punctuation\">-</span>p ./api\r\n            <span class=\"token punctuation\">[</span> <span class=\"token punctuation\">-</span>f ./api/.env <span class=\"token punctuation\">]</span> <span class=\"token important\">&amp;&amp;</span> rm ./api/.env\r\n            cat &lt;&lt;EOF <span class=\"token punctuation\">></span> ./api/.env\r\n            DB_HOST=$<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.DB_HOST <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\r\n            DB_PORT=$<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.DB_PORT <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\r\n            DB_USER=$<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.DB_USER <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\r\n            DB_PASSWORD=$<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.DB_PASSWORD <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\r\n            DB_DATABASE=$<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.DB_DATABASE <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\r\n            API_NODE_ENV=$<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.API_NODE_ENV <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\r\n            API_SERVER_PORT=$<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.API_SERVER_PORT <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\r\n            API_EMAIL_USERNAME=$<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.API_EMAIL_USERNAME <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\r\n            API_EMAIL_PASSWORD=$<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.API_EMAIL_PASSWORD <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\r\n            API_EMAIL_HOST=$<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.API_EMAIL_HOST <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\r\n            API_EMAIL_PORT=$<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.API_EMAIL_PORT <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\r\n            API_EMAIL_FROM=$<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.API_EMAIL_FROM <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\r\n            API_REDIS_HOST=$<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.API_REDIS_HOST <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\r\n            API_REDIS_PORT=$<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.API_REDIS_PORT <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\r\n            API_SLACK_SIGNING_SECRET=$<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.API_SLACK_SIGNING_SECRET <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\r\n            API_SLACK_BOT_TOKEN=$<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.API_SLACK_BOT_TOKEN <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\r\n            API_SLACK_CLIENT_ID=$<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.API_SLACK_CLIENT_ID <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\r\n            API_SLACK_CLIENT_SECRET=$<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.API_SLACK_CLIENT_SECRET <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\r\n            COMMON_GITHUB_TOKEN=$<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.COMMON_GITHUB_TOKEN <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\r\n            SWAGGER_USERNAME=$<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.SWAGGER_USERNAME <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\r\n            SWAGGER_PASSWORD=$<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.SWAGGER_PASSWORD <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\r\n            EOF\r\n\r\n            echo \"📦 CRAWLER .env 생성\"\r\n            mkdir <span class=\"token punctuation\">-</span>p ./crawler\r\n            <span class=\"token punctuation\">[</span> <span class=\"token punctuation\">-</span>f ./crawler/.env <span class=\"token punctuation\">]</span> <span class=\"token important\">&amp;&amp;</span> rm ./crawler/.env\r\n            cat &lt;&lt;EOF <span class=\"token punctuation\">></span> ./crawler/.env\r\n            DB_HOST=$<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.DB_HOST <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\r\n            DB_PORT=$<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.DB_PORT <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\r\n            DB_USER=$<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.DB_USER <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\r\n            DB_PASSWORD=$<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.DB_PASSWORD <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\r\n            DB_DATABASE=$<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.DB_DATABASE <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\r\n            CRAWLER_SERVER_PORT=$<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.CRAWLER_SERVER_PORT <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\r\n            COMMON_GITHUB_TOKEN=$<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> secrets.COMMON_GITHUB_TOKEN <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\r\n            EOF\r\n\r\n            echo \"🌀 GitHub prod 브랜치 코드 최신화\"\r\n            git fetch origin\r\n            git reset <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>hard origin/prod\r\n\r\n            echo \"📁 필요한 디렉토리 생성\"\r\n            mkdir <span class=\"token punctuation\">-</span>p ./api/logs ./api/public ./api/resource\r\n            mkdir <span class=\"token punctuation\">-</span>p ./crawler/logs ./crawler/public ./crawler/resource\r\n            mkdir <span class=\"token punctuation\">-</span>p ./redis<span class=\"token punctuation\">-</span>data\r\n\r\n            echo \"🐳 Docker 이미지 Pull\"\r\n            /usr/local/bin/docker<span class=\"token punctuation\">-</span>compose pull\r\n\r\n            echo \"🧨 기존 컨테이너 중지\"\r\n            /usr/local/bin/docker<span class=\"token punctuation\">-</span>compose down\r\n\r\n            echo \"🚀 최신 이미지로 컨테이너 재시작\"\r\n            /usr/local/bin/docker<span class=\"token punctuation\">-</span>compose up <span class=\"token punctuation\">-</span>d\r\n\r\n            echo \"✅ 배포 완료 🎉\"</code></pre></div>\n<br>\r\n<br>\n<h2 id=\"-understanding\" style=\"position:relative;\"><a href=\"#-understanding\" aria-label=\" understanding permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>🤔 Understanding</h2>\n<p>사진이나 중요 자료 백업 목적으로 구매했던 NAS를 다양하게 활용할 수 있는 방법을 알게되었다. (또한, 얼마 안되지만 EC2로 매달 나가는 비용을 아낄 수 있게 되었다.)</p>\n<p>NAS의 스펙이 그리 좋지 않기에 훌륭한 서버까진 아니지만, 토이 프로젝트 정도는 거뜬히 소화할 수 있을거같다. (훌륭한 장난감이 생겼다 😀)</p>\n<p>EC2에서 Synology NAS로 옮겨온 이번 과정에서 가장 크게 느낀 점은, <strong>결국 중요한 건 도구가 아니라 흐름에 대한 이해</strong>를 하는게 가장 중요하다는 점이었다. 언어나 특정 프레임워크에 종속되지 말고 전반적인 CS 지식을 조금 더 공부해보고 싶어졌다.</p>\n<br>\r\n<br>\n<div class=\"gatsby-highlight\" data-language=\"toc\"><pre class=\"language-toc\"><code class=\"language-toc\"></code></pre></div>","frontmatter":{"date":"2025.03.31","title":"EC2에서 NAS로, 개인 서버 CI/CD 자동화","categories":"Project","author":"JH8459","emoji":"🔥"},"fields":{"slug":"/2025-03-31-PROJECT/"}},"prev":{"id":"df72ad6e-8bde-5e71-bee8-f3d9375b3382","html":"<img src=\"https://jh8459.s3.ap-northeast-2.amazonaws.com/blog/2025-04-29-PROJECT/thumbnail.png\">\n<br>\n<h2 id=\"e2e-테스트-설계와-테스트-자동화\" style=\"position:relative;\"><a href=\"#e2e-%ED%85%8C%EC%8A%A4%ED%8A%B8-%EC%84%A4%EA%B3%84%EC%99%80-%ED%85%8C%EC%8A%A4%ED%8A%B8-%EC%9E%90%EB%8F%99%ED%99%94\" aria-label=\"e2e 테스트 설계와 테스트 자동화 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>E2E 테스트 설계와 테스트 자동화</h2>\n<p>이전 포스팅 중 개인 서버에 CI/CD 구축한 과정을 소개한적이 있다.</p>\n<blockquote>\n<p><a href=\"https://blog.jh8459.com/2025-03-31-PROJECT/\">EC2에서 NAS로, 개인 서버 CI/CD 자동화</a>에서는 EC2 환경에서 Synology NAS로 이전하며 개인 서버에서도 CI/CD 파이프라인을 자동화한 과정을 공유했었다.</p>\n</blockquote>\n<br/>\n<p>하지만 변경된 코드가 정상적으로 동작하는지를 보장하지 못한다면 빌드·배포의 자동화는 그 의미가 많이 퇴색된다 생각한다. <strong>(새로 배포된 코드로 인해 장애가 발생한다면..👀 ??)</strong></p>\n<p>코드의 품질을 테스트하는 방법에는 여러 접근 방식이 있다. (한 가지 정답이 있다고는 생각하지 않는다.)</p>\n<p>오늘은 어떤 접근 방식으로 코드와 서비스의 품질을 검증할 수 있을지에 대한 나만의 방향성을 정리하고 이 과정을 CI 단계에서 E2E 테스트를 선행하도록 구조를 확장하게 된 경험을 최대한 간단히 정리해서 남겨 보려한다.</p>\n<br>\r\n<br>\n<h3 id=\"1-e2e-관점에서-본-코드-품질-테스트\" style=\"position:relative;\"><a href=\"#1-e2e-%EA%B4%80%EC%A0%90%EC%97%90%EC%84%9C-%EB%B3%B8-%EC%BD%94%EB%93%9C-%ED%92%88%EC%A7%88-%ED%85%8C%EC%8A%A4%ED%8A%B8\" aria-label=\"1 e2e 관점에서 본 코드 품질 테스트 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. E2E 관점에서 본 코드 품질 테스트</h3>\n<hr>\n<p>작년까지만 해도 각각의 서비스나 유틸리티 함수가 의도한 대로 동작하는지를 검증하는 테스트를 만들기 위해 노력했었다.</p>\n<blockquote>\n<p>예전 포스팅 중 <a href=\"https://blog.jh8459.com/2024-07-15-TIL/\">테스트 커버리지 (Feat. SLASH 21)</a>때만 회고해보아도 단순히 높은 커버리지를 구현해보려 노력한 내 자신을 찾아볼 수 있다. 🥲</p>\n</blockquote>\n<br/>\n<p>하지만 프로젝트가 점차 복잡해지고 다양한 외부 요인(DB, Redis, 외부 API 등)등에 통합되면서 단순히 코드 단위로만 검증하는 방식에 한계를 느끼게 되었다. 로컬 환경에서는 문제가 없이 테스트도 통과한 코드가 실제 환경에서는 DB 연결 문제 혹은 외부 API 응답 오류 등으로 장애를 발생시키는 경우가 발생했기 때문이다.</p>\n<p>단위 테스트 만으로는 각 모듈이 고립되어 제대로 동작하는지를 검증할 뿐 “전체 시스템이 유기적으로 작동하는지”까지는 보장해주지 않는다는 것을 절감하게 됐다.</p>\n<p>이런 경험을 통해 단순히 코드 하나하나가 잘 돌아가는지가 아니라 서비스 전체 플로우가 정상적으로 동작하는지를 검증하는 테스트가 필요하다고 확신하게 되었다.</p>\n<br>\n<img src=\"https://jh8459.s3.ap-northeast-2.amazonaws.com/blog/2025-04-29-PROJECT/e2e.png\">\n<br><br>\n<p>이런 문제 의식을 갖게되니 자연스럽게 “E2E(End-to-End) 테스트”에 관심을 갖게 되었다.</p>\n<p>단순히 API가 응답하는지만 보는 것이 아니라, 실제로 DB에 데이터를 저장하고 Redis에 캐시를 갱신하며 외부 API와 요청을 주고 받는 전체 흐름을 검증하고자 노력했다. 따라서 가능한 많은 실제 자원(DB, Redis)을 운영 환경과 동일한 환경의 테스트 컨테이너로 구동하여 로컬과 CI 환경에서도 실제 서비스에 근접한 환경으로 테스트하도록 방향을 잡았다.</p>\n<p>결국, 단순히 “코드에 에러는 없는가”를 넘어서 <strong>“전체적으로 문제없이 동작하는가”</strong>를 검증하는 것이 진정한 품질 보장이라는 생각에 이르게 되었다.</p>\n<br>\r\n<br>\n<h3 id=\"2-mocking-vs-실제-자원-사용-기준\" style=\"position:relative;\"><a href=\"#2-mocking-vs-%EC%8B%A4%EC%A0%9C-%EC%9E%90%EC%9B%90-%EC%82%AC%EC%9A%A9-%EA%B8%B0%EC%A4%80\" aria-label=\"2 mocking vs 실제 자원 사용 기준 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2. Mocking vs 실제 자원 사용 기준</h3>\n<hr>\n<p>테스트 코드를 작성할 때 가장 고민스러웠던 지점 중 하나는 <strong>“어디까지를 실제로 호출할 것인가?”</strong> 였다. 실제 서비스 흐름을 따라가는 E2E 테스트를 지향한다고 아래와 같은 경우는 분명히 발생할 수 있기 때문이다.</p>\n<ul>\n<li>별도의 인증(2fa)이 필요하거나 요금이나 이용 횟수 제한이 있는 API 호출이 필요한 경우.</li>\n<li>예외 상황을 만들어내기 어려운 조건(ex. token 만료 등)이 필요한 경우.</li>\n<li>테스트 속도, 비용, 안정성을 고려해 실제 호출된다면 부작용이 발생할 수 있는 경우.</li>\n</ul>\n<p>따라서 위 기준으로 실제 자원을 사용하는 경우와 목킹(Mocking)을 사용하는 경우를 나누어 실제 호출 여부를 판단했다.</p>\n<br>\r\n<br>\n<p>오늘 예시로 설명할 <a href=\"https://blog.jh8459.com/2024-07-01-PROJECT/\">LOTTERY 🍀</a> 프로젝트의 실제 자원을 사용하는 경우와 목킹(Mocking)을 사용하는 경우는 아래와 같다.</p>\n<br>\n<blockquote>\n<p><strong>[실제 자원을 사용하는 기준]</strong></p>\n<ul>\n<li>DB, Redis는 테스트 컨테이너로 별도로 구동되며 실제 데이터를 읽고 쓰는 테스트를 진행한다.</li>\n<li>Slack Webhook 또는 이메일 발송처럼 사용자 알림과 연관된 기능은 실제 전송은 하지 않지만 전송 직전까지의 흐름을 검증한다.</li>\n<li>API 요청/응답 구조, Slack 명령어 및 액션 흐름과 DB 저장 이후 Slack 전송 등 비즈니스 플로우는 실제 자원들과 연결된 상태로 테스트한다.</li>\n</ul>\n</blockquote>\n<br>\n<blockquote>\n<p><strong>[Mocking이 필요한 기준]</strong></p>\n<ul>\n<li>Slack OAuth, GitHub API와 같이 인증이 필요한 API는 mocking으로 대체하였다.</li>\n<li>예외 상황을 만들어내기 어려운 조건들(ex. Slack API 호출 실패)은 mocking을 통해 시나리오를 구성했다.</li>\n</ul>\n</blockquote>\n<br>\r\n<br>\n<h3 id=\"3-테스트-자동화-구축-과정\" style=\"position:relative;\"><a href=\"#3-%ED%85%8C%EC%8A%A4%ED%8A%B8-%EC%9E%90%EB%8F%99%ED%99%94-%EA%B5%AC%EC%B6%95-%EA%B3%BC%EC%A0%95\" aria-label=\"3 테스트 자동화 구축 과정 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3. 테스트 자동화 구축 과정</h3>\n<hr>\n<p>E2E 테스트를 수동으로만 돌려보는 수준이라면 테스트의 신뢰도는 점점 떨어질 수 있다 생각했다. <strong>(개발자가 실수 혹은 악의적인 의도를 갖고 테스트를 실행을 안했다면..? 👀)</strong></p>\n<p>테스트가 항상 유의미하기 위해서는 파이프라인에 자연스럽게 녹아들어야 한다고 생각했고 실제로 그렇게 구성해보려 노력하였다. 내가 설계한 테스트 자동화는 다음과 같은 흐름으로 동작한다.</p>\n<br>\r\n<br>\n<h4 id=\"3-1-테스트용-컨테이너-구성\" style=\"position:relative;\"><a href=\"#3-1-%ED%85%8C%EC%8A%A4%ED%8A%B8%EC%9A%A9-%EC%BB%A8%ED%85%8C%EC%9D%B4%EB%84%88-%EA%B5%AC%EC%84%B1\" aria-label=\"3 1 테스트용 컨테이너 구성 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3-1. 테스트용 컨테이너 구성</h4>\n<hr>\n<p>E2E 테스트 환경은 실제 서비스와 동일한 구성의 DB(MariaDB), Redis를 담은 <code class=\"language-text\">docker-compose.test.yml</code>로 시작된다. 이 컨테이너들은 테스트 실행 직전에 자동으로 띄워지며 테스트 종료 후 다음 테스트 시 영향을 주지 못하도록 자동으로 정리된다.</p>\n<div class=\"gatsby-highlight\" data-language=\"yml\"><pre class=\"language-yml\"><code class=\"language-yml\"><span class=\"token key atrule\">services</span><span class=\"token punctuation\">:</span>\r\n  <span class=\"token key atrule\">lottery_test_db</span><span class=\"token punctuation\">:</span>\r\n    <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> mariadb<span class=\"token punctuation\">:</span>latest\r\n    <span class=\"token key atrule\">container_name</span><span class=\"token punctuation\">:</span> lottery_test_db\r\n    <span class=\"token key atrule\">environment</span><span class=\"token punctuation\">:</span>\r\n      <span class=\"token key atrule\">MYSQL_ROOT_PASSWORD</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span>DB_PASSWORD<span class=\"token punctuation\">}</span>\r\n      <span class=\"token key atrule\">MYSQL_DATABASE</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span>DB_DATABASE<span class=\"token punctuation\">}</span>\r\n      <span class=\"token key atrule\">MYSQL_PASSWORD</span><span class=\"token punctuation\">:</span> $<span class=\"token punctuation\">{</span>DB_PASSWORD<span class=\"token punctuation\">}</span>\r\n    <span class=\"token key atrule\">ports</span><span class=\"token punctuation\">:</span>\r\n      <span class=\"token punctuation\">-</span> $<span class=\"token punctuation\">{</span>DB_PORT<span class=\"token punctuation\">}</span><span class=\"token punctuation\">:</span><span class=\"token number\">3306</span>\r\n    <span class=\"token key atrule\">command</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>default<span class=\"token punctuation\">-</span>authentication<span class=\"token punctuation\">-</span>plugin=mysql_native_password\r\n\r\n  <span class=\"token key atrule\">lottery_test_redis</span><span class=\"token punctuation\">:</span>\r\n    <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> redis<span class=\"token punctuation\">:</span>latest\r\n    <span class=\"token key atrule\">container_name</span><span class=\"token punctuation\">:</span> lottery_test_redis\r\n    <span class=\"token key atrule\">ports</span><span class=\"token punctuation\">:</span>\r\n      <span class=\"token punctuation\">-</span> $<span class=\"token punctuation\">{</span>REDIS_PORT<span class=\"token punctuation\">}</span><span class=\"token punctuation\">:</span><span class=\"token number\">6379</span></code></pre></div>\n<br>\n<p>위 컨테이너들은 <code class=\"language-text\">packge.json</code>의 <strong>npm run test</strong> 스크립트 명령으로 E2E 테스트 전 먼저 구동되어 테스트 환경을 먼저 구성한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token property\">\"scripts\"</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\r\n  <span class=\"token property\">\"build\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"nest build\"</span><span class=\"token punctuation\">,</span>\r\n  <span class=\"token property\">\"start:dev\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"nest start --watch\"</span><span class=\"token punctuation\">,</span>\r\n  <span class=\"token property\">\"start:prod\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"node dist/main\"</span><span class=\"token punctuation\">,</span>\r\n  <span class=\"token property\">\"test\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"npm run test:docker:start &amp;&amp; npm run test:e2e || (echo '❌ E2E 테스트 실패' &amp;&amp; exit 1)\"</span><span class=\"token punctuation\">,</span>\r\n  <span class=\"token property\">\"test:e2e\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"cross-env API_NODE_ENV=test jest --config jest-e2e.json --forceExit\"</span><span class=\"token punctuation\">,</span>\r\n  <span class=\"token property\">\"test:cov\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"npm run test:docker:start &amp;&amp; jest --config jest-e2e.json --coverage\"</span><span class=\"token punctuation\">,</span>\r\n  <span class=\"token property\">\"test:docker:start\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"docker compose --env-file .env.test -f docker-compose.test.yml up -d\"</span>\r\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span></code></pre></div>\n<br>\r\n<br>\n<h4 id=\"3-2-github-actions-ci-구성\" style=\"position:relative;\"><a href=\"#3-2-github-actions-ci-%EA%B5%AC%EC%84%B1\" aria-label=\"3 2 github actions ci 구성 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3-2. GitHub Actions CI 구성</h4>\n<hr>\n<p>CI 파이프라인은 다음의 순서를 따릅니다.</p>\n<ol>\n<li><code class=\"language-text\">.env.test</code> 파일을 생성</li>\n<li><code class=\"language-text\">docker-compose.test.yml</code>을 통해 DB/Redis 컨테이너 실행</li>\n<li>E2E 테스트 실행</li>\n<li>테스트 성공 시에만 이후 Build &#x26; Deploy 단계 진행</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"yml\"><pre class=\"language-yml\"><code class=\"language-yml\"><span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> CI &amp; CD\r\n\r\n<span class=\"token key atrule\">on</span><span class=\"token punctuation\">:</span>\r\n  <span class=\"token key atrule\">push</span><span class=\"token punctuation\">:</span>\r\n    <span class=\"token key atrule\">branches</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>master<span class=\"token punctuation\">]</span>\r\n\r\n<span class=\"token key atrule\">jobs</span><span class=\"token punctuation\">:</span>\r\n  <span class=\"token key atrule\">test</span><span class=\"token punctuation\">:</span>\r\n    <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> E2E Tests\r\n    <span class=\"token key atrule\">runs-on</span><span class=\"token punctuation\">:</span> ubuntu<span class=\"token punctuation\">-</span>latest\r\n\r\n    <span class=\"token key atrule\">steps</span><span class=\"token punctuation\">:</span>\r\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Checkout repository\r\n        <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> actions/checkout@v4\r\n\r\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Set up Node.js\r\n        <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> actions/setup<span class=\"token punctuation\">-</span>node@v4\r\n        <span class=\"token key atrule\">with</span><span class=\"token punctuation\">:</span>\r\n          <span class=\"token key atrule\">node-version</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'20.11.0'</span>\r\n\r\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Install dependencies\r\n        <span class=\"token key atrule\">working-directory</span><span class=\"token punctuation\">:</span> ./api\r\n        <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> npm install\r\n\r\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Create .env.test\r\n        <span class=\"token key atrule\">working-directory</span><span class=\"token punctuation\">:</span> ./api\r\n        <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">|</span><span class=\"token scalar string\">\r\n          [ -f ./.env.test ] &amp;&amp; rm ./.env.test\r\n          cat &lt;&lt;EOF > .env.test\r\n          DB_HOST=${{ secrets.TEST_DB_HOST }}\r\n          DB_PORT=${{ secrets.TEST_DB_PORT }}\r\n          DB_USER=${{ secrets.TEST_DB_USER }}\r\n          DB_PASSWORD=${{ secrets.TEST_DB_PASSWORD }}\r\n          DB_DATABASE=${{ secrets.TEST_DB_DATABASE }}\r\n          API_SERVER_PORT=${{ secrets.API_SERVER_PORT }}\r\n          ... (생략)\r\n          EOF</span>\r\n\r\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Start docker<span class=\"token punctuation\">-</span>compose.test.yml (DB + Redis)\r\n        <span class=\"token key atrule\">working-directory</span><span class=\"token punctuation\">:</span> ./api\r\n        <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> docker compose <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>env<span class=\"token punctuation\">-</span>file .env.test <span class=\"token punctuation\">-</span>f docker<span class=\"token punctuation\">-</span>compose.test.yml up <span class=\"token punctuation\">-</span>d\r\n\r\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Run Tests\r\n        <span class=\"token key atrule\">working-directory</span><span class=\"token punctuation\">:</span> ./api\r\n        <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> npm run test\r\n\r\n  <span class=\"token key atrule\">build</span><span class=\"token punctuation\">:</span>\r\n    <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Build Docker Images\r\n    <span class=\"token key atrule\">needs</span><span class=\"token punctuation\">:</span> test\r\n    <span class=\"token key atrule\">runs-on</span><span class=\"token punctuation\">:</span> ubuntu<span class=\"token punctuation\">-</span>latest\r\n\r\n    <span class=\"token punctuation\">...</span> (후략)</code></pre></div>\n<br>\r\n<br>\n<p>E2E 테스트가 실패하면 이후 Build 또는 Deploy는 실행되지 못한다. 이를 통해 CI 파이프라인에서 <strong>“코드 품질이 보장된 경우에만 배포”</strong>가 이루어지도록 제어했다.</p>\n<br>\r\n<br>\n<h3 id=\"4-테스트-자동화가-가져온-안정성\" style=\"position:relative;\"><a href=\"#4-%ED%85%8C%EC%8A%A4%ED%8A%B8-%EC%9E%90%EB%8F%99%ED%99%94%EA%B0%80-%EA%B0%80%EC%A0%B8%EC%98%A8-%EC%95%88%EC%A0%95%EC%84%B1\" aria-label=\"4 테스트 자동화가 가져온 안정성 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>4. 테스트 자동화가 가져온 안정성</h3>\n<hr>\n<p>테스트 자동화를 구축하기 전에는 코드가 머지되고 배포되어도 “배포는 잘 됐는데 동작이 안 되면 어쩌지?” 같은 걱정은 해소되지 못하였다. <del>(사실 이 감정은 아직 여전히 느끼고 있다. 🥲)</del> 하지만, CI/CD 파이프라인 안에 E2E 테스트를 녹여낸 이후로는 단순한 배포 성공을 넘어 실제 서비스의 핵심 흐름이 정상 동작하는지까지 사전에 검증할 수 있게 되어 이 불안감은 조금 줄어들지 않았나 싶다.</p>\n<br>\n<img src=\"https://jh8459.s3.ap-northeast-2.amazonaws.com/blog/2025-04-29-PROJECT/action.png\">\n<center>그래도 불안감은 <del>조금</del> 해소되었다. 💦</center>\r\n<br><br>\n<p>그 외에도 E2E 테스트는 <strong>“어떤 시나리오가 정상 흐름인지”</strong> 코드로 남긴다는 점에서 테스트 코드 자체가 문서 역할을 하게되었다. 이 덕분에 인수인계 혹은 비즈니스 요구사항을 수정할때 커뮤니케이션도 더 명확해졌다.</p>\n<p>특히, 테스트를 염두에 두고 코드를 작성하다 보니 자연스럽게 코딩 스타일과 사고 방식에도 변화가 생겼다.</p>\n<ul>\n<li>클래스 별로 책임을 명확히 나누려 노력한다.</li>\n<li>기능이 많아지면 함수를 쪼개기 위해 노력한다.</li>\n<li><strong>“이건 테스트하기 어렵겠는데?”</strong>라는 감각(?)이 생겼다.</li>\n</ul>\n<br>\n<p>가장 큰 변화로는 코드를 작성하다 보면 이제 자연스럽게 “이렇게 만들면 테스트가 힘들겠는데? 🤔“라는 생각이 먼저 들곤 한다. 테스트가 어려운 구조를 보면 즉시 의심하고 좀 더 테스트가 용이한 형태로 바로 리팩토링하려고 노력하게 되었다.</p>\n<br>\r\n<br>\n<h2 id=\"-understanding\" style=\"position:relative;\"><a href=\"#-understanding\" aria-label=\" understanding permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>🤔 Understanding</h2>\n<p>코드나 서비스의 품질 테스트는 다양한 접근 방식으로 많이 할수록 좋다 생각한다. <del>“E2E 테스트가 유일한 정답이다..!” 취지로 이번 포스팅을 작성한게 아니다..🙏</del></p>\n<p>다만, 주어진 시간안에서 서비스의 품질을 효율적으로 책임지기 위해 고안해낸 주관적인 의견이므로 이 방법이 유일한 정답이다라고 말하고 싶지 않다. 팀의 구성원이 적고 요구사항이 빠르게 변하기 때문에 전체적인 E2E 테스트 위주로 품질을 검증하는 방법을 택하였을 뿐이다.</p>\n<p>테스트 코드들을 작성해나가며 느낀바로는, 어떤 테스트 전략이던지 테스트는 번거롭고 시간이 오래 걸리는게 아닌 품질을 보증하는 가장 빠른 길이라는 것이다.</p>\n<p>미리 실패하고 미리 위험 요인들을 발견하는 것이 가장 중요하다 생각한다.</p>\n<br>\r\n<br>\n<div class=\"gatsby-highlight\" data-language=\"toc\"><pre class=\"language-toc\"><code class=\"language-toc\"></code></pre></div>","frontmatter":{"date":"2025.04.29","title":"E2E 테스트 설계와 테스트 자동화","categories":"Project","author":"JH8459","emoji":"🔥"},"fields":{"slug":"/2025-04-29-PROJECT/"}},"site":{"siteMetadata":{"siteUrl":"https://blog.jh8459.com","comments":{"utterances":{"repo":"JH8459/JH8459.github.io"}}}}},"pageContext":{"slug":"/2025-04-10-TIL/","nextSlug":"/2025-03-31-PROJECT/","prevSlug":"/2025-04-29-PROJECT/"}},"staticQueryHashes":["1073350324","1956554647","2938748437"],"slicesMap":{}}